(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const sn={version:"0.3.7"};async function Sn(e){try{return[null,await e()]}catch(t){return[t,null]}}function _(e,t,n){function r(a,c){if(a._zod||Object.defineProperty(a,"_zod",{value:{def:c,constr:i,traits:new Set},enumerable:!1}),a._zod.traits.has(e))return;a._zod.traits.add(e),t(a,c);const u=i.prototype,l=Object.keys(u);for(let d=0;d<l.length;d++){const f=l[d];f in a||(a[f]=u[f].bind(a))}}const o=n?.Parent??Object;class s extends o{}Object.defineProperty(s,"name",{value:e});function i(a){var c;const u=n?.Parent?new s:this;r(u,a),(c=u._zod).deferred??(c.deferred=[]);for(const l of u._zod.deferred)l();return u}return Object.defineProperty(i,"init",{value:r}),Object.defineProperty(i,Symbol.hasInstance,{value:a=>n?.Parent&&a instanceof n.Parent?!0:a?._zod?.traits?.has(e)}),Object.defineProperty(i,"name",{value:e}),i}class Je extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}class wo extends Error{constructor(t){super(`Encountered unidirectional transform during encode: ${t}`),this.name="ZodEncodeError"}}const bo={};function Se(e){return bo}function Io(e){const t=Object.values(e).filter(r=>typeof r=="number");return Object.entries(e).filter(([r,o])=>t.indexOf(+r)===-1).map(([r,o])=>o)}function an(e,t){return typeof t=="bigint"?t.toString():t}function zt(e){return{get value(){{const t=e();return Object.defineProperty(this,"value",{value:t}),t}}}}function Tn(e){return e==null}function An(e){const t=e.startsWith("^")?1:0,n=e.endsWith("$")?e.length-1:e.length;return e.slice(t,n)}function ki(e,t){const n=(e.toString().split(".")[1]||"").length,r=t.toString();let o=(r.split(".")[1]||"").length;if(o===0&&/\d?e-\d?/.test(r)){const c=r.match(/\d?e-(\d?)/);c?.[1]&&(o=Number.parseInt(c[1]))}const s=n>o?n:o,i=Number.parseInt(e.toFixed(s).replace(".","")),a=Number.parseInt(t.toFixed(s).replace(".",""));return i%a/10**s}const Yn=Symbol("evaluating");function $(e,t,n){let r;Object.defineProperty(e,t,{get(){if(r!==Yn)return r===void 0&&(r=Yn,r=n()),r},set(o){Object.defineProperty(e,t,{value:o})},configurable:!0})}function Re(e,t,n){Object.defineProperty(e,t,{value:n,writable:!0,enumerable:!0,configurable:!0})}function Ze(...e){const t={};for(const n of e){const r=Object.getOwnPropertyDescriptors(n);Object.assign(t,r)}return Object.defineProperties({},t)}function Xn(e){return JSON.stringify(e)}function xi(e){return e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}const So="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function tt(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}const Ei=zt(()=>{if(typeof navigator<"u"&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{const e=Function;return new e(""),!0}catch{return!1}});function Be(e){if(tt(e)===!1)return!1;const t=e.constructor;if(t===void 0||typeof t!="function")return!0;const n=t.prototype;return!(tt(n)===!1||Object.prototype.hasOwnProperty.call(n,"isPrototypeOf")===!1)}function To(e){return Be(e)?{...e}:Array.isArray(e)?[...e]:e}const Oi=new Set(["string","number","symbol"]);function Ge(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ke(e,t,n){const r=new e._zod.constr(t??e._zod.def);return(!t||n?.parent)&&(r._zod.parent=e),r}function E(e){const t=e;if(!t)return{};if(typeof t=="string")return{error:()=>t};if(t?.message!==void 0){if(t?.error!==void 0)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,typeof t.error=="string"?{...t,error:()=>t.error}:t}function Ci(e){return Object.keys(e).filter(t=>e[t]._zod.optin==="optional"&&e[t]._zod.optout==="optional")}const Pi={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function Ni(e,t){const n=e._zod.def,r=Ze(e._zod.def,{get shape(){const o={};for(const s in t){if(!(s in n.shape))throw new Error(`Unrecognized key: "${s}"`);t[s]&&(o[s]=n.shape[s])}return Re(this,"shape",o),o},checks:[]});return ke(e,r)}function zi(e,t){const n=e._zod.def,r=Ze(e._zod.def,{get shape(){const o={...e._zod.def.shape};for(const s in t){if(!(s in n.shape))throw new Error(`Unrecognized key: "${s}"`);t[s]&&delete o[s]}return Re(this,"shape",o),o},checks:[]});return ke(e,r)}function Di(e,t){if(!Be(t))throw new Error("Invalid input to extend: expected a plain object");const n=e._zod.def.checks;if(n&&n.length>0)throw new Error("Object schemas containing refinements cannot be extended. Use `.safeExtend()` instead.");const o=Ze(e._zod.def,{get shape(){const s={...e._zod.def.shape,...t};return Re(this,"shape",s),s},checks:[]});return ke(e,o)}function $i(e,t){if(!Be(t))throw new Error("Invalid input to safeExtend: expected a plain object");const n={...e._zod.def,get shape(){const r={...e._zod.def.shape,...t};return Re(this,"shape",r),r},checks:e._zod.def.checks};return ke(e,n)}function Ri(e,t){const n=Ze(e._zod.def,{get shape(){const r={...e._zod.def.shape,...t._zod.def.shape};return Re(this,"shape",r),r},get catchall(){return t._zod.def.catchall},checks:[]});return ke(e,n)}function Zi(e,t,n){const r=Ze(t._zod.def,{get shape(){const o=t._zod.def.shape,s={...o};if(n)for(const i in n){if(!(i in o))throw new Error(`Unrecognized key: "${i}"`);n[i]&&(s[i]=e?new e({type:"optional",innerType:o[i]}):o[i])}else for(const i in o)s[i]=e?new e({type:"optional",innerType:o[i]}):o[i];return Re(this,"shape",s),s},checks:[]});return ke(t,r)}function Mi(e,t,n){const r=Ze(t._zod.def,{get shape(){const o=t._zod.def.shape,s={...o};if(n)for(const i in n){if(!(i in s))throw new Error(`Unrecognized key: "${i}"`);n[i]&&(s[i]=new e({type:"nonoptional",innerType:o[i]}))}else for(const i in o)s[i]=new e({type:"nonoptional",innerType:o[i]});return Re(this,"shape",s),s},checks:[]});return ke(t,r)}function je(e,t=0){if(e.aborted===!0)return!0;for(let n=t;n<e.issues.length;n++)if(e.issues[n]?.continue!==!0)return!0;return!1}function Fe(e,t){return t.map(n=>{var r;return(r=n).path??(r.path=[]),n.path.unshift(e),n})}function dt(e){return typeof e=="string"?e:e?.message}function Te(e,t,n){const r={...e,path:e.path??[]};if(!e.message){const o=dt(e.inst?._zod.def?.error?.(e))??dt(t?.error?.(e))??dt(n.customError?.(e))??dt(n.localeError?.(e))??"Invalid input";r.message=o}return delete r.inst,delete r.continue,t?.reportInput||delete r.input,r}function kn(e){return Array.isArray(e)?"array":typeof e=="string"?"string":"unknown"}function nt(...e){const[t,n,r]=e;return typeof t=="string"?{message:t,code:"custom",input:n,inst:r}:{...t}}const Ao=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),e.message=JSON.stringify(t,an,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},ko=_("$ZodError",Ao),xo=_("$ZodError",Ao,{Parent:Error});function ji(e,t=n=>n.message){const n={},r=[];for(const o of e.issues)o.path.length>0?(n[o.path[0]]=n[o.path[0]]||[],n[o.path[0]].push(t(o))):r.push(t(o));return{formErrors:r,fieldErrors:n}}function Fi(e,t=n=>n.message){const n={_errors:[]},r=o=>{for(const s of o.issues)if(s.code==="invalid_union"&&s.errors.length)s.errors.map(i=>r({issues:i}));else if(s.code==="invalid_key")r({issues:s.issues});else if(s.code==="invalid_element")r({issues:s.issues});else if(s.path.length===0)n._errors.push(t(s));else{let i=n,a=0;for(;a<s.path.length;){const c=s.path[a];a===s.path.length-1?(i[c]=i[c]||{_errors:[]},i[c]._errors.push(t(s))):i[c]=i[c]||{_errors:[]},i=i[c],a++}}};return r(e),n}const xn=e=>(t,n,r,o)=>{const s=r?Object.assign(r,{async:!1}):{async:!1},i=t._zod.run({value:n,issues:[]},s);if(i instanceof Promise)throw new Je;if(i.issues.length){const a=new(o?.Err??e)(i.issues.map(c=>Te(c,s,Se())));throw So(a,o?.callee),a}return i.value},En=e=>async(t,n,r,o)=>{const s=r?Object.assign(r,{async:!0}):{async:!0};let i=t._zod.run({value:n,issues:[]},s);if(i instanceof Promise&&(i=await i),i.issues.length){const a=new(o?.Err??e)(i.issues.map(c=>Te(c,s,Se())));throw So(a,o?.callee),a}return i.value},Dt=e=>(t,n,r)=>{const o=r?{...r,async:!1}:{async:!1},s=t._zod.run({value:n,issues:[]},o);if(s instanceof Promise)throw new Je;return s.issues.length?{success:!1,error:new(e??ko)(s.issues.map(i=>Te(i,o,Se())))}:{success:!0,data:s.value}},Li=Dt(xo),$t=e=>async(t,n,r)=>{const o=r?Object.assign(r,{async:!0}):{async:!0};let s=t._zod.run({value:n,issues:[]},o);return s instanceof Promise&&(s=await s),s.issues.length?{success:!1,error:new e(s.issues.map(i=>Te(i,o,Se())))}:{success:!0,data:s.value}},Ui=$t(xo),Ji=e=>(t,n,r)=>{const o=r?Object.assign(r,{direction:"backward"}):{direction:"backward"};return xn(e)(t,n,o)},qi=e=>(t,n,r)=>xn(e)(t,n,r),Bi=e=>async(t,n,r)=>{const o=r?Object.assign(r,{direction:"backward"}):{direction:"backward"};return En(e)(t,n,o)},Gi=e=>async(t,n,r)=>En(e)(t,n,r),Wi=e=>(t,n,r)=>{const o=r?Object.assign(r,{direction:"backward"}):{direction:"backward"};return Dt(e)(t,n,o)},Vi=e=>(t,n,r)=>Dt(e)(t,n,r),Hi=e=>async(t,n,r)=>{const o=r?Object.assign(r,{direction:"backward"}):{direction:"backward"};return $t(e)(t,n,o)},Ki=e=>async(t,n,r)=>$t(e)(t,n,r),Yi=/^[cC][^\s-]{8,}$/,Xi=/^[0-9a-z]+$/,Qi=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,ea=/^[0-9a-vA-V]{20}$/,ta=/^[A-Za-z0-9]{27}$/,na=/^[a-zA-Z0-9_-]{21}$/,ra=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,oa=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Qn=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/,sa=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,ia="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";function aa(){return new RegExp(ia,"u")}const ua=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ca=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:))$/,la=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,pa=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,da=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,Eo=/^[A-Za-z0-9_-]*$/,fa=/^\+(?:[0-9]){6,14}[0-9]$/,Oo="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",ma=new RegExp(`^${Oo}$`);function Co(e){const t="(?:[01]\\d|2[0-3]):[0-5]\\d";return typeof e.precision=="number"?e.precision===-1?`${t}`:e.precision===0?`${t}:[0-5]\\d`:`${t}:[0-5]\\d\\.\\d{${e.precision}}`:`${t}(?::[0-5]\\d(?:\\.\\d+)?)?`}function ha(e){return new RegExp(`^${Co(e)}$`)}function ga(e){const t=Co({precision:e.precision}),n=["Z"];e.local&&n.push(""),e.offset&&n.push("([+-](?:[01]\\d|2[0-3]):[0-5]\\d)");const r=`${t}(?:${n.join("|")})`;return new RegExp(`^${Oo}T(?:${r})$`)}const _a=e=>{const t=e?`[\\s\\S]{${e?.minimum??0},${e?.maximum??""}}`:"[\\s\\S]*";return new RegExp(`^${t}$`)},ya=/^-?\d+$/,va=/^-?\d+(?:\.\d+)?/,wa=/^(?:true|false)$/i,ba=/^[^A-Z]*$/,Ia=/^[^a-z]*$/,Q=_("$ZodCheck",(e,t)=>{var n;e._zod??(e._zod={}),e._zod.def=t,(n=e._zod).onattach??(n.onattach=[])}),Po={number:"number",bigint:"bigint",object:"date"},No=_("$ZodCheckLessThan",(e,t)=>{Q.init(e,t);const n=Po[typeof t.value];e._zod.onattach.push(r=>{const o=r._zod.bag,s=(t.inclusive?o.maximum:o.exclusiveMaximum)??Number.POSITIVE_INFINITY;t.value<s&&(t.inclusive?o.maximum=t.value:o.exclusiveMaximum=t.value)}),e._zod.check=r=>{(t.inclusive?r.value<=t.value:r.value<t.value)||r.issues.push({origin:n,code:"too_big",maximum:t.value,input:r.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),zo=_("$ZodCheckGreaterThan",(e,t)=>{Q.init(e,t);const n=Po[typeof t.value];e._zod.onattach.push(r=>{const o=r._zod.bag,s=(t.inclusive?o.minimum:o.exclusiveMinimum)??Number.NEGATIVE_INFINITY;t.value>s&&(t.inclusive?o.minimum=t.value:o.exclusiveMinimum=t.value)}),e._zod.check=r=>{(t.inclusive?r.value>=t.value:r.value>t.value)||r.issues.push({origin:n,code:"too_small",minimum:t.value,input:r.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),Sa=_("$ZodCheckMultipleOf",(e,t)=>{Q.init(e,t),e._zod.onattach.push(n=>{var r;(r=n._zod.bag).multipleOf??(r.multipleOf=t.value)}),e._zod.check=n=>{if(typeof n.value!=typeof t.value)throw new Error("Cannot mix number and bigint in multiple_of check.");(typeof n.value=="bigint"?n.value%t.value===BigInt(0):ki(n.value,t.value)===0)||n.issues.push({origin:typeof n.value,code:"not_multiple_of",divisor:t.value,input:n.value,inst:e,continue:!t.abort})}}),Ta=_("$ZodCheckNumberFormat",(e,t)=>{Q.init(e,t),t.format=t.format||"float64";const n=t.format?.includes("int"),r=n?"int":"number",[o,s]=Pi[t.format];e._zod.onattach.push(i=>{const a=i._zod.bag;a.format=t.format,a.minimum=o,a.maximum=s,n&&(a.pattern=ya)}),e._zod.check=i=>{const a=i.value;if(n){if(!Number.isInteger(a)){i.issues.push({expected:r,format:t.format,code:"invalid_type",continue:!1,input:a,inst:e});return}if(!Number.isSafeInteger(a)){a>0?i.issues.push({input:a,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:r,continue:!t.abort}):i.issues.push({input:a,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:r,continue:!t.abort});return}}a<o&&i.issues.push({origin:"number",input:a,code:"too_small",minimum:o,inclusive:!0,inst:e,continue:!t.abort}),a>s&&i.issues.push({origin:"number",input:a,code:"too_big",maximum:s,inst:e})}}),Aa=_("$ZodCheckMaxLength",(e,t)=>{var n;Q.init(e,t),(n=e._zod.def).when??(n.when=r=>{const o=r.value;return!Tn(o)&&o.length!==void 0}),e._zod.onattach.push(r=>{const o=r._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<o&&(r._zod.bag.maximum=t.maximum)}),e._zod.check=r=>{const o=r.value;if(o.length<=t.maximum)return;const i=kn(o);r.issues.push({origin:i,code:"too_big",maximum:t.maximum,inclusive:!0,input:o,inst:e,continue:!t.abort})}}),ka=_("$ZodCheckMinLength",(e,t)=>{var n;Q.init(e,t),(n=e._zod.def).when??(n.when=r=>{const o=r.value;return!Tn(o)&&o.length!==void 0}),e._zod.onattach.push(r=>{const o=r._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>o&&(r._zod.bag.minimum=t.minimum)}),e._zod.check=r=>{const o=r.value;if(o.length>=t.minimum)return;const i=kn(o);r.issues.push({origin:i,code:"too_small",minimum:t.minimum,inclusive:!0,input:o,inst:e,continue:!t.abort})}}),xa=_("$ZodCheckLengthEquals",(e,t)=>{var n;Q.init(e,t),(n=e._zod.def).when??(n.when=r=>{const o=r.value;return!Tn(o)&&o.length!==void 0}),e._zod.onattach.push(r=>{const o=r._zod.bag;o.minimum=t.length,o.maximum=t.length,o.length=t.length}),e._zod.check=r=>{const o=r.value,s=o.length;if(s===t.length)return;const i=kn(o),a=s>t.length;r.issues.push({origin:i,...a?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:r.value,inst:e,continue:!t.abort})}}),Rt=_("$ZodCheckStringFormat",(e,t)=>{var n,r;Q.init(e,t),e._zod.onattach.push(o=>{const s=o._zod.bag;s.format=t.format,t.pattern&&(s.patterns??(s.patterns=new Set),s.patterns.add(t.pattern))}),t.pattern?(n=e._zod).check??(n.check=o=>{t.pattern.lastIndex=0,!t.pattern.test(o.value)&&o.issues.push({origin:"string",code:"invalid_format",format:t.format,input:o.value,...t.pattern?{pattern:t.pattern.toString()}:{},inst:e,continue:!t.abort})}):(r=e._zod).check??(r.check=()=>{})}),Ea=_("$ZodCheckRegex",(e,t)=>{Rt.init(e,t),e._zod.check=n=>{t.pattern.lastIndex=0,!t.pattern.test(n.value)&&n.issues.push({origin:"string",code:"invalid_format",format:"regex",input:n.value,pattern:t.pattern.toString(),inst:e,continue:!t.abort})}}),Oa=_("$ZodCheckLowerCase",(e,t)=>{t.pattern??(t.pattern=ba),Rt.init(e,t)}),Ca=_("$ZodCheckUpperCase",(e,t)=>{t.pattern??(t.pattern=Ia),Rt.init(e,t)}),Pa=_("$ZodCheckIncludes",(e,t)=>{Q.init(e,t);const n=Ge(t.includes),r=new RegExp(typeof t.position=="number"?`^.{${t.position}}${n}`:n);t.pattern=r,e._zod.onattach.push(o=>{const s=o._zod.bag;s.patterns??(s.patterns=new Set),s.patterns.add(r)}),e._zod.check=o=>{o.value.includes(t.includes,t.position)||o.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:t.includes,input:o.value,inst:e,continue:!t.abort})}}),Na=_("$ZodCheckStartsWith",(e,t)=>{Q.init(e,t);const n=new RegExp(`^${Ge(t.prefix)}.*`);t.pattern??(t.pattern=n),e._zod.onattach.push(r=>{const o=r._zod.bag;o.patterns??(o.patterns=new Set),o.patterns.add(n)}),e._zod.check=r=>{r.value.startsWith(t.prefix)||r.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:t.prefix,input:r.value,inst:e,continue:!t.abort})}}),za=_("$ZodCheckEndsWith",(e,t)=>{Q.init(e,t);const n=new RegExp(`.*${Ge(t.suffix)}$`);t.pattern??(t.pattern=n),e._zod.onattach.push(r=>{const o=r._zod.bag;o.patterns??(o.patterns=new Set),o.patterns.add(n)}),e._zod.check=r=>{r.value.endsWith(t.suffix)||r.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:t.suffix,input:r.value,inst:e,continue:!t.abort})}}),Da=_("$ZodCheckOverwrite",(e,t)=>{Q.init(e,t),e._zod.check=n=>{n.value=t.tx(n.value)}});class $a{constructor(t=[]){this.content=[],this.indent=0,this&&(this.args=t)}indented(t){this.indent+=1,t(this),this.indent-=1}write(t){if(typeof t=="function"){t(this,{execution:"sync"}),t(this,{execution:"async"});return}const r=t.split(`
`).filter(i=>i),o=Math.min(...r.map(i=>i.length-i.trimStart().length)),s=r.map(i=>i.slice(o)).map(i=>" ".repeat(this.indent*2)+i);for(const i of s)this.content.push(i)}compile(){const t=Function,n=this?.args,o=[...(this?.content??[""]).map(s=>`  ${s}`)];return new t(...n,o.join(`
`))}}const Ra={major:4,minor:2,patch:1},L=_("$ZodType",(e,t)=>{var n;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=Ra;const r=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&r.unshift(e);for(const o of r)for(const s of o._zod.onattach)s(e);if(r.length===0)(n=e._zod).deferred??(n.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const o=(i,a,c)=>{let u=je(i),l;for(const d of a){if(d._zod.def.when){if(!d._zod.def.when(i))continue}else if(u)continue;const f=i.issues.length,m=d._zod.check(i);if(m instanceof Promise&&c?.async===!1)throw new Je;if(l||m instanceof Promise)l=(l??Promise.resolve()).then(async()=>{await m,i.issues.length!==f&&(u||(u=je(i,f)))});else{if(i.issues.length===f)continue;u||(u=je(i,f))}}return l?l.then(()=>i):i},s=(i,a,c)=>{if(je(i))return i.aborted=!0,i;const u=o(a,r,c);if(u instanceof Promise){if(c.async===!1)throw new Je;return u.then(l=>e._zod.parse(l,c))}return e._zod.parse(u,c)};e._zod.run=(i,a)=>{if(a.skipChecks)return e._zod.parse(i,a);if(a.direction==="backward"){const u=e._zod.parse({value:i.value,issues:[]},{...a,skipChecks:!0});return u instanceof Promise?u.then(l=>s(l,i,a)):s(u,i,a)}const c=e._zod.parse(i,a);if(c instanceof Promise){if(a.async===!1)throw new Je;return c.then(u=>o(u,r,a))}return o(c,r,a)}}e["~standard"]={validate:o=>{try{const s=Li(e,o);return s.success?{value:s.data}:{issues:s.error?.issues}}catch{return Ui(e,o).then(i=>i.success?{value:i.data}:{issues:i.error?.issues})}},vendor:"zod",version:1}}),On=_("$ZodString",(e,t)=>{L.init(e,t),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??_a(e._zod.bag),e._zod.parse=(n,r)=>{if(t.coerce)try{n.value=String(n.value)}catch{}return typeof n.value=="string"||n.issues.push({expected:"string",code:"invalid_type",input:n.value,inst:e}),n}}),U=_("$ZodStringFormat",(e,t)=>{Rt.init(e,t),On.init(e,t)}),Za=_("$ZodGUID",(e,t)=>{t.pattern??(t.pattern=oa),U.init(e,t)}),Ma=_("$ZodUUID",(e,t)=>{if(t.version){const r={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[t.version];if(r===void 0)throw new Error(`Invalid UUID version: "${t.version}"`);t.pattern??(t.pattern=Qn(r))}else t.pattern??(t.pattern=Qn());U.init(e,t)}),ja=_("$ZodEmail",(e,t)=>{t.pattern??(t.pattern=sa),U.init(e,t)}),Fa=_("$ZodURL",(e,t)=>{U.init(e,t),e._zod.check=n=>{try{const r=n.value.trim(),o=new URL(r);t.hostname&&(t.hostname.lastIndex=0,t.hostname.test(o.hostname)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:t.hostname.source,input:n.value,inst:e,continue:!t.abort})),t.protocol&&(t.protocol.lastIndex=0,t.protocol.test(o.protocol.endsWith(":")?o.protocol.slice(0,-1):o.protocol)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:t.protocol.source,input:n.value,inst:e,continue:!t.abort})),t.normalize?n.value=o.href:n.value=r;return}catch{n.issues.push({code:"invalid_format",format:"url",input:n.value,inst:e,continue:!t.abort})}}}),La=_("$ZodEmoji",(e,t)=>{t.pattern??(t.pattern=aa()),U.init(e,t)}),Ua=_("$ZodNanoID",(e,t)=>{t.pattern??(t.pattern=na),U.init(e,t)}),Ja=_("$ZodCUID",(e,t)=>{t.pattern??(t.pattern=Yi),U.init(e,t)}),qa=_("$ZodCUID2",(e,t)=>{t.pattern??(t.pattern=Xi),U.init(e,t)}),Ba=_("$ZodULID",(e,t)=>{t.pattern??(t.pattern=Qi),U.init(e,t)}),Ga=_("$ZodXID",(e,t)=>{t.pattern??(t.pattern=ea),U.init(e,t)}),Wa=_("$ZodKSUID",(e,t)=>{t.pattern??(t.pattern=ta),U.init(e,t)}),Va=_("$ZodISODateTime",(e,t)=>{t.pattern??(t.pattern=ga(t)),U.init(e,t)}),Ha=_("$ZodISODate",(e,t)=>{t.pattern??(t.pattern=ma),U.init(e,t)}),Ka=_("$ZodISOTime",(e,t)=>{t.pattern??(t.pattern=ha(t)),U.init(e,t)}),Ya=_("$ZodISODuration",(e,t)=>{t.pattern??(t.pattern=ra),U.init(e,t)}),Xa=_("$ZodIPv4",(e,t)=>{t.pattern??(t.pattern=ua),U.init(e,t),e._zod.bag.format="ipv4"}),Qa=_("$ZodIPv6",(e,t)=>{t.pattern??(t.pattern=ca),U.init(e,t),e._zod.bag.format="ipv6",e._zod.check=n=>{try{new URL(`http://[${n.value}]`)}catch{n.issues.push({code:"invalid_format",format:"ipv6",input:n.value,inst:e,continue:!t.abort})}}}),eu=_("$ZodCIDRv4",(e,t)=>{t.pattern??(t.pattern=la),U.init(e,t)}),tu=_("$ZodCIDRv6",(e,t)=>{t.pattern??(t.pattern=pa),U.init(e,t),e._zod.check=n=>{const r=n.value.split("/");try{if(r.length!==2)throw new Error;const[o,s]=r;if(!s)throw new Error;const i=Number(s);if(`${i}`!==s)throw new Error;if(i<0||i>128)throw new Error;new URL(`http://[${o}]`)}catch{n.issues.push({code:"invalid_format",format:"cidrv6",input:n.value,inst:e,continue:!t.abort})}}});function Do(e){if(e==="")return!0;if(e.length%4!==0)return!1;try{return atob(e),!0}catch{return!1}}const nu=_("$ZodBase64",(e,t)=>{t.pattern??(t.pattern=da),U.init(e,t),e._zod.bag.contentEncoding="base64",e._zod.check=n=>{Do(n.value)||n.issues.push({code:"invalid_format",format:"base64",input:n.value,inst:e,continue:!t.abort})}});function ru(e){if(!Eo.test(e))return!1;const t=e.replace(/[-_]/g,r=>r==="-"?"+":"/"),n=t.padEnd(Math.ceil(t.length/4)*4,"=");return Do(n)}const ou=_("$ZodBase64URL",(e,t)=>{t.pattern??(t.pattern=Eo),U.init(e,t),e._zod.bag.contentEncoding="base64url",e._zod.check=n=>{ru(n.value)||n.issues.push({code:"invalid_format",format:"base64url",input:n.value,inst:e,continue:!t.abort})}}),su=_("$ZodE164",(e,t)=>{t.pattern??(t.pattern=fa),U.init(e,t)});function iu(e,t=null){try{const n=e.split(".");if(n.length!==3)return!1;const[r]=n;if(!r)return!1;const o=JSON.parse(atob(r));return!("typ"in o&&o?.typ!=="JWT"||!o.alg||t&&(!("alg"in o)||o.alg!==t))}catch{return!1}}const au=_("$ZodJWT",(e,t)=>{U.init(e,t),e._zod.check=n=>{iu(n.value,t.alg)||n.issues.push({code:"invalid_format",format:"jwt",input:n.value,inst:e,continue:!t.abort})}}),$o=_("$ZodNumber",(e,t)=>{L.init(e,t),e._zod.pattern=e._zod.bag.pattern??va,e._zod.parse=(n,r)=>{if(t.coerce)try{n.value=Number(n.value)}catch{}const o=n.value;if(typeof o=="number"&&!Number.isNaN(o)&&Number.isFinite(o))return n;const s=typeof o=="number"?Number.isNaN(o)?"NaN":Number.isFinite(o)?void 0:"Infinity":void 0;return n.issues.push({expected:"number",code:"invalid_type",input:o,inst:e,...s?{received:s}:{}}),n}}),uu=_("$ZodNumberFormat",(e,t)=>{Ta.init(e,t),$o.init(e,t)}),cu=_("$ZodBoolean",(e,t)=>{L.init(e,t),e._zod.pattern=wa,e._zod.parse=(n,r)=>{if(t.coerce)try{n.value=!!n.value}catch{}const o=n.value;return typeof o=="boolean"||n.issues.push({expected:"boolean",code:"invalid_type",input:o,inst:e}),n}}),lu=_("$ZodAny",(e,t)=>{L.init(e,t),e._zod.parse=n=>n}),pu=_("$ZodUnknown",(e,t)=>{L.init(e,t),e._zod.parse=n=>n}),du=_("$ZodNever",(e,t)=>{L.init(e,t),e._zod.parse=(n,r)=>(n.issues.push({expected:"never",code:"invalid_type",input:n.value,inst:e}),n)});function er(e,t,n){e.issues.length&&t.issues.push(...Fe(n,e.issues)),t.value[n]=e.value}const fu=_("$ZodArray",(e,t)=>{L.init(e,t),e._zod.parse=(n,r)=>{const o=n.value;if(!Array.isArray(o))return n.issues.push({expected:"array",code:"invalid_type",input:o,inst:e}),n;n.value=Array(o.length);const s=[];for(let i=0;i<o.length;i++){const a=o[i],c=t.element._zod.run({value:a,issues:[]},r);c instanceof Promise?s.push(c.then(u=>er(u,n,i))):er(c,n,i)}return s.length?Promise.all(s).then(()=>n):n}});function wt(e,t,n,r){e.issues.length&&t.issues.push(...Fe(n,e.issues)),e.value===void 0?n in r&&(t.value[n]=void 0):t.value[n]=e.value}function Ro(e){const t=Object.keys(e.shape);for(const r of t)if(!e.shape?.[r]?._zod?.traits?.has("$ZodType"))throw new Error(`Invalid element at key "${r}": expected a Zod schema`);const n=Ci(e.shape);return{...e,keys:t,keySet:new Set(t),numKeys:t.length,optionalKeys:new Set(n)}}function Zo(e,t,n,r,o,s){const i=[],a=o.keySet,c=o.catchall._zod,u=c.def.type;for(const l in t){if(a.has(l))continue;if(u==="never"){i.push(l);continue}const d=c.run({value:t[l],issues:[]},r);d instanceof Promise?e.push(d.then(f=>wt(f,n,l,t))):wt(d,n,l,t)}return i.length&&n.issues.push({code:"unrecognized_keys",keys:i,input:t,inst:s}),e.length?Promise.all(e).then(()=>n):n}const mu=_("$ZodObject",(e,t)=>{if(L.init(e,t),!Object.getOwnPropertyDescriptor(t,"shape")?.get){const a=t.shape;Object.defineProperty(t,"shape",{get:()=>{const c={...a};return Object.defineProperty(t,"shape",{value:c}),c}})}const r=zt(()=>Ro(t));$(e._zod,"propValues",()=>{const a=t.shape,c={};for(const u in a){const l=a[u]._zod;if(l.values){c[u]??(c[u]=new Set);for(const d of l.values)c[u].add(d)}}return c});const o=tt,s=t.catchall;let i;e._zod.parse=(a,c)=>{i??(i=r.value);const u=a.value;if(!o(u))return a.issues.push({expected:"object",code:"invalid_type",input:u,inst:e}),a;a.value={};const l=[],d=i.shape;for(const f of i.keys){const w=d[f]._zod.run({value:u[f],issues:[]},c);w instanceof Promise?l.push(w.then(b=>wt(b,a,f,u))):wt(w,a,f,u)}return s?Zo(l,u,a,c,r.value,e):l.length?Promise.all(l).then(()=>a):a}}),hu=_("$ZodObjectJIT",(e,t)=>{mu.init(e,t);const n=e._zod.parse,r=zt(()=>Ro(t)),o=f=>{const m=new $a(["shape","payload","ctx"]),w=r.value,b=x=>{const T=Xn(x);return`shape[${T}]._zod.run({ value: input[${T}], issues: [] }, ctx)`};m.write("const input = payload.value;");const v=Object.create(null);let A=0;for(const x of w.keys)v[x]=`key_${A++}`;m.write("const newResult = {};");for(const x of w.keys){const T=v[x],I=Xn(x);m.write(`const ${T} = ${b(x)};`),m.write(`
        if (${T}.issues.length) {
          payload.issues = payload.issues.concat(${T}.issues.map(iss => ({
            ...iss,
            path: iss.path ? [${I}, ...iss.path] : [${I}]
          })));
        }
        
        
        if (${T}.value === undefined) {
          if (${I} in input) {
            newResult[${I}] = undefined;
          }
        } else {
          newResult[${I}] = ${T}.value;
        }
        
      `)}m.write("payload.value = newResult;"),m.write("return payload;");const y=m.compile();return(x,T)=>y(f,x,T)};let s;const i=tt,a=!bo.jitless,u=a&&Ei.value,l=t.catchall;let d;e._zod.parse=(f,m)=>{d??(d=r.value);const w=f.value;return i(w)?a&&u&&m?.async===!1&&m.jitless!==!0?(s||(s=o(t.shape)),f=s(f,m),l?Zo([],w,f,m,d,e):f):n(f,m):(f.issues.push({expected:"object",code:"invalid_type",input:w,inst:e}),f)}});function tr(e,t,n,r){for(const s of e)if(s.issues.length===0)return t.value=s.value,t;const o=e.filter(s=>!je(s));return o.length===1?(t.value=o[0].value,o[0]):(t.issues.push({code:"invalid_union",input:t.value,inst:n,errors:e.map(s=>s.issues.map(i=>Te(i,r,Se())))}),t)}const Mo=_("$ZodUnion",(e,t)=>{L.init(e,t),$(e._zod,"optin",()=>t.options.some(o=>o._zod.optin==="optional")?"optional":void 0),$(e._zod,"optout",()=>t.options.some(o=>o._zod.optout==="optional")?"optional":void 0),$(e._zod,"values",()=>{if(t.options.every(o=>o._zod.values))return new Set(t.options.flatMap(o=>Array.from(o._zod.values)))}),$(e._zod,"pattern",()=>{if(t.options.every(o=>o._zod.pattern)){const o=t.options.map(s=>s._zod.pattern);return new RegExp(`^(${o.map(s=>An(s.source)).join("|")})$`)}});const n=t.options.length===1,r=t.options[0]._zod.run;e._zod.parse=(o,s)=>{if(n)return r(o,s);let i=!1;const a=[];for(const c of t.options){const u=c._zod.run({value:o.value,issues:[]},s);if(u instanceof Promise)a.push(u),i=!0;else{if(u.issues.length===0)return u;a.push(u)}}return i?Promise.all(a).then(c=>tr(c,o,e,s)):tr(a,o,e,s)}}),gu=_("$ZodDiscriminatedUnion",(e,t)=>{t.inclusive=!1,Mo.init(e,t);const n=e._zod.parse;$(e._zod,"propValues",()=>{const o={};for(const s of t.options){const i=s._zod.propValues;if(!i||Object.keys(i).length===0)throw new Error(`Invalid discriminated union option at index "${t.options.indexOf(s)}"`);for(const[a,c]of Object.entries(i)){o[a]||(o[a]=new Set);for(const u of c)o[a].add(u)}}return o});const r=zt(()=>{const o=t.options,s=new Map;for(const i of o){const a=i._zod.propValues?.[t.discriminator];if(!a||a.size===0)throw new Error(`Invalid discriminated union option at index "${t.options.indexOf(i)}"`);for(const c of a){if(s.has(c))throw new Error(`Duplicate discriminator value "${String(c)}"`);s.set(c,i)}}return s});e._zod.parse=(o,s)=>{const i=o.value;if(!tt(i))return o.issues.push({code:"invalid_type",expected:"object",input:i,inst:e}),o;const a=r.value.get(i?.[t.discriminator]);return a?a._zod.run(o,s):t.unionFallback?n(o,s):(o.issues.push({code:"invalid_union",errors:[],note:"No matching discriminator",discriminator:t.discriminator,input:i,path:[t.discriminator],inst:e}),o)}}),_u=_("$ZodIntersection",(e,t)=>{L.init(e,t),e._zod.parse=(n,r)=>{const o=n.value,s=t.left._zod.run({value:o,issues:[]},r),i=t.right._zod.run({value:o,issues:[]},r);return s instanceof Promise||i instanceof Promise?Promise.all([s,i]).then(([c,u])=>nr(n,c,u)):nr(n,s,i)}});function un(e,t){if(e===t)return{valid:!0,data:e};if(e instanceof Date&&t instanceof Date&&+e==+t)return{valid:!0,data:e};if(Be(e)&&Be(t)){const n=Object.keys(t),r=Object.keys(e).filter(s=>n.indexOf(s)!==-1),o={...e,...t};for(const s of r){const i=un(e[s],t[s]);if(!i.valid)return{valid:!1,mergeErrorPath:[s,...i.mergeErrorPath]};o[s]=i.data}return{valid:!0,data:o}}if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return{valid:!1,mergeErrorPath:[]};const n=[];for(let r=0;r<e.length;r++){const o=e[r],s=t[r],i=un(o,s);if(!i.valid)return{valid:!1,mergeErrorPath:[r,...i.mergeErrorPath]};n.push(i.data)}return{valid:!0,data:n}}return{valid:!1,mergeErrorPath:[]}}function nr(e,t,n){if(t.issues.length&&e.issues.push(...t.issues),n.issues.length&&e.issues.push(...n.issues),je(e))return e;const r=un(t.value,n.value);if(!r.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(r.mergeErrorPath)}`);return e.value=r.data,e}const yu=_("$ZodRecord",(e,t)=>{L.init(e,t),e._zod.parse=(n,r)=>{const o=n.value;if(!Be(o))return n.issues.push({expected:"record",code:"invalid_type",input:o,inst:e}),n;const s=[],i=t.keyType._zod.values;if(i){n.value={};const a=new Set;for(const u of i)if(typeof u=="string"||typeof u=="number"||typeof u=="symbol"){a.add(typeof u=="number"?u.toString():u);const l=t.valueType._zod.run({value:o[u],issues:[]},r);l instanceof Promise?s.push(l.then(d=>{d.issues.length&&n.issues.push(...Fe(u,d.issues)),n.value[u]=d.value})):(l.issues.length&&n.issues.push(...Fe(u,l.issues)),n.value[u]=l.value)}let c;for(const u in o)a.has(u)||(c=c??[],c.push(u));c&&c.length>0&&n.issues.push({code:"unrecognized_keys",input:o,inst:e,keys:c})}else{n.value={};for(const a of Reflect.ownKeys(o)){if(a==="__proto__")continue;const c=t.keyType._zod.run({value:a,issues:[]},r);if(c instanceof Promise)throw new Error("Async schemas not supported in object keys currently");if(c.issues.length){t.mode==="loose"?n.value[a]=o[a]:n.issues.push({code:"invalid_key",origin:"record",issues:c.issues.map(l=>Te(l,r,Se())),input:a,path:[a],inst:e});continue}const u=t.valueType._zod.run({value:o[a],issues:[]},r);u instanceof Promise?s.push(u.then(l=>{l.issues.length&&n.issues.push(...Fe(a,l.issues)),n.value[c.value]=l.value})):(u.issues.length&&n.issues.push(...Fe(a,u.issues)),n.value[c.value]=u.value)}}return s.length?Promise.all(s).then(()=>n):n}}),vu=_("$ZodEnum",(e,t)=>{L.init(e,t);const n=Io(t.entries),r=new Set(n);e._zod.values=r,e._zod.pattern=new RegExp(`^(${n.filter(o=>Oi.has(typeof o)).map(o=>typeof o=="string"?Ge(o):o.toString()).join("|")})$`),e._zod.parse=(o,s)=>{const i=o.value;return r.has(i)||o.issues.push({code:"invalid_value",values:n,input:i,inst:e}),o}}),wu=_("$ZodLiteral",(e,t)=>{if(L.init(e,t),t.values.length===0)throw new Error("Cannot create literal schema with no valid values");const n=new Set(t.values);e._zod.values=n,e._zod.pattern=new RegExp(`^(${t.values.map(r=>typeof r=="string"?Ge(r):r?Ge(r.toString()):String(r)).join("|")})$`),e._zod.parse=(r,o)=>{const s=r.value;return n.has(s)||r.issues.push({code:"invalid_value",values:t.values,input:s,inst:e}),r}}),bu=_("$ZodTransform",(e,t)=>{L.init(e,t),e._zod.parse=(n,r)=>{if(r.direction==="backward")throw new wo(e.constructor.name);const o=t.transform(n.value,n);if(r.async)return(o instanceof Promise?o:Promise.resolve(o)).then(i=>(n.value=i,n));if(o instanceof Promise)throw new Je;return n.value=o,n}});function rr(e,t){return e.issues.length&&t===void 0?{issues:[],value:void 0}:e}const Iu=_("$ZodOptional",(e,t)=>{L.init(e,t),e._zod.optin="optional",e._zod.optout="optional",$(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),$(e._zod,"pattern",()=>{const n=t.innerType._zod.pattern;return n?new RegExp(`^(${An(n.source)})?$`):void 0}),e._zod.parse=(n,r)=>{if(t.innerType._zod.optin==="optional"){const o=t.innerType._zod.run(n,r);return o instanceof Promise?o.then(s=>rr(s,n.value)):rr(o,n.value)}return n.value===void 0?n:t.innerType._zod.run(n,r)}}),Su=_("$ZodNullable",(e,t)=>{L.init(e,t),$(e._zod,"optin",()=>t.innerType._zod.optin),$(e._zod,"optout",()=>t.innerType._zod.optout),$(e._zod,"pattern",()=>{const n=t.innerType._zod.pattern;return n?new RegExp(`^(${An(n.source)}|null)$`):void 0}),$(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(n,r)=>n.value===null?n:t.innerType._zod.run(n,r)}),Tu=_("$ZodDefault",(e,t)=>{L.init(e,t),e._zod.optin="optional",$(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,r)=>{if(r.direction==="backward")return t.innerType._zod.run(n,r);if(n.value===void 0)return n.value=t.defaultValue,n;const o=t.innerType._zod.run(n,r);return o instanceof Promise?o.then(s=>or(s,t)):or(o,t)}});function or(e,t){return e.value===void 0&&(e.value=t.defaultValue),e}const Au=_("$ZodPrefault",(e,t)=>{L.init(e,t),e._zod.optin="optional",$(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,r)=>(r.direction==="backward"||n.value===void 0&&(n.value=t.defaultValue),t.innerType._zod.run(n,r))}),ku=_("$ZodNonOptional",(e,t)=>{L.init(e,t),$(e._zod,"values",()=>{const n=t.innerType._zod.values;return n?new Set([...n].filter(r=>r!==void 0)):void 0}),e._zod.parse=(n,r)=>{const o=t.innerType._zod.run(n,r);return o instanceof Promise?o.then(s=>sr(s,e)):sr(o,e)}});function sr(e,t){return!e.issues.length&&e.value===void 0&&e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}const xu=_("$ZodCatch",(e,t)=>{L.init(e,t),$(e._zod,"optin",()=>t.innerType._zod.optin),$(e._zod,"optout",()=>t.innerType._zod.optout),$(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(n,r)=>{if(r.direction==="backward")return t.innerType._zod.run(n,r);const o=t.innerType._zod.run(n,r);return o instanceof Promise?o.then(s=>(n.value=s.value,s.issues.length&&(n.value=t.catchValue({...n,error:{issues:s.issues.map(i=>Te(i,r,Se()))},input:n.value}),n.issues=[]),n)):(n.value=o.value,o.issues.length&&(n.value=t.catchValue({...n,error:{issues:o.issues.map(s=>Te(s,r,Se()))},input:n.value}),n.issues=[]),n)}}),Eu=_("$ZodPipe",(e,t)=>{L.init(e,t),$(e._zod,"values",()=>t.in._zod.values),$(e._zod,"optin",()=>t.in._zod.optin),$(e._zod,"optout",()=>t.out._zod.optout),$(e._zod,"propValues",()=>t.in._zod.propValues),e._zod.parse=(n,r)=>{if(r.direction==="backward"){const s=t.out._zod.run(n,r);return s instanceof Promise?s.then(i=>ft(i,t.in,r)):ft(s,t.in,r)}const o=t.in._zod.run(n,r);return o instanceof Promise?o.then(s=>ft(s,t.out,r)):ft(o,t.out,r)}});function ft(e,t,n){return e.issues.length?(e.aborted=!0,e):t._zod.run({value:e.value,issues:e.issues},n)}const Ou=_("$ZodReadonly",(e,t)=>{L.init(e,t),$(e._zod,"propValues",()=>t.innerType._zod.propValues),$(e._zod,"values",()=>t.innerType._zod.values),$(e._zod,"optin",()=>t.innerType?._zod?.optin),$(e._zod,"optout",()=>t.innerType?._zod?.optout),e._zod.parse=(n,r)=>{if(r.direction==="backward")return t.innerType._zod.run(n,r);const o=t.innerType._zod.run(n,r);return o instanceof Promise?o.then(ir):ir(o)}});function ir(e){return e.value=Object.freeze(e.value),e}const Cu=_("$ZodLazy",(e,t)=>{L.init(e,t),$(e._zod,"innerType",()=>t.getter()),$(e._zod,"pattern",()=>e._zod.innerType?._zod?.pattern),$(e._zod,"propValues",()=>e._zod.innerType?._zod?.propValues),$(e._zod,"optin",()=>e._zod.innerType?._zod?.optin??void 0),$(e._zod,"optout",()=>e._zod.innerType?._zod?.optout??void 0),e._zod.parse=(n,r)=>e._zod.innerType._zod.run(n,r)}),Pu=_("$ZodCustom",(e,t)=>{Q.init(e,t),L.init(e,t),e._zod.parse=(n,r)=>n,e._zod.check=n=>{const r=n.value,o=t.fn(r);if(o instanceof Promise)return o.then(s=>ar(s,n,r,e));ar(o,n,r,e)}});function ar(e,t,n,r){if(!e){const o={code:"custom",input:n,inst:r,path:[...r._zod.def.path??[]],continue:!r._zod.def.abort};r._zod.def.params&&(o.params=r._zod.def.params),t.issues.push(nt(o))}}var ur;class Nu{constructor(){this._map=new WeakMap,this._idmap=new Map}add(t,...n){const r=n[0];if(this._map.set(t,r),r&&typeof r=="object"&&"id"in r){if(this._idmap.has(r.id))throw new Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,t)}return this}clear(){return this._map=new WeakMap,this._idmap=new Map,this}remove(t){const n=this._map.get(t);return n&&typeof n=="object"&&"id"in n&&this._idmap.delete(n.id),this._map.delete(t),this}get(t){const n=t._zod.parent;if(n){const r={...this.get(n)??{}};delete r.id;const o={...r,...this._map.get(t)};return Object.keys(o).length?o:void 0}return this._map.get(t)}has(t){return this._map.has(t)}}function zu(){return new Nu}(ur=globalThis).__zod_globalRegistry??(ur.__zod_globalRegistry=zu());const Xe=globalThis.__zod_globalRegistry;function Du(e,t){return new e({type:"string",...E(t)})}function $u(e,t){return new e({type:"string",format:"email",check:"string_format",abort:!1,...E(t)})}function cr(e,t){return new e({type:"string",format:"guid",check:"string_format",abort:!1,...E(t)})}function Ru(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,...E(t)})}function Zu(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...E(t)})}function Mu(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...E(t)})}function ju(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...E(t)})}function Fu(e,t){return new e({type:"string",format:"url",check:"string_format",abort:!1,...E(t)})}function Lu(e,t){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,...E(t)})}function Uu(e,t){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,...E(t)})}function Ju(e,t){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,...E(t)})}function qu(e,t){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,...E(t)})}function Bu(e,t){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,...E(t)})}function Gu(e,t){return new e({type:"string",format:"xid",check:"string_format",abort:!1,...E(t)})}function Wu(e,t){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,...E(t)})}function Vu(e,t){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,...E(t)})}function Hu(e,t){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,...E(t)})}function Ku(e,t){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,...E(t)})}function Yu(e,t){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,...E(t)})}function Xu(e,t){return new e({type:"string",format:"base64",check:"string_format",abort:!1,...E(t)})}function Qu(e,t){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,...E(t)})}function ec(e,t){return new e({type:"string",format:"e164",check:"string_format",abort:!1,...E(t)})}function tc(e,t){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,...E(t)})}function nc(e,t){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...E(t)})}function rc(e,t){return new e({type:"string",format:"date",check:"string_format",...E(t)})}function oc(e,t){return new e({type:"string",format:"time",check:"string_format",precision:null,...E(t)})}function sc(e,t){return new e({type:"string",format:"duration",check:"string_format",...E(t)})}function ic(e,t){return new e({type:"number",checks:[],...E(t)})}function ac(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"safeint",...E(t)})}function uc(e,t){return new e({type:"boolean",...E(t)})}function cc(e){return new e({type:"any"})}function lc(e){return new e({type:"unknown"})}function pc(e,t){return new e({type:"never",...E(t)})}function lr(e,t){return new No({check:"less_than",...E(t),value:e,inclusive:!1})}function Wt(e,t){return new No({check:"less_than",...E(t),value:e,inclusive:!0})}function pr(e,t){return new zo({check:"greater_than",...E(t),value:e,inclusive:!1})}function Vt(e,t){return new zo({check:"greater_than",...E(t),value:e,inclusive:!0})}function dr(e,t){return new Sa({check:"multiple_of",...E(t),value:e})}function jo(e,t){return new Aa({check:"max_length",...E(t),maximum:e})}function bt(e,t){return new ka({check:"min_length",...E(t),minimum:e})}function Fo(e,t){return new xa({check:"length_equals",...E(t),length:e})}function dc(e,t){return new Ea({check:"string_format",format:"regex",...E(t),pattern:e})}function fc(e){return new Oa({check:"string_format",format:"lowercase",...E(e)})}function mc(e){return new Ca({check:"string_format",format:"uppercase",...E(e)})}function hc(e,t){return new Pa({check:"string_format",format:"includes",...E(t),includes:e})}function gc(e,t){return new Na({check:"string_format",format:"starts_with",...E(t),prefix:e})}function _c(e,t){return new za({check:"string_format",format:"ends_with",...E(t),suffix:e})}function Ve(e){return new Da({check:"overwrite",tx:e})}function yc(e){return Ve(t=>t.normalize(e))}function vc(){return Ve(e=>e.trim())}function wc(){return Ve(e=>e.toLowerCase())}function bc(){return Ve(e=>e.toUpperCase())}function Ic(){return Ve(e=>xi(e))}function Sc(e,t,n){return new e({type:"array",element:t,...E(n)})}function Tc(e,t,n){return new e({type:"custom",check:"custom",fn:t,...E(n)})}function Ac(e){const t=kc(n=>(n.addIssue=r=>{if(typeof r=="string")n.issues.push(nt(r,n.value,t._zod.def));else{const o=r;o.fatal&&(o.continue=!1),o.code??(o.code="custom"),o.input??(o.input=n.value),o.inst??(o.inst=t),o.continue??(o.continue=!t._zod.def.abort),n.issues.push(nt(o))}},e(n.value,n)));return t}function kc(e,t){const n=new Q({check:"custom",...E(t)});return n._zod.check=e,n}function It(e){let t=e?.target??"draft-2020-12";return t==="draft-4"&&(t="draft-04"),t==="draft-7"&&(t="draft-07"),{processors:e.processors??{},metadataRegistry:e?.metadata??Xe,target:t,unrepresentable:e?.unrepresentable??"throw",override:e?.override??(()=>{}),io:e?.io??"output",counter:0,seen:new Map,cycles:e?.cycles??"ref",reused:e?.reused??"inline",external:e?.external??void 0}}function F(e,t,n={path:[],schemaPath:[]}){var r;const o=e._zod.def,s=t.seen.get(e);if(s)return s.count++,n.schemaPath.includes(e)&&(s.cycle=n.path),s.schema;const i={schema:{},count:1,cycle:void 0,path:n.path};t.seen.set(e,i);const a=e._zod.toJSONSchema?.();if(a)i.schema=a;else{const l={...n,schemaPath:[...n.schemaPath,e],path:n.path},d=e._zod.parent;if(d)i.ref=d,F(d,t,l),t.seen.get(d).isParent=!0;else if(e._zod.processJSONSchema)e._zod.processJSONSchema(t,i.schema,l);else{const f=i.schema,m=t.processors[o.type];if(!m)throw new Error(`[toJSONSchema]: Non-representable type encountered: ${o.type}`);m(e,t,f,l)}}const c=t.metadataRegistry.get(e);return c&&Object.assign(i.schema,c),t.io==="input"&&K(e)&&(delete i.schema.examples,delete i.schema.default),t.io==="input"&&i.schema._prefault&&((r=i.schema).default??(r.default=i.schema._prefault)),delete i.schema._prefault,t.seen.get(e).schema}function St(e,t){const n=e.seen.get(t);if(!n)throw new Error("Unprocessed schema. This is a bug in Zod.");const r=s=>{const i=e.target==="draft-2020-12"?"$defs":"definitions";if(e.external){const l=e.external.registry.get(s[0])?.id,d=e.external.uri??(m=>m);if(l)return{ref:d(l)};const f=s[1].defId??s[1].schema.id??`schema${e.counter++}`;return s[1].defId=f,{defId:f,ref:`${d("__shared")}#/${i}/${f}`}}if(s[1]===n)return{ref:"#"};const c=`#/${i}/`,u=s[1].schema.id??`__schema${e.counter++}`;return{defId:u,ref:c+u}},o=s=>{if(s[1].schema.$ref)return;const i=s[1],{ref:a,defId:c}=r(s);i.def={...i.schema},c&&(i.defId=c);const u=i.schema;for(const l in u)delete u[l];u.$ref=a};if(e.cycles==="throw")for(const s of e.seen.entries()){const i=s[1];if(i.cycle)throw new Error(`Cycle detected: #/${i.cycle?.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const s of e.seen.entries()){const i=s[1];if(t===s[0]){o(s);continue}if(e.external){const c=e.external.registry.get(s[0])?.id;if(t!==s[0]&&c){o(s);continue}}if(e.metadataRegistry.get(s[0])?.id){o(s);continue}if(i.cycle){o(s);continue}if(i.count>1&&e.reused==="ref"){o(s);continue}}}function Tt(e,t){const n=e.seen.get(t);if(!n)throw new Error("Unprocessed schema. This is a bug in Zod.");const r=i=>{const a=e.seen.get(i),c=a.def??a.schema,u={...c};if(a.ref===null)return;const l=a.ref;if(a.ref=null,l){r(l);const d=e.seen.get(l).schema;d.$ref&&(e.target==="draft-07"||e.target==="draft-04"||e.target==="openapi-3.0")?(c.allOf=c.allOf??[],c.allOf.push(d)):(Object.assign(c,d),Object.assign(c,u))}a.isParent||e.override({zodSchema:i,jsonSchema:c,path:a.path??[]})};for(const i of[...e.seen.entries()].reverse())r(i[0]);const o={};if(e.target==="draft-2020-12"?o.$schema="https://json-schema.org/draft/2020-12/schema":e.target==="draft-07"?o.$schema="http://json-schema.org/draft-07/schema#":e.target==="draft-04"?o.$schema="http://json-schema.org/draft-04/schema#":e.target,e.external?.uri){const i=e.external.registry.get(t)?.id;if(!i)throw new Error("Schema is missing an `id` property");o.$id=e.external.uri(i)}Object.assign(o,n.def??n.schema);const s=e.external?.defs??{};for(const i of e.seen.entries()){const a=i[1];a.def&&a.defId&&(s[a.defId]=a.def)}e.external||Object.keys(s).length>0&&(e.target==="draft-2020-12"?o.$defs=s:o.definitions=s);try{const i=JSON.parse(JSON.stringify(o));return Object.defineProperty(i,"~standard",{value:{...t["~standard"],jsonSchema:{input:At(t,"input"),output:At(t,"output")}},enumerable:!1,writable:!1}),i}catch{throw new Error("Error converting schema to JSON.")}}function K(e,t){const n=t??{seen:new Set};if(n.seen.has(e))return!1;n.seen.add(e);const r=e._zod.def;if(r.type==="transform")return!0;if(r.type==="array")return K(r.element,n);if(r.type==="set")return K(r.valueType,n);if(r.type==="lazy")return K(r.getter(),n);if(r.type==="promise"||r.type==="optional"||r.type==="nonoptional"||r.type==="nullable"||r.type==="readonly"||r.type==="default"||r.type==="prefault")return K(r.innerType,n);if(r.type==="intersection")return K(r.left,n)||K(r.right,n);if(r.type==="record"||r.type==="map")return K(r.keyType,n)||K(r.valueType,n);if(r.type==="pipe")return K(r.in,n)||K(r.out,n);if(r.type==="object"){for(const o in r.shape)if(K(r.shape[o],n))return!0;return!1}if(r.type==="union"){for(const o of r.options)if(K(o,n))return!0;return!1}if(r.type==="tuple"){for(const o of r.items)if(K(o,n))return!0;return!!(r.rest&&K(r.rest,n))}return!1}const xc=(e,t={})=>n=>{const r=It({...n,processors:t});return F(e,r),St(r,e),Tt(r,e)},At=(e,t)=>n=>{const{libraryOptions:r,target:o}=n??{},s=It({...r??{},target:o,io:t,processors:{}});return F(e,s),St(s,e),Tt(s,e)},Ec={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},Lo=(e,t,n,r)=>{const o=n;o.type="string";const{minimum:s,maximum:i,format:a,patterns:c,contentEncoding:u}=e._zod.bag;if(typeof s=="number"&&(o.minLength=s),typeof i=="number"&&(o.maxLength=i),a&&(o.format=Ec[a]??a,o.format===""&&delete o.format),u&&(o.contentEncoding=u),c&&c.size>0){const l=[...c];l.length===1?o.pattern=l[0].source:l.length>1&&(o.allOf=[...l.map(d=>({...t.target==="draft-07"||t.target==="draft-04"||t.target==="openapi-3.0"?{type:"string"}:{},pattern:d.source}))])}},Uo=(e,t,n,r)=>{const o=n,{minimum:s,maximum:i,format:a,multipleOf:c,exclusiveMaximum:u,exclusiveMinimum:l}=e._zod.bag;typeof a=="string"&&a.includes("int")?o.type="integer":o.type="number",typeof l=="number"&&(t.target==="draft-04"||t.target==="openapi-3.0"?(o.minimum=l,o.exclusiveMinimum=!0):o.exclusiveMinimum=l),typeof s=="number"&&(o.minimum=s,typeof l=="number"&&t.target!=="draft-04"&&(l>=s?delete o.minimum:delete o.exclusiveMinimum)),typeof u=="number"&&(t.target==="draft-04"||t.target==="openapi-3.0"?(o.maximum=u,o.exclusiveMaximum=!0):o.exclusiveMaximum=u),typeof i=="number"&&(o.maximum=i,typeof u=="number"&&t.target!=="draft-04"&&(u<=i?delete o.maximum:delete o.exclusiveMaximum)),typeof c=="number"&&(o.multipleOf=c)},Jo=(e,t,n,r)=>{n.type="boolean"},Oc=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("BigInt cannot be represented in JSON Schema")},Cc=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Symbols cannot be represented in JSON Schema")},Pc=(e,t,n,r)=>{t.target==="openapi-3.0"?(n.type="string",n.nullable=!0,n.enum=[null]):n.type="null"},Nc=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Undefined cannot be represented in JSON Schema")},zc=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Void cannot be represented in JSON Schema")},qo=(e,t,n,r)=>{n.not={}},Bo=(e,t,n,r)=>{},Go=(e,t,n,r)=>{},Dc=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Date cannot be represented in JSON Schema")},Wo=(e,t,n,r)=>{const o=e._zod.def,s=Io(o.entries);s.every(i=>typeof i=="number")&&(n.type="number"),s.every(i=>typeof i=="string")&&(n.type="string"),n.enum=s},Vo=(e,t,n,r)=>{const o=e._zod.def,s=[];for(const i of o.values)if(i===void 0){if(t.unrepresentable==="throw")throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if(typeof i=="bigint"){if(t.unrepresentable==="throw")throw new Error("BigInt literals cannot be represented in JSON Schema");s.push(Number(i))}else s.push(i);if(s.length!==0)if(s.length===1){const i=s[0];n.type=i===null?"null":typeof i,t.target==="draft-04"||t.target==="openapi-3.0"?n.enum=[i]:n.const=i}else s.every(i=>typeof i=="number")&&(n.type="number"),s.every(i=>typeof i=="string")&&(n.type="string"),s.every(i=>typeof i=="boolean")&&(n.type="boolean"),s.every(i=>i===null)&&(n.type="null"),n.enum=s},$c=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("NaN cannot be represented in JSON Schema")},Rc=(e,t,n,r)=>{const o=n,s=e._zod.pattern;if(!s)throw new Error("Pattern not found in template literal");o.type="string",o.pattern=s.source},Zc=(e,t,n,r)=>{const o=n,s={type:"string",format:"binary",contentEncoding:"binary"},{minimum:i,maximum:a,mime:c}=e._zod.bag;i!==void 0&&(s.minLength=i),a!==void 0&&(s.maxLength=a),c?c.length===1?(s.contentMediaType=c[0],Object.assign(o,s)):o.anyOf=c.map(u=>({...s,contentMediaType:u})):Object.assign(o,s)},Mc=(e,t,n,r)=>{n.type="boolean"},Ho=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Custom types cannot be represented in JSON Schema")},jc=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Function types cannot be represented in JSON Schema")},Ko=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Transforms cannot be represented in JSON Schema")},Fc=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Map cannot be represented in JSON Schema")},Lc=(e,t,n,r)=>{if(t.unrepresentable==="throw")throw new Error("Set cannot be represented in JSON Schema")},Yo=(e,t,n,r)=>{const o=n,s=e._zod.def,{minimum:i,maximum:a}=e._zod.bag;typeof i=="number"&&(o.minItems=i),typeof a=="number"&&(o.maxItems=a),o.type="array",o.items=F(s.element,t,{...r,path:[...r.path,"items"]})},Xo=(e,t,n,r)=>{const o=n,s=e._zod.def;o.type="object",o.properties={};const i=s.shape;for(const u in i)o.properties[u]=F(i[u],t,{...r,path:[...r.path,"properties",u]});const a=new Set(Object.keys(i)),c=new Set([...a].filter(u=>{const l=s.shape[u]._zod;return t.io==="input"?l.optin===void 0:l.optout===void 0}));c.size>0&&(o.required=Array.from(c)),s.catchall?._zod.def.type==="never"?o.additionalProperties=!1:s.catchall?s.catchall&&(o.additionalProperties=F(s.catchall,t,{...r,path:[...r.path,"additionalProperties"]})):t.io==="output"&&(o.additionalProperties=!1)},Qo=(e,t,n,r)=>{const o=e._zod.def,s=o.inclusive===!1,i=o.options.map((a,c)=>F(a,t,{...r,path:[...r.path,s?"oneOf":"anyOf",c]}));s?n.oneOf=i:n.anyOf=i},es=(e,t,n,r)=>{const o=e._zod.def,s=F(o.left,t,{...r,path:[...r.path,"allOf",0]}),i=F(o.right,t,{...r,path:[...r.path,"allOf",1]}),a=u=>"allOf"in u&&Object.keys(u).length===1,c=[...a(s)?s.allOf:[s],...a(i)?i.allOf:[i]];n.allOf=c},Uc=(e,t,n,r)=>{const o=n,s=e._zod.def;o.type="array";const i=t.target==="draft-2020-12"?"prefixItems":"items",a=t.target==="draft-2020-12"||t.target==="openapi-3.0"?"items":"additionalItems",c=s.items.map((f,m)=>F(f,t,{...r,path:[...r.path,i,m]})),u=s.rest?F(s.rest,t,{...r,path:[...r.path,a,...t.target==="openapi-3.0"?[s.items.length]:[]]}):null;t.target==="draft-2020-12"?(o.prefixItems=c,u&&(o.items=u)):t.target==="openapi-3.0"?(o.items={anyOf:c},u&&o.items.anyOf.push(u),o.minItems=c.length,u||(o.maxItems=c.length)):(o.items=c,u&&(o.additionalItems=u));const{minimum:l,maximum:d}=e._zod.bag;typeof l=="number"&&(o.minItems=l),typeof d=="number"&&(o.maxItems=d)},ts=(e,t,n,r)=>{const o=n,s=e._zod.def;o.type="object",(t.target==="draft-07"||t.target==="draft-2020-12")&&(o.propertyNames=F(s.keyType,t,{...r,path:[...r.path,"propertyNames"]})),o.additionalProperties=F(s.valueType,t,{...r,path:[...r.path,"additionalProperties"]})},ns=(e,t,n,r)=>{const o=e._zod.def,s=F(o.innerType,t,r),i=t.seen.get(e);t.target==="openapi-3.0"?(i.ref=o.innerType,n.nullable=!0):n.anyOf=[s,{type:"null"}]},rs=(e,t,n,r)=>{const o=e._zod.def;F(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType},os=(e,t,n,r)=>{const o=e._zod.def;F(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType,n.default=JSON.parse(JSON.stringify(o.defaultValue))},ss=(e,t,n,r)=>{const o=e._zod.def;F(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType,t.io==="input"&&(n._prefault=JSON.parse(JSON.stringify(o.defaultValue)))},is=(e,t,n,r)=>{const o=e._zod.def;F(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType;let i;try{i=o.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}n.default=i},as=(e,t,n,r)=>{const o=e._zod.def,s=t.io==="input"?o.in._zod.def.type==="transform"?o.out:o.in:o.out;F(s,t,r);const i=t.seen.get(e);i.ref=s},us=(e,t,n,r)=>{const o=e._zod.def;F(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType,n.readOnly=!0},Jc=(e,t,n,r)=>{const o=e._zod.def;F(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType},cs=(e,t,n,r)=>{const o=e._zod.def;F(o.innerType,t,r);const s=t.seen.get(e);s.ref=o.innerType},ls=(e,t,n,r)=>{const o=e._zod.innerType;F(o,t,r);const s=t.seen.get(e);s.ref=o},fr={string:Lo,number:Uo,boolean:Jo,bigint:Oc,symbol:Cc,null:Pc,undefined:Nc,void:zc,never:qo,any:Bo,unknown:Go,date:Dc,enum:Wo,literal:Vo,nan:$c,template_literal:Rc,file:Zc,success:Mc,custom:Ho,function:jc,transform:Ko,map:Fc,set:Lc,array:Yo,object:Xo,union:Qo,intersection:es,tuple:Uc,record:ts,nullable:ns,nonoptional:rs,default:os,prefault:ss,catch:is,pipe:as,readonly:us,promise:Jc,optional:cs,lazy:ls};function qc(e,t){if("_idmap"in e){const r=e,o=It({...t,processors:fr}),s={};for(const c of r._idmap.entries()){const[u,l]=c;F(l,o)}const i={},a={registry:r,uri:t?.uri,defs:s};o.external=a;for(const c of r._idmap.entries()){const[u,l]=c;St(o,l),i[u]=Tt(o,l)}if(Object.keys(s).length>0){const c=o.target==="draft-2020-12"?"$defs":"definitions";i.__shared={[c]:s}}return{schemas:i}}const n=It({...t,processors:fr});return F(e,n),St(n,e),Tt(n,e)}const Bc=_("ZodISODateTime",(e,t)=>{Va.init(e,t),B.init(e,t)});function Gc(e){return nc(Bc,e)}const Wc=_("ZodISODate",(e,t)=>{Ha.init(e,t),B.init(e,t)});function Vc(e){return rc(Wc,e)}const Hc=_("ZodISOTime",(e,t)=>{Ka.init(e,t),B.init(e,t)});function Kc(e){return oc(Hc,e)}const Yc=_("ZodISODuration",(e,t)=>{Ya.init(e,t),B.init(e,t)});function Xc(e){return sc(Yc,e)}const ps=(e,t)=>{ko.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:n=>Fi(e,n)},flatten:{value:n=>ji(e,n)},addIssue:{value:n=>{e.issues.push(n),e.message=JSON.stringify(e.issues,an,2)}},addIssues:{value:n=>{e.issues.push(...n),e.message=JSON.stringify(e.issues,an,2)}},isEmpty:{get(){return e.issues.length===0}}})},Qc=_("ZodError",ps),re=_("ZodError",ps,{Parent:Error}),el=xn(re),tl=En(re),nl=Dt(re),rl=$t(re),ol=Ji(re),sl=qi(re),il=Bi(re),al=Gi(re),ul=Wi(re),cl=Vi(re),ll=Hi(re),pl=Ki(re),J=_("ZodType",(e,t)=>(L.init(e,t),Object.assign(e["~standard"],{jsonSchema:{input:At(e,"input"),output:At(e,"output")}}),e.toJSONSchema=xc(e,{}),e.def=t,e.type=t.type,Object.defineProperty(e,"_def",{value:t}),e.check=(...n)=>e.clone(Ze(t,{checks:[...t.checks??[],...n.map(r=>typeof r=="function"?{_zod:{check:r,def:{check:"custom"},onattach:[]}}:r)]})),e.clone=(n,r)=>ke(e,n,r),e.brand=()=>e,e.register=((n,r)=>(n.add(e,r),e)),e.parse=(n,r)=>el(e,n,r,{callee:e.parse}),e.safeParse=(n,r)=>nl(e,n,r),e.parseAsync=async(n,r)=>tl(e,n,r,{callee:e.parseAsync}),e.safeParseAsync=async(n,r)=>rl(e,n,r),e.spa=e.safeParseAsync,e.encode=(n,r)=>ol(e,n,r),e.decode=(n,r)=>sl(e,n,r),e.encodeAsync=async(n,r)=>il(e,n,r),e.decodeAsync=async(n,r)=>al(e,n,r),e.safeEncode=(n,r)=>ul(e,n,r),e.safeDecode=(n,r)=>cl(e,n,r),e.safeEncodeAsync=async(n,r)=>ll(e,n,r),e.safeDecodeAsync=async(n,r)=>pl(e,n,r),e.refine=(n,r)=>e.check(op(n,r)),e.superRefine=n=>e.check(sp(n)),e.overwrite=n=>e.check(Ve(n)),e.optional=()=>_r(e),e.nullable=()=>yr(e),e.nullish=()=>_r(yr(e)),e.nonoptional=n=>Kl(e,n),e.array=()=>C(e),e.or=n=>de([e,n]),e.and=n=>Fl(e,n),e.transform=n=>vr(e,ql(n)),e.default=n=>Wl(e,n),e.prefault=n=>Hl(e,n),e.catch=n=>Xl(e,n),e.pipe=n=>vr(e,n),e.readonly=()=>tp(e),e.describe=n=>{const r=e.clone();return Xe.add(r,{description:n}),r},Object.defineProperty(e,"description",{get(){return Xe.get(e)?.description},configurable:!0}),e.meta=(...n)=>{if(n.length===0)return Xe.get(e);const r=e.clone();return Xe.add(r,n[0]),r},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),ds=_("_ZodString",(e,t)=>{On.init(e,t),J.init(e,t),e._zod.processJSONSchema=(r,o,s)=>Lo(e,r,o);const n=e._zod.bag;e.format=n.format??null,e.minLength=n.minimum??null,e.maxLength=n.maximum??null,e.regex=(...r)=>e.check(dc(...r)),e.includes=(...r)=>e.check(hc(...r)),e.startsWith=(...r)=>e.check(gc(...r)),e.endsWith=(...r)=>e.check(_c(...r)),e.min=(...r)=>e.check(bt(...r)),e.max=(...r)=>e.check(jo(...r)),e.length=(...r)=>e.check(Fo(...r)),e.nonempty=(...r)=>e.check(bt(1,...r)),e.lowercase=r=>e.check(fc(r)),e.uppercase=r=>e.check(mc(r)),e.trim=()=>e.check(vc()),e.normalize=(...r)=>e.check(yc(...r)),e.toLowerCase=()=>e.check(wc()),e.toUpperCase=()=>e.check(bc()),e.slugify=()=>e.check(Ic())}),dl=_("ZodString",(e,t)=>{On.init(e,t),ds.init(e,t),e.email=n=>e.check($u(fl,n)),e.url=n=>e.check(Fu(ml,n)),e.jwt=n=>e.check(tc(Ol,n)),e.emoji=n=>e.check(Lu(hl,n)),e.guid=n=>e.check(cr(mr,n)),e.uuid=n=>e.check(Ru(mt,n)),e.uuidv4=n=>e.check(Zu(mt,n)),e.uuidv6=n=>e.check(Mu(mt,n)),e.uuidv7=n=>e.check(ju(mt,n)),e.nanoid=n=>e.check(Uu(gl,n)),e.guid=n=>e.check(cr(mr,n)),e.cuid=n=>e.check(Ju(_l,n)),e.cuid2=n=>e.check(qu(yl,n)),e.ulid=n=>e.check(Bu(vl,n)),e.base64=n=>e.check(Xu(kl,n)),e.base64url=n=>e.check(Qu(xl,n)),e.xid=n=>e.check(Gu(wl,n)),e.ksuid=n=>e.check(Wu(bl,n)),e.ipv4=n=>e.check(Vu(Il,n)),e.ipv6=n=>e.check(Hu(Sl,n)),e.cidrv4=n=>e.check(Ku(Tl,n)),e.cidrv6=n=>e.check(Yu(Al,n)),e.e164=n=>e.check(ec(El,n)),e.datetime=n=>e.check(Gc(n)),e.date=n=>e.check(Vc(n)),e.time=n=>e.check(Kc(n)),e.duration=n=>e.check(Xc(n))});function p(e){return Du(dl,e)}const B=_("ZodStringFormat",(e,t)=>{U.init(e,t),ds.init(e,t)}),fl=_("ZodEmail",(e,t)=>{ja.init(e,t),B.init(e,t)}),mr=_("ZodGUID",(e,t)=>{Za.init(e,t),B.init(e,t)}),mt=_("ZodUUID",(e,t)=>{Ma.init(e,t),B.init(e,t)}),ml=_("ZodURL",(e,t)=>{Fa.init(e,t),B.init(e,t)}),hl=_("ZodEmoji",(e,t)=>{La.init(e,t),B.init(e,t)}),gl=_("ZodNanoID",(e,t)=>{Ua.init(e,t),B.init(e,t)}),_l=_("ZodCUID",(e,t)=>{Ja.init(e,t),B.init(e,t)}),yl=_("ZodCUID2",(e,t)=>{qa.init(e,t),B.init(e,t)}),vl=_("ZodULID",(e,t)=>{Ba.init(e,t),B.init(e,t)}),wl=_("ZodXID",(e,t)=>{Ga.init(e,t),B.init(e,t)}),bl=_("ZodKSUID",(e,t)=>{Wa.init(e,t),B.init(e,t)}),Il=_("ZodIPv4",(e,t)=>{Xa.init(e,t),B.init(e,t)}),Sl=_("ZodIPv6",(e,t)=>{Qa.init(e,t),B.init(e,t)}),Tl=_("ZodCIDRv4",(e,t)=>{eu.init(e,t),B.init(e,t)}),Al=_("ZodCIDRv6",(e,t)=>{tu.init(e,t),B.init(e,t)}),kl=_("ZodBase64",(e,t)=>{nu.init(e,t),B.init(e,t)}),xl=_("ZodBase64URL",(e,t)=>{ou.init(e,t),B.init(e,t)}),El=_("ZodE164",(e,t)=>{su.init(e,t),B.init(e,t)}),Ol=_("ZodJWT",(e,t)=>{au.init(e,t),B.init(e,t)}),fs=_("ZodNumber",(e,t)=>{$o.init(e,t),J.init(e,t),e._zod.processJSONSchema=(r,o,s)=>Uo(e,r,o),e.gt=(r,o)=>e.check(pr(r,o)),e.gte=(r,o)=>e.check(Vt(r,o)),e.min=(r,o)=>e.check(Vt(r,o)),e.lt=(r,o)=>e.check(lr(r,o)),e.lte=(r,o)=>e.check(Wt(r,o)),e.max=(r,o)=>e.check(Wt(r,o)),e.int=r=>e.check(hr(r)),e.safe=r=>e.check(hr(r)),e.positive=r=>e.check(pr(0,r)),e.nonnegative=r=>e.check(Vt(0,r)),e.negative=r=>e.check(lr(0,r)),e.nonpositive=r=>e.check(Wt(0,r)),e.multipleOf=(r,o)=>e.check(dr(r,o)),e.step=(r,o)=>e.check(dr(r,o)),e.finite=()=>e;const n=e._zod.bag;e.minValue=Math.max(n.minimum??Number.NEGATIVE_INFINITY,n.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,e.maxValue=Math.min(n.maximum??Number.POSITIVE_INFINITY,n.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,e.isInt=(n.format??"").includes("int")||Number.isSafeInteger(n.multipleOf??.5),e.isFinite=!0,e.format=n.format??null});function S(e){return ic(fs,e)}const Cl=_("ZodNumberFormat",(e,t)=>{uu.init(e,t),fs.init(e,t)});function hr(e){return ac(Cl,e)}const Pl=_("ZodBoolean",(e,t)=>{cu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Jo(e,n,r)});function De(e){return uc(Pl,e)}const Nl=_("ZodAny",(e,t)=>{lu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Bo()});function z(){return cc(Nl)}const zl=_("ZodUnknown",(e,t)=>{pu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Go()});function gr(){return lc(zl)}const Dl=_("ZodNever",(e,t)=>{du.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>qo(e,n,r)});function $l(e){return pc(Dl,e)}const Rl=_("ZodArray",(e,t)=>{fu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Yo(e,n,r,o),e.element=t.element,e.min=(n,r)=>e.check(bt(n,r)),e.nonempty=n=>e.check(bt(1,n)),e.max=(n,r)=>e.check(jo(n,r)),e.length=(n,r)=>e.check(Fo(n,r)),e.unwrap=()=>e.element});function C(e,t){return Sc(Rl,e,t)}const Zl=_("ZodObject",(e,t)=>{hu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Xo(e,n,r,o),$(e,"shape",()=>t.shape),e.keyof=()=>G(Object.keys(e._zod.def.shape)),e.catchall=n=>e.clone({...e._zod.def,catchall:n}),e.passthrough=()=>e.clone({...e._zod.def,catchall:gr()}),e.loose=()=>e.clone({...e._zod.def,catchall:gr()}),e.strict=()=>e.clone({...e._zod.def,catchall:$l()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=n=>Di(e,n),e.safeExtend=n=>$i(e,n),e.merge=n=>Ri(e,n),e.pick=n=>Ni(e,n),e.omit=n=>zi(e,n),e.partial=(...n)=>Zi(hs,e,n[0]),e.required=(...n)=>Mi(gs,e,n[0])});function h(e,t){const n={type:"object",shape:e??{},...E(t)};return new Zl(n)}const ms=_("ZodUnion",(e,t)=>{Mo.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Qo(e,n,r,o),e.options=t.options});function de(e,t){return new ms({type:"union",options:e,...E(t)})}const Ml=_("ZodDiscriminatedUnion",(e,t)=>{ms.init(e,t),gu.init(e,t)});function H(e,t,n){return new Ml({type:"union",options:t,discriminator:e,...E(n)})}const jl=_("ZodIntersection",(e,t)=>{_u.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>es(e,n,r,o)});function Fl(e,t){return new jl({type:"intersection",left:e,right:t})}const Ll=_("ZodRecord",(e,t)=>{yu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>ts(e,n,r,o),e.keyType=t.keyType,e.valueType=t.valueType});function j(e,t,n){return new Ll({type:"record",keyType:e,valueType:t,...E(n)})}const cn=_("ZodEnum",(e,t)=>{vu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(r,o,s)=>Wo(e,r,o),e.enum=t.entries,e.options=Object.values(t.entries);const n=new Set(Object.keys(t.entries));e.extract=(r,o)=>{const s={};for(const i of r)if(n.has(i))s[i]=t.entries[i];else throw new Error(`Key ${i} not found in enum`);return new cn({...t,checks:[],...E(o),entries:s})},e.exclude=(r,o)=>{const s={...t.entries};for(const i of r)if(n.has(i))delete s[i];else throw new Error(`Key ${i} not found in enum`);return new cn({...t,checks:[],...E(o),entries:s})}});function G(e,t){const n=Array.isArray(e)?Object.fromEntries(e.map(r=>[r,r])):e;return new cn({type:"enum",entries:n,...E(t)})}const Ul=_("ZodLiteral",(e,t)=>{wu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Vo(e,n,r),e.values=new Set(t.values),Object.defineProperty(e,"value",{get(){if(t.values.length>1)throw new Error("This schema contains multiple valid literal values. Use `.values` instead.");return t.values[0]}})});function g(e,t){return new Ul({type:"literal",values:Array.isArray(e)?e:[e],...E(t)})}const Jl=_("ZodTransform",(e,t)=>{bu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Ko(e,n),e._zod.parse=(n,r)=>{if(r.direction==="backward")throw new wo(e.constructor.name);n.addIssue=s=>{if(typeof s=="string")n.issues.push(nt(s,n.value,t));else{const i=s;i.fatal&&(i.continue=!1),i.code??(i.code="custom"),i.input??(i.input=n.value),i.inst??(i.inst=e),n.issues.push(nt(i))}};const o=t.transform(n.value,n);return o instanceof Promise?o.then(s=>(n.value=s,n)):(n.value=o,n)}});function ql(e){return new Jl({type:"transform",transform:e})}const hs=_("ZodOptional",(e,t)=>{Iu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>cs(e,n,r,o),e.unwrap=()=>e._zod.def.innerType});function _r(e){return new hs({type:"optional",innerType:e})}const Bl=_("ZodNullable",(e,t)=>{Su.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>ns(e,n,r,o),e.unwrap=()=>e._zod.def.innerType});function yr(e){return new Bl({type:"nullable",innerType:e})}const Gl=_("ZodDefault",(e,t)=>{Tu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>os(e,n,r,o),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});function Wl(e,t){return new Gl({type:"default",innerType:e,get defaultValue(){return typeof t=="function"?t():To(t)}})}const Vl=_("ZodPrefault",(e,t)=>{Au.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>ss(e,n,r,o),e.unwrap=()=>e._zod.def.innerType});function Hl(e,t){return new Vl({type:"prefault",innerType:e,get defaultValue(){return typeof t=="function"?t():To(t)}})}const gs=_("ZodNonOptional",(e,t)=>{ku.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>rs(e,n,r,o),e.unwrap=()=>e._zod.def.innerType});function Kl(e,t){return new gs({type:"nonoptional",innerType:e,...E(t)})}const Yl=_("ZodCatch",(e,t)=>{xu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>is(e,n,r,o),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});function Xl(e,t){return new Yl({type:"catch",innerType:e,catchValue:typeof t=="function"?t:()=>t})}const Ql=_("ZodPipe",(e,t)=>{Eu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>as(e,n,r,o),e.in=t.in,e.out=t.out});function vr(e,t){return new Ql({type:"pipe",in:e,out:t})}const ep=_("ZodReadonly",(e,t)=>{Ou.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>us(e,n,r,o),e.unwrap=()=>e._zod.def.innerType});function tp(e){return new ep({type:"readonly",innerType:e})}const np=_("ZodLazy",(e,t)=>{Cu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>ls(e,n,r,o),e.unwrap=()=>e._zod.def.getter()});function rp(e){return new np({type:"lazy",getter:e})}const _s=_("ZodCustom",(e,t)=>{Pu.init(e,t),J.init(e,t),e._zod.processJSONSchema=(n,r,o)=>Ho(e,n)});function op(e,t={}){return Tc(_s,e,t)}function sp(e){return Ac(e)}function ys(e,t={error:`Input not instance of ${e.name}`}){const n=new _s({type:"custom",check:"custom",fn:r=>r instanceof e,abort:!0,...E(t)});return n._zod.bag.Class=e,n}function ip(e,t){const n={...e};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t,enumerable:!1}}),n}const ap=Symbol("Let zodToJsonSchema decide on which parser to use"),wr={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},up=e=>typeof e=="string"?{...wr,basePath:["#"],definitions:{},name:e}:{...wr,basePath:["#"],definitions:{},...e},ln=e=>"_def"in e?e._def:e;function cp(e){if(!e)return!0;for(const t in e)return!1;return!0}const lp=e=>{const t=up(e),n=t.name!==void 0?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map(([r,o])=>[ln(o),{def:ln(o),path:[...t.basePath,t.definitionPath,r],jsonSchema:void 0}]))}};function vs(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function Z(e,t,n,r,o){e[t]=n,vs(e,t,r,o)}var rt;(function(e){e.assertEqual=o=>{};function t(o){}e.assertIs=t;function n(o){throw new Error}e.assertNever=n,e.arrayToEnum=o=>{const s={};for(const i of o)s[i]=i;return s},e.getValidEnumValues=o=>{const s=e.objectKeys(o).filter(a=>typeof o[o[a]]!="number"),i={};for(const a of s)i[a]=o[a];return e.objectValues(i)},e.objectValues=o=>e.objectKeys(o).map(function(s){return o[s]}),e.objectKeys=typeof Object.keys=="function"?o=>Object.keys(o):o=>{const s=[];for(const i in o)Object.prototype.hasOwnProperty.call(o,i)&&s.push(i);return s},e.find=(o,s)=>{for(const i of o)if(s(i))return i},e.isInteger=typeof Number.isInteger=="function"?o=>Number.isInteger(o):o=>typeof o=="number"&&Number.isFinite(o)&&Math.floor(o)===o;function r(o,s=" | "){return o.map(i=>typeof i=="string"?`'${i}'`:i).join(s)}e.joinValues=r,e.jsonStringifyReplacer=(o,s)=>typeof s=="bigint"?s.toString():s})(rt||(rt={}));var br;(function(e){e.mergeShapes=(t,n)=>({...t,...n})})(br||(br={}));rt.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]);rt.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class kt extends Error{get errors(){return this.issues}constructor(t){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const n=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,n):this.__proto__=n,this.name="ZodError",this.issues=t}format(t){const n=t||function(s){return s.message},r={_errors:[]},o=s=>{for(const i of s.issues)if(i.code==="invalid_union")i.unionErrors.map(o);else if(i.code==="invalid_return_type")o(i.returnTypeError);else if(i.code==="invalid_arguments")o(i.argumentsError);else if(i.path.length===0)r._errors.push(n(i));else{let a=r,c=0;for(;c<i.path.length;){const u=i.path[c];c===i.path.length-1?(a[u]=a[u]||{_errors:[]},a[u]._errors.push(n(i))):a[u]=a[u]||{_errors:[]},a=a[u],c++}}};return o(this),r}static assert(t){if(!(t instanceof kt))throw new Error(`Not a ZodError: ${t}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,rt.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(t=n=>n.message){const n=Object.create(null),r=[];for(const o of this.issues)if(o.path.length>0){const s=o.path[0];n[s]=n[s]||[],n[s].push(t(o))}else r.push(t(o));return{formErrors:r,fieldErrors:n}}get formErrors(){return this.flatten()}}kt.create=e=>new kt(e);var Ir;(function(e){e.errToObj=t=>typeof t=="string"?{message:t}:t||{},e.toString=t=>typeof t=="string"?t:t?.message})(Ir||(Ir={}));var N;(function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"})(N||(N={}));function pp(){return{}}function dp(e,t){const n={type:"array"};return e.type?._def?.typeName!==N.ZodAny&&(n.items=R(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&Z(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&Z(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(Z(n,"minItems",e.exactLength.value,e.exactLength.message,t),Z(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}function fp(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":t.target==="jsonSchema7"?r.inclusive?Z(n,"minimum",r.value,r.message,t):Z(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),Z(n,"minimum",r.value,r.message,t));break;case"max":t.target==="jsonSchema7"?r.inclusive?Z(n,"maximum",r.value,r.message,t):Z(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),Z(n,"maximum",r.value,r.message,t));break;case"multipleOf":Z(n,"multipleOf",r.value,r.message,t);break}return n}function mp(){return{type:"boolean"}}function hp(e,t){return R(e.type._def,t)}const gp=(e,t)=>R(e.innerType._def,t);function ws(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((o,s)=>ws(e,t,o))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return _p(e,t)}}const _p=(e,t)=>{const n={type:"integer",format:"unix-time"};if(t.target==="openApi3")return n;for(const r of e.checks)switch(r.kind){case"min":Z(n,"minimum",r.value,r.message,t);break;case"max":Z(n,"maximum",r.value,r.message,t);break}return n};function yp(e,t){return{...R(e.innerType._def,t),default:e.defaultValue()}}function vp(e,t,n){return t.effectStrategy==="input"?R(e.schema._def,t,n):{}}function wp(e){return{type:"string",enum:[...e.values]}}const bp=e=>"type"in e&&e.type==="string"?!1:"allOf"in e;function Ip(e,t){const n=[R(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),R(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(s=>!!s);let r=t.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const o=[];return n.forEach(s=>{if(bp(s))o.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){const{additionalProperties:a,...c}=s;i=c}else r=void 0;o.push(i)}}),o.length?{allOf:o,...r}:void 0}function Sp(e,t){const n=typeof e.value;return n!=="bigint"&&n!=="number"&&n!=="boolean"&&n!=="string"?{type:Array.isArray(e.value)?"array":"object"}:t.target==="openApi3"?{type:n==="bigint"?"integer":n,enum:[e.value]}:{type:n==="bigint"?"integer":n,const:e.value}}let Ht;const Oe={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Ht===void 0&&(Ht=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Ht),base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function bs(e,t){const n={type:"string"};function r(o){return t.patternStrategy==="escape"?Tp(o):o}if(e.checks)for(const o of e.checks)switch(o.kind){case"min":Z(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,o.value):o.value,o.message,t);break;case"max":Z(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,o.value):o.value,o.message,t);break;case"email":switch(t.emailStrategy){case"format:email":ie(n,"email",o.message,t);break;case"format:idn-email":ie(n,"idn-email",o.message,t);break;case"pattern:zod":ae(n,Oe.email,o.message,t);break}break;case"url":ie(n,"uri",o.message,t);break;case"uuid":ie(n,"uuid",o.message,t);break;case"regex":ae(n,o.regex,o.message,t);break;case"cuid":ae(n,Oe.cuid,o.message,t);break;case"cuid2":ae(n,Oe.cuid2,o.message,t);break;case"startsWith":ae(n,RegExp(`^${r(o.value)}`),o.message,t);break;case"endsWith":ae(n,RegExp(`${r(o.value)}$`),o.message,t);break;case"datetime":ie(n,"date-time",o.message,t);break;case"date":ie(n,"date",o.message,t);break;case"time":ie(n,"time",o.message,t);break;case"duration":ie(n,"duration",o.message,t);break;case"length":Z(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,o.value):o.value,o.message,t),Z(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,o.value):o.value,o.message,t);break;case"includes":{ae(n,RegExp(r(o.value)),o.message,t);break}case"ip":{o.version!=="v6"&&ie(n,"ipv4",o.message,t),o.version!=="v4"&&ie(n,"ipv6",o.message,t);break}case"emoji":ae(n,Oe.emoji,o.message,t);break;case"ulid":{ae(n,Oe.ulid,o.message,t);break}case"base64":{switch(t.base64Strategy){case"format:binary":{ie(n,"binary",o.message,t);break}case"contentEncoding:base64":{Z(n,"contentEncoding","base64",o.message,t);break}case"pattern:zod":{ae(n,Oe.base64,o.message,t);break}}break}case"nanoid":ae(n,Oe.nanoid,o.message,t)}return n}const Tp=e=>Array.from(e).map(t=>/[a-zA-Z0-9]/.test(t)?t:`\\${t}`).join(""),ie=(e,t,n,r)=>{e.format||e.anyOf?.some(o=>o.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):Z(e,"format",t,n,r)},ae=(e,t,n,r)=>{e.pattern||e.allOf?.some(o=>o.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,Object.keys(e.errorMessage).length===0&&delete e.errorMessage)),e.allOf.push({pattern:Sr(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):Z(e,"pattern",Sr(t,r),n,r)},Sr=(e,t)=>{const n=typeof e=="function"?e():e;if(!t.applyRegexFlags||!n.flags)return n.source;const r={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},o=r.i?n.source.toLowerCase():n.source;let s="",i=!1,a=!1,c=!1;for(let u=0;u<o.length;u++){if(i){s+=o[u],i=!1;continue}if(r.i){if(a){if(o[u].match(/[a-z]/)){c?(s+=o[u],s+=`${o[u-2]}-${o[u]}`.toUpperCase(),c=!1):o[u+1]==="-"&&o[u+2]?.match(/[a-z]/)?(s+=o[u],c=!0):s+=`${o[u]}${o[u].toUpperCase()}`;continue}}else if(o[u].match(/[a-z]/)){s+=`[${o[u]}${o[u].toUpperCase()}]`;continue}}if(r.m){if(o[u]==="^"){s+=`(^|(?<=[\r
]))`;continue}else if(o[u]==="$"){s+=`($|(?=[\r
]))`;continue}}if(r.s&&o[u]==="."){s+=a?`${o[u]}\r
`:`[${o[u]}\r
]`;continue}s+=o[u],o[u]==="\\"?i=!0:a&&o[u]==="]"?a=!1:!a&&o[u]==="["&&(a=!0)}try{const u=new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return s};function Is(e,t){if(t.target==="openApi3"&&e.keyType?._def.typeName===N.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,o)=>({...r,[o]:R(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",o]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:R(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if(t.target==="openApi3")return n;if(e.keyType?._def.typeName===N.ZodString&&e.keyType._def.checks?.length){const r=Object.entries(bs(e.keyType._def,t)).reduce((o,[s,i])=>s==="type"?o:{...o,[s]:i},{});return{...n,propertyNames:r}}else if(e.keyType?._def.typeName===N.ZodEnum)return{...n,propertyNames:{enum:e.keyType._def.values}};return n}function Ap(e,t){if(t.mapStrategy==="record")return Is(e,t);const n=R(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},r=R(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[n,r],minItems:2,maxItems:2}}}function kp(e){const t=e.values,r=Object.keys(e.values).filter(s=>typeof t[t[s]]!="number").map(s=>t[s]),o=Array.from(new Set(r.map(s=>typeof s)));return{type:o.length===1?o[0]==="string"?"string":"number":["string","number"],enum:r}}function xp(){return{not:{}}}function Ep(e){return e.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const xt={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Op(e,t){if(t.target==="openApi3")return Tr(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every(r=>r._def.typeName in xt&&(!r._def.checks||!r._def.checks.length))){const r=n.reduce((o,s)=>{const i=xt[s._def.typeName];return i&&!o.includes(i)?[...o,i]:o},[]);return{type:r.length>1?r:r[0]}}else if(n.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){const r=n.reduce((o,s)=>{const i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...o,i];case"bigint":return[...o,"integer"];case"object":if(s._def.value===null)return[...o,"null"];default:return o}},[]);if(r.length===n.length){const o=r.filter((s,i,a)=>a.indexOf(s)===i);return{type:o.length>1?o:o[0],enum:n.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(n.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:n.reduce((r,o)=>[...r,...o._def.values.filter(s=>!r.includes(s))],[])};return Tr(e,t)}const Tr=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((r,o)=>R(r._def,{...t,currentPath:[...t.currentPath,"anyOf",`${o}`]})).filter(r=>!!r&&(!t.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return n.length?{anyOf:n}:void 0};function Cp(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return t.target==="openApi3"||t.nullableStrategy==="property"?{type:xt[e.innerType._def.typeName],nullable:!0}:{type:[xt[e.innerType._def.typeName],"null"]};if(t.target==="openApi3"){const r=R(e.innerType._def,{...t,currentPath:[...t.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const n=R(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}function Pp(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",vs(n,"type",r.message,t);break;case"min":t.target==="jsonSchema7"?r.inclusive?Z(n,"minimum",r.value,r.message,t):Z(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),Z(n,"minimum",r.value,r.message,t));break;case"max":t.target==="jsonSchema7"?r.inclusive?Z(n,"maximum",r.value,r.message,t):Z(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),Z(n,"maximum",r.value,r.message,t));break;case"multipleOf":Z(n,"multipleOf",r.value,r.message,t);break}return n}function Np(e,t){return t.removeAdditionalStrategy==="strict"?e.catchall._def.typeName==="ZodNever"?e.unknownKeys!=="strict":R(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:e.catchall._def.typeName==="ZodNever"?e.unknownKeys==="passthrough":R(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function zp(e,t){const n={type:"object",...Object.entries(e.shape()).reduce((r,[o,s])=>{if(s===void 0||s._def===void 0)return r;const i=[...t.currentPath,"properties",o],a=R(s._def,{...t,currentPath:i,propertyPath:i});if(a===void 0)return r;if(t.openaiStrictMode&&s.isOptional()&&!s.isNullable()&&typeof s._def?.defaultValue>"u")throw new Error(`Zod field at \`${i.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...r.properties,[o]:a},required:s.isOptional()&&!t.openaiStrictMode?r.required:[...r.required,o]}},{properties:{},required:[]}),additionalProperties:Np(e,t)};return n.required.length||delete n.required,n}const Dp=(e,t)=>{if(t.propertyPath&&t.currentPath.slice(0,t.propertyPath.length).toString()===t.propertyPath.toString())return R(e.innerType._def,{...t,currentPath:t.currentPath});const n=R(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}},$p=(e,t)=>{if(t.pipeStrategy==="input")return R(e.in._def,t);if(t.pipeStrategy==="output")return R(e.out._def,t);const n=R(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),r=R(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]});return{allOf:[n,r].filter(o=>o!==void 0)}};function Rp(e,t){return R(e.type._def,t)}function Zp(e,t){const r={type:"array",uniqueItems:!0,items:R(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&Z(r,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&Z(r,"maxItems",e.maxSize.value,e.maxSize.message,t),r}function Mp(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((n,r)=>R(n._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[]),additionalItems:R(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((n,r)=>R(n._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((n,r)=>r===void 0?n:[...n,r],[])}}function jp(){return{not:{}}}function Fp(){return{}}const Lp=(e,t)=>R(e.innerType._def,t);function R(e,t,n=!1){const r=t.seen.get(e);if(t.override){const i=t.override?.(e,t,r,n);if(i!==ap)return i}if(r&&!n){const i=Up(r,t);if(i!==void 0)return"$ref"in i&&t.seenRefs.add(i.$ref),i}const o={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,o);const s=qp(e,e.typeName,t,n);return s&&Bp(e,t,s),o.jsonSchema=s,s}const Up=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":const n=e.path.slice(t.basePath.length+1).join("_");return n!==t.name&&t.nameStrategy==="duplicate-ref"&&(t.definitions[n]=e.def),{$ref:[...t.basePath,t.definitionPath,n].join("/")};case"relative":return{$ref:Jp(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((r,o)=>t.currentPath[o]===r)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):t.$refStrategy==="seen"?{}:void 0}},Jp=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},qp=(e,t,n,r)=>{switch(t){case N.ZodString:return bs(e,n);case N.ZodNumber:return Pp(e,n);case N.ZodObject:return zp(e,n);case N.ZodBigInt:return fp(e,n);case N.ZodBoolean:return mp();case N.ZodDate:return ws(e,n);case N.ZodUndefined:return jp();case N.ZodNull:return Ep(n);case N.ZodArray:return dp(e,n);case N.ZodUnion:case N.ZodDiscriminatedUnion:return Op(e,n);case N.ZodIntersection:return Ip(e,n);case N.ZodTuple:return Mp(e,n);case N.ZodRecord:return Is(e,n);case N.ZodLiteral:return Sp(e,n);case N.ZodEnum:return wp(e);case N.ZodNativeEnum:return kp(e);case N.ZodNullable:return Cp(e,n);case N.ZodOptional:return Dp(e,n);case N.ZodMap:return Ap(e,n);case N.ZodSet:return Zp(e,n);case N.ZodLazy:return R(e.getter()._def,n);case N.ZodPromise:return Rp(e,n);case N.ZodNaN:case N.ZodNever:return xp();case N.ZodEffects:return vp(e,n,r);case N.ZodAny:return pp();case N.ZodUnknown:return Fp();case N.ZodDefault:return yp(e,n);case N.ZodBranded:return hp(e,n);case N.ZodReadonly:return Lp(e,n);case N.ZodCatch:return gp(e,n);case N.ZodPipeline:return $p(e,n);case N.ZodFunction:case N.ZodVoid:case N.ZodSymbol:return;default:return(o=>{})()}},Bp=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),Gp=(e,t)=>{const n=lp(t),r=typeof t=="string"?t:t?.nameStrategy==="title"?void 0:t?.name,o=R(e._def,r===void 0?n:{...n,currentPath:[...n.basePath,n.definitionPath,r]},!1)??{},s=typeof t=="object"&&t.name!==void 0&&t.nameStrategy==="title"?t.name:void 0;s!==void 0&&(o.title=s);const i=(()=>{if(cp(n.definitions))return;const c={},u=new Set;for(let l=0;l<500;l++){const d=Object.entries(n.definitions).filter(([f])=>!u.has(f));if(d.length===0)break;for(const[f,m]of d)c[f]=R(ln(m),{...n,currentPath:[...n.basePath,n.definitionPath,f]},!0)??{},u.add(f)}return c})(),a=r===void 0?i?{...o,[n.definitionPath]:i}:o:n.nameStrategy==="duplicate-ref"?{...o,...i||n.seenRefs.size?{[n.definitionPath]:{...i,...n.seenRefs.size?{[r]:o}:void 0}}:void 0}:{$ref:[...n.$refStrategy==="relative"?[]:n.basePath,n.definitionPath,r].join("/"),[n.definitionPath]:{...i,[r]:o}};return n.target==="jsonSchema7"?a.$schema="http://json-schema.org/draft-07/schema#":n.target==="jsonSchema2019-09"&&(a.$schema="https://json-schema.org/draft/2019-09/schema#"),a};function Wp(e,{parser:t,callback:n}){const r={...e};return Object.defineProperties(r,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:t,enumerable:!1},$callback:{value:n,enumerable:!1}}),r}function Vp(e){if(e.type!=="object")throw new Error(`Root schema must have type: 'object' but got type: ${e.type?`'${e.type}'`:"undefined"}`);const t=structuredClone(e);return _e(t,[],t)}function pn(e){if(typeof e=="boolean")return!1;if(e.type==="null")return!0;for(const t of e.oneOf??[])if(pn(t))return!0;for(const t of e.anyOf??[])if(pn(t))return!0;return!1}function _e(e,t,n){if(typeof e=="boolean")throw new TypeError(`Expected object schema but got boolean; path=${t.join("/")}`);if(!Pe(e))throw new TypeError(`Expected ${JSON.stringify(e)} to be an object; path=${t.join("/")}`);const r=e.$defs;if(Pe(r))for(const[f,m]of Object.entries(r))_e(m,[...t,"$defs",f],n);const o=e.definitions;if(Pe(o))for(const[f,m]of Object.entries(o))_e(m,[...t,"definitions",f],n);e.type==="object"&&!("additionalProperties"in e)&&(e.additionalProperties=!1);const i=e.required??[],a=e.properties;if(Pe(a)){for(const[f,m]of Object.entries(a))if(!pn(m)&&!i.includes(f))throw new Error(`Zod field at \`${[...t,"properties",f].join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);e.required=Object.keys(a),e.properties=Object.fromEntries(Object.entries(a).map(([f,m])=>[f,_e(m,[...t,"properties",f],n)]))}const c=e.items;Pe(c)&&(e.items=_e(c,[...t,"items"],n));const u=e.anyOf;Array.isArray(u)&&(e.anyOf=u.map((f,m)=>_e(f,[...t,"anyOf",String(m)],n)));const l=e.allOf;if(Array.isArray(l))if(l.length===1){const f=_e(l[0],[...t,"allOf","0"],n);Object.assign(e,f),delete e.allOf}else e.allOf=l.map((f,m)=>_e(f,[...t,"allOf",String(m)],n));e.default===null&&delete e.default;const d=e.$ref;if(d&&Kp(e,1)){if(typeof d!="string")throw new TypeError(`Received non-string $ref - ${d}; path=${t.join("/")}`);const f=Hp(n,d);if(typeof f=="boolean")throw new Error(`Expected \`$ref: ${d}\` to resolve to an object schema but got boolean`);if(!Pe(f))throw new Error(`Expected \`$ref: ${d}\` to resolve to an object but got ${JSON.stringify(f)}`);return Object.assign(e,{...f,...e}),delete e.$ref,_e(e,t,n)}return e}function Hp(e,t){if(!t.startsWith("#/"))throw new Error(`Unexpected $ref format ${JSON.stringify(t)}; Does not start with #/`);const n=t.slice(2).split("/");let r=e;for(const o of n){if(!Pe(r))throw new Error(`encountered non-object entry while resolving ${t} - ${JSON.stringify(r)}`);const s=r[o];if(s===void 0)throw new Error(`Key ${o} not found while resolving ${t}`);r=s}return r}function Pe(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}function Kp(e,t){let n=0;for(const r in e)if(n++,n>t)return!0;return!1}function Ss(e,t){return Gp(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function Ts(e){return Vp(qc(e,{target:"draft-7"}))}function As(e){return"_zod"in e}function Yp(e,t,n){return ip({type:"json_schema",...n,name:t,strict:!0,schema:As(e)?Ts(e):Ss(e,{name:t})},r=>e.parse(JSON.parse(r)))}function Xp(e){return Wp({type:"function",name:e.name,parameters:As(e.parameters)?Ts(e.parameters):Ss(e.parameters,{name:e.name}),strict:!0,...e.description?{description:e.description}:void 0},{callback:e.function,parser:t=>e.parameters.parse(JSON.parse(t))})}class xe extends Error{state;constructor(t,n){super(t),this.state=n}}class Qp extends xe{}class Ar extends xe{}class X extends xe{}class M extends xe{}class kr extends xe{error;constructor(t,n,r){super(t,r),this.error=n}}class ed extends xe{error;constructor(t,n,r){super(t,r),this.error=n}}class xr extends xe{result;constructor(t,n,r){super(t,r),this.result=n}}class dn extends xe{result;constructor(t,n,r){super(t,r),this.result=n}}function He(e){if(typeof e!="object"||e===null)return;const t=e;return t._zod?.def||t._def||t.def}function Zt(e){const t=He(e);if(!t)return;const n=typeof t.typeName=="string"&&t.typeName||typeof t.type=="string"&&t.type;if(typeof n!="string")return;const r=n.toLowerCase();return r.startsWith("zod")?r.slice(3):r}function $e(e){return He(e)?Zt(e)==="object":!1}function td(e){return typeof e=="object"&&e!==null&&"input"in e&&typeof e.input=="string"}const nd="http://json-schema.org/draft-07/schema#",rd=new Set(["optional"]),od=new Set(["brand","branded","catch","default","effects","pipeline","pipe","prefault","readonly","refinement","transform"]),Er={string:{type:"string"},number:{type:"number"},bigint:{type:"integer"},boolean:{type:"boolean"},date:{type:"string",format:"date-time"}};function ks(e){return typeof e=="object"&&e!==null&&e.type==="object"&&"properties"in e&&"additionalProperties"in e}function sd(e){const t=xs(e);if(t)return Array.isArray(t.required)||(t.required=[]),typeof t.additionalProperties>"u"&&(t.additionalProperties=!1),typeof t.$schema!="string"&&(t.$schema=nd),t}function xs(e){const t=_d(e);if(!t)return;const n={},r=[];for(const[o,s]of Object.entries(t)){const{schema:i,optional:a}=id(s);if(!i)return;n[o]=i,a||r.push(o)}return{type:"object",properties:n,required:r,additionalProperties:!1}}function id(e){let t=fn(e),n=!1;for(;rd.has(Zt(t)??"");){n=!0;const r=He(t),o=fn(r?.innerType);if(!o||o===t)break;t=o}return{schema:fe(t),optional:n}}function fe(e){if(e===void 0)return;const t=fn(e),n=Zt(t),r=He(t);if(n){if(n in Er)return Er[n];switch(n){case"object":return xs(t);case"array":return ad(r);case"tuple":return ud(r);case"union":return cd(r);case"intersection":return ld(r);case"literal":return hd(r);case"enum":case"nativeenum":return gd(r);case"record":return pd(r);case"map":return dd(r);case"set":return fd(r);case"nullable":return md(r);default:return}}}function ad(e){const t=fe(Es(e,"element","items","type"));return t?{type:"array",items:t}:void 0}function ud(e){const t=Os(e?.items).map(r=>fe(r)).filter(Boolean);if(!t.length)return;const n={type:"array",items:t,minItems:t.length};return e?.rest||(n.maxItems=t.length),n}function cd(e){const t=Os(e?.options??e?.schemas).map(n=>fe(n)).filter(Boolean);return t.length?{anyOf:t}:void 0}function ld(e){const t=fe(e?.left),n=fe(e?.right);return t&&n?{allOf:[t,n]}:void 0}function pd(e){const t=fe(e?.valueType??e?.values);return t?{type:"object",additionalProperties:t}:void 0}function dd(e){const t=fe(e?.valueType??e?.values);return t?{type:"array",items:t}:void 0}function fd(e){const t=fe(e?.valueType);return t?{type:"array",items:t,uniqueItems:!0}:void 0}function md(e){const t=fe(e?.innerType??e?.type);return t?{anyOf:[t,{type:"null"}]}:void 0}function fn(e){let t=e;for(;od.has(Zt(t)??"");){const n=He(t),r=n?.innerType??n?.schema??n?.base??n?.type??n?.wrapped??n?.underlying;if(!r||r===t)return t;t=r}return t}function Es(e,...t){if(e){for(const n of t)if(n in e&&e[n]!==void 0)return e[n]}}function Os(e){return Array.isArray(e)?e:e===void 0?[]:[e]}function hd(e){if(!e)return;const t=Es(e,"value","literal");if(t!==void 0)return{const:t,type:t===null?"null":typeof t}}function gd(e){if(e){if(Array.isArray(e.values))return{enum:e.values};if(Array.isArray(e.options))return{enum:e.options};if(e.values&&typeof e.values=="object")return{enum:Object.values(e.values)};if(e.enum&&typeof e.enum=="object")return{enum:Object.values(e.enum)}}}function _d(e){if(typeof e!="object"||e===null)return;const t=e;if(t.shape&&typeof t.shape=="object")return t.shape;if(typeof t.shape=="function")try{return t.shape()}catch{return}const r=He(t)?.shape;if(r&&typeof r=="object")return r;if(typeof r=="function")try{return r()}catch{return}}const yd=Xp,vd=Yp;function Cs(e){return sd(e)}function Et(e){if(e=e.replace(/\s/g,"_"),e=e.replace(/[^a-zA-Z0-9]/g,"_"),e.length===0)throw new Error("Tool name cannot be empty");return e}function Cn(e,t){const n=r=>JSON.parse(r);if($e(e)){const r=s=>{const i=Cs(e);if(i)return{schema:i,parser:c=>e.parse(JSON.parse(c))};const a=s instanceof Error?` Upstream helper error: ${s.message}`:"";throw new M(`Unable to convert the provided Zod schema to JSON Schema. Ensure that the \`zod\` package is available at runtime or provide a JSON schema object instead.${a}`)};let o;try{o=yd({name:t,parameters:e,function:()=>{},description:""})}catch(s){return r(s)}return ks(o.parameters)?{schema:o.parameters,parser:o.$parseRaw}:r()}else if(typeof e=="object"&&e!==null)return{schema:e,parser:n};throw new M("Input type is not a ZodObject or a valid JSON schema")}function Or(e){if(e==="text")return"text";if($e(e)){const t=(r,o)=>{const s=Cs(e);if(s)return{type:r?.type??"json_schema",name:r?.name??"output",strict:r?.strict??!1,schema:s};const i=o instanceof Error?` Upstream helper error: ${o.message}`:"";throw new M(`Unable to convert the provided Zod schema to JSON Schema. Ensure that the \`zod\` package is available at runtime or provide a JSON schema object instead.${i}`)};let n;try{n=vd(e,"output")}catch(r){return t(void 0,r)}return ks(n.schema)?{type:n.type,name:n.name,strict:n.strict||!1,schema:n.schema}:t(n)}return e}function wd(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var ht={exports:{}},Kt,Cr;function bd(){if(Cr)return Kt;Cr=1;var e=1e3,t=e*60,n=t*60,r=n*24,o=r*7,s=r*365.25;Kt=function(l,d){d=d||{};var f=typeof l;if(f==="string"&&l.length>0)return i(l);if(f==="number"&&isFinite(l))return d.long?c(l):a(l);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(l))};function i(l){if(l=String(l),!(l.length>100)){var d=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(l);if(d){var f=parseFloat(d[1]),m=(d[2]||"ms").toLowerCase();switch(m){case"years":case"year":case"yrs":case"yr":case"y":return f*s;case"weeks":case"week":case"w":return f*o;case"days":case"day":case"d":return f*r;case"hours":case"hour":case"hrs":case"hr":case"h":return f*n;case"minutes":case"minute":case"mins":case"min":case"m":return f*t;case"seconds":case"second":case"secs":case"sec":case"s":return f*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return f;default:return}}}}function a(l){var d=Math.abs(l);return d>=r?Math.round(l/r)+"d":d>=n?Math.round(l/n)+"h":d>=t?Math.round(l/t)+"m":d>=e?Math.round(l/e)+"s":l+"ms"}function c(l){var d=Math.abs(l);return d>=r?u(l,d,r,"day"):d>=n?u(l,d,n,"hour"):d>=t?u(l,d,t,"minute"):d>=e?u(l,d,e,"second"):l+" ms"}function u(l,d,f,m){var w=d>=f*1.5;return Math.round(l/f)+" "+m+(w?"s":"")}return Kt}var Yt,Pr;function Id(){if(Pr)return Yt;Pr=1;function e(t){r.debug=r,r.default=r,r.coerce=u,r.disable=a,r.enable=s,r.enabled=c,r.humanize=bd(),r.destroy=l,Object.keys(t).forEach(d=>{r[d]=t[d]}),r.names=[],r.skips=[],r.formatters={};function n(d){let f=0;for(let m=0;m<d.length;m++)f=(f<<5)-f+d.charCodeAt(m),f|=0;return r.colors[Math.abs(f)%r.colors.length]}r.selectColor=n;function r(d){let f,m=null,w,b;function v(...A){if(!v.enabled)return;const y=v,x=Number(new Date),T=x-(f||x);y.diff=T,y.prev=f,y.curr=x,f=x,A[0]=r.coerce(A[0]),typeof A[0]!="string"&&A.unshift("%O");let I=0;A[0]=A[0].replace(/%([a-zA-Z%])/g,(P,D)=>{if(P==="%%")return"%";I++;const q=r.formatters[D];if(typeof q=="function"){const be=A[I];P=q.call(y,be),A.splice(I,1),I--}return P}),r.formatArgs.call(y,A),(y.log||r.log).apply(y,A)}return v.namespace=d,v.useColors=r.useColors(),v.color=r.selectColor(d),v.extend=o,v.destroy=r.destroy,Object.defineProperty(v,"enabled",{enumerable:!0,configurable:!1,get:()=>m!==null?m:(w!==r.namespaces&&(w=r.namespaces,b=r.enabled(d)),b),set:A=>{m=A}}),typeof r.init=="function"&&r.init(v),v}function o(d,f){const m=r(this.namespace+(typeof f>"u"?":":f)+d);return m.log=this.log,m}function s(d){r.save(d),r.namespaces=d,r.names=[],r.skips=[];const f=(typeof d=="string"?d:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const m of f)m[0]==="-"?r.skips.push(m.slice(1)):r.names.push(m)}function i(d,f){let m=0,w=0,b=-1,v=0;for(;m<d.length;)if(w<f.length&&(f[w]===d[m]||f[w]==="*"))f[w]==="*"?(b=w,v=m,w++):(m++,w++);else if(b!==-1)w=b+1,v++,m=v;else return!1;for(;w<f.length&&f[w]==="*";)w++;return w===f.length}function a(){const d=[...r.names,...r.skips.map(f=>"-"+f)].join(",");return r.enable(""),d}function c(d){for(const f of r.skips)if(i(d,f))return!1;for(const f of r.names)if(i(d,f))return!0;return!1}function u(d){return d instanceof Error?d.stack||d.message:d}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return r.enable(r.load()),r}return Yt=e,Yt}var Nr;function Sd(){return Nr||(Nr=1,(function(e,t){var n={};t.formatArgs=o,t.save=s,t.load=i,t.useColors=r,t.storage=a(),t.destroy=(()=>{let u=!1;return()=>{u||(u=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let u;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(u=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(u[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function o(u){if(u[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+u[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const l="color: "+this.color;u.splice(1,0,l,"color: inherit");let d=0,f=0;u[0].replace(/%[a-zA-Z%]/g,m=>{m!=="%%"&&(d++,m==="%c"&&(f=d))}),u.splice(f,0,l)}t.log=console.debug||console.log||(()=>{});function s(u){try{u?t.storage.setItem("debug",u):t.storage.removeItem("debug")}catch{}}function i(){let u;try{u=t.storage.getItem("debug")||t.storage.getItem("DEBUG")}catch{}return!u&&typeof process<"u"&&"env"in process&&(u=n.DEBUG),u}function a(){try{return localStorage}catch{}}e.exports=Id()(t);const{formatters:c}=e.exports;c.j=function(u){try{return JSON.stringify(u)}catch(l){return"[UnexpectedJSONParseError]: "+l.message}}})(ht,ht.exports)),ht.exports}var Td=Sd();const Ad=wd(Td);function Ps(){return Rd()}function zr(e){const t=Ps();return typeof t<"u"&&(t[e]==="true"||t[e]==="1")}const Ns={get disabled(){return!0}},zs={get dontLogModelData(){return zr("OPENAI_AGENTS_DONT_LOG_MODEL_DATA")},get dontLogToolData(){return zr("OPENAI_AGENTS_DONT_LOG_TOOL_DATA")}},kd=zs.dontLogModelData,xd=zs.dontLogToolData;function Ds(e="openai-agents"){return{namespace:e,debug:Ad(e),error:console.error,warn:console.warn,dontLogModelData:kd,dontLogToolData:xd}}const k=Ds("openai-agents:core"),Dr=20;function Ae(e){if(e==null)return String(e);if($s(e))return et(new Uint8Array(e));if(ct(e)){const t=e;return et(new Uint8Array(t.buffer,t.byteOffset,t.byteLength))}if(typeof e=="string")return e;if(typeof e=="object")try{return JSON.stringify(e,Od)}catch{return"[object with circular references]"}return String(e)}function $s(e){if(e instanceof ArrayBuffer)return!0;const t=globalThis.SharedArrayBuffer;return!!(t&&e instanceof t)}function ct(e){return typeof ArrayBuffer<"u"&&ArrayBuffer.isView(e)}function Mt(e){return typeof e=="object"&&e!==null&&e.type==="Buffer"&&Array.isArray(e.data)}function Pn(e){const t=globalThis.Buffer;return!!(t&&typeof t.isBuffer=="function"&&t.isBuffer(e))}function et(e){if(e.length===0)return"[byte array (0 bytes)]";const t=Math.min(e.length,Dr),n=[];for(let s=0;s<t;s++)n.push(Ed(e[s]));const r=e.length>Dr?" ":"";return`[byte array ${n.join(" ")}${r} (${e.length} bytes)]`}function Ed(e){return`0x${e.toString(16).padStart(2,"0")}`}function Od(e,t){if($s(t))return et(new Uint8Array(t));if(ct(t)){const n=t;return et(new Uint8Array(n.buffer,n.byteOffset,n.byteLength))}return Mt(t)?et(Uint8Array.from(t.data)):t}function mn(e){return!!e&&typeof e=="object"&&typeof e.create=="function"}const hn=new WeakMap,Cd=new WeakMap,Ot=new WeakMap;function Rs(e){const t=Cd.get(e);if(t)return t;if(typeof e.computer=="function"||mn(e.computer))return e.computer}function $r(e,t,n){let r=Ot.get(t);r||(r=new Map,Ot.set(t,r)),r.set(e,n)}async function Zs(e){const{tool:t,runContext:n}=e,r=t;let o=hn.get(r);o||(o=new WeakMap,hn.set(r,o));const s=o.get(n);if(s)return $r(t,n,s),s.computer;const i=Rs(t),a=i&&mn(i)?i:mn(t.computer)?t.computer:void 0,c=typeof i=="function"?i:a?.create??(typeof t.computer=="function"?t.computer:void 0),u=a?.dispose,l=c&&typeof c=="function"?await c({runContext:n}):t.computer;if(!l)throw new M("The computer tool did not provide a computer instance.");const d={computer:l,dispose:u};return o.set(n,d),$r(t,n,d),t.computer=l,l}async function Rr({runContext:e}){const t=Ot.get(e);if(!t)return;Ot.delete(e);const n=[];for(const[r,o]of t.entries()){hn.get(r)?.delete(e);const i=Rs(r);i&&(r.computer=i),o.dispose&&n.push(async()=>{await o.dispose?.({runContext:e,computer:o.computer})})}for(const r of n)try{await r()}catch(o){k.warn(`Failed to dispose computer for run context: ${o}`)}}function Pd(e,t){return`An error occurred while running the tool. Please try again. Error: ${t instanceof Error?t.toString():String(t)}`}function gn(e){const t=e.name?Et(e.name):Et(e.execute.name),n=typeof e.errorFunction>"u"?Pd:e.errorFunction;if(!t)throw new Error("Tool name cannot be empty. Either name your function or provide a name in the options.");const r=e.strict??!0;if(!r&&$e(e.parameters))throw new M("Strict mode is required for Zod parameters");const{parser:o,schema:s}=Cn(e.parameters,t);async function i(l,d,f){const[m,w]=await Sn(()=>o(d));if(m!==null)throw k.dontLogToolData?k.debug(`Invalid JSON input for tool ${t}`):k.debug(`Invalid JSON input for tool ${t}: ${d}`),new X("Invalid JSON input for tool");k.dontLogToolData?k.debug(`Invoking tool ${t}`):k.debug(`Invoking tool ${t} with input ${d}`);const b=await e.execute(w,l,f),v=Ae(b);return k.dontLogToolData?k.debug(`Tool ${t} completed`):k.debug(`Tool ${t} returned: ${v}`),b}async function a(l,d,f){return i(l,d,f).catch(m=>{if(n)return it()?.setError({message:"Error running tool (non-fatal)",data:{tool_name:t,error:m.toString()}}),n(l,m);throw m})}const c=typeof e.needsApproval=="function"?e.needsApproval:async()=>typeof e.needsApproval=="boolean"?e.needsApproval:!1,u=typeof e.isEnabled=="function"?async(l,d)=>{const f=e.isEnabled;return!!await f({runContext:l,agent:d})}:async()=>typeof e.isEnabled=="boolean"?e.isEnabled:!0;return{type:"function",name:t,description:e.description,parameters:s,strict:r,invoke:a,needsApproval:c,isEnabled:u}}h({name:p(),description:p().optional(),inputSchema:h({type:g("object"),properties:j(p(),z()),required:C(p()),additionalProperties:De()})});const Xt={},Qt={},Nd=({server:e,agent:t})=>e.toolFilter&&typeof e.toolFilter=="function"&&t?`${e.name}:${t.name}`:e.name;async function zd({server:e,convertSchemasToStrict:t,runContext:n,agent:r,generateMCPToolCacheKey:o}){const s=(o||Nd)({server:e,agent:r,runContext:n});if(e.cacheToolsList&&Xt[s])return Xt[s].map(a=>Zr(a,e,t));const i=async a=>{const c=await e.listTools();let u=c;if(n&&r){const d={runContext:n,agent:r,serverName:e.name},f=[];for(const m of c){const w=e.toolFilter;if(w)if(typeof w=="function"){if(!await w(d,m)){k.debug(`MCP Tool (server: ${e.name}, tool: ${m.name}) is blocked by the callable filter.`);continue}}else{const b=w.allowedToolNames??[],v=w.blockedToolNames??[];if(b.length>0||v.length>0){const A=b.length>0?b.includes(m.name):!0,y=v.length>0?v.includes(m.name):!1;if(!A||y){y?k.debug(`MCP Tool (server: ${e.name}, tool: ${m.name}) is blocked by the static filter.`):A||k.debug(`MCP Tool (server: ${e.name}, tool: ${m.name}) is not allowed by the static filter.`);continue}}}f.push(m)}u=f}a&&(a.spanData.result=u.map(d=>d.name));const l=u.map(d=>Zr(d,e,t));return e.cacheToolsList&&(Xt[s]=u,Qt[e.name]||(Qt[e.name]=new Set),Qt[e.name].add(s)),l};return We()?Wf(i,{data:{server:e.name}}):i()}async function Dd(e,t,n,r=!1){const o=Array.isArray(e)?{mcpServers:e,runContext:t,agent:n,convertSchemasToStrict:r}:e,{mcpServers:s,convertSchemasToStrict:i=!1,runContext:a,agent:c,generateMCPToolCacheKey:u}=o,l=[],d=new Set;for(const f of s){const m=await zd({server:f,convertSchemasToStrict:i,runContext:a,agent:c,generateMCPToolCacheKey:u}),b=[...new Set(m.map(v=>v.name))].filter(v=>d.has(v));if(b.length>0)throw new M(`Duplicate tool names found across MCP servers: ${b.join(", ")}`);for(const v of m)d.add(v.name),l.push(v)}return l}function Zr(e,t,n){async function r(i,a){let c={};typeof i=="string"&&i?c=JSON.parse(i):typeof i=="object"&&i!=null&&(c=i);const u=it();u&&(u.spanData.mcp_data={server:t.name});const l=await t.callTool(e.name,c);return l.length===1?l[0]:l}const o={...e.inputSchema,type:e.inputSchema?.type??"object",properties:e.inputSchema?.properties??{},required:e.inputSchema?.required??[],additionalProperties:e.inputSchema?.additionalProperties??!1};if(n||o.additionalProperties===!0)try{const i=$d(o);return gn({name:e.name,description:e.description||"",parameters:i,strict:!0,execute:r})}catch(i){k.warn(`Error converting MCP schema to strict mode: ${i}`)}const s={...o,additionalProperties:!0};return gn({name:e.name,description:e.description||"",parameters:s,strict:!1,execute:r})}function $d(e){const t={...e,additionalProperties:!1};return t.required||(t.required=[]),t}function Rd(){return{}}class jt{#e=new EventTarget;#t=new Map;on(t,n){const r=t;let o=this.#t.get(r);o||(o=new Map,this.#t.set(r,o));let s=o.get(n);s||(s=new Set,o.set(n,s));const i=(a=>n(...a.detail??[]));return s.add(i),this.#e.addEventListener(r,i),this}off(t,n){const r=t,o=this.#t.get(r),s=o?.get(n);if(s?.size){for(const i of s)this.#e.removeEventListener(r,i);o?.delete(n),o?.size===0&&this.#t.delete(r)}return this}emit(t,...n){const r=new CustomEvent(t,{detail:n});return this.#e.dispatchEvent(r)}once(t,n){const r=(...o)=>{this.off(t,r),n(...o)};return this.on(t,r),this}}const Ms=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)}),Zd=class{constructor(){}pipeTo(t,n){}pipeThrough(t,n){}},Md=globalThis.ReadableStream,jd=globalThis.TransformStream;class Fd{context=null;constructor(){}run(t,n){return this.context=t,n()}getStore(){return this.context}enterWith(t){this.context=t}}class Ld{constructor(){}setTimeout(t,n){const r=setTimeout(t,n);return r.ref=typeof r.ref=="function"?r.ref:()=>r,r.unref=typeof r.unref=="function"?r.unref:()=>r,r.hasRef=typeof r.hasRef=="function"?r.hasRef:()=>!0,r.refresh=typeof r.refresh=="function"?r.refresh:()=>r,r}clearTimeout(t){window.clearTimeout(t)}}const Ud=new Ld;class Nn{on(t,n){return this.eventEmitter.on(t,n),this.eventEmitter}off(t,n){return this.eventEmitter.off(t,n),this.eventEmitter}emit(t,...n){return this.eventEmitter.emit(t,...n)}once(t,n){return this.eventEmitter.once(t,n),this.eventEmitter}}class Jd extends Nn{eventEmitter=new jt}class qd extends Nn{eventEmitter=new jt}const Bd="OPENAI_DEFAULT_MODEL";function Ft(e){return e.startsWith("gpt-5-chat")?!1:e.startsWith("gpt-5")}function js(){return Ft(Fs())}function Fs(){return Ps()[Bd]?.toLowerCase()??"gpt-4.1"}function Gd(e){const t=Fs();return Ft(t)?{reasoning:{effort:"low"},text:{verbosity:"low"}}:{}}function Ls(e){return JSON.stringify({assistant:e.name})}function Wd(e){return`transfer_to_${Et(e.name)}`}function Vd(e){return`Handoff to the ${e.name} agent to handle the request. ${e.handoffDescription??""}`}class Us{toolName;toolDescription;inputJsonSchema={type:"object",properties:{},required:[],additionalProperties:!1};strictJsonSchema=!0;onInvokeHandoff;agentName;inputFilter;agent;getHandoffAsFunctionTool(){return{type:"function",name:this.toolName,description:this.toolDescription,parameters:this.inputJsonSchema,strict:this.strictJsonSchema}}isEnabled=async()=>!0;constructor(t,n){this.agentName=t.name,this.onInvokeHandoff=n,this.toolName=Wd(t),this.toolDescription=Vd(t),this.agent=t}}function Js(e,t={}){let n;const r=!!t.onHandoff,o=!!t.inputType;if(!(r===o))throw new M("You must provide either both `onHandoff` and `inputType` or neither.");async function i(c,u){if(n){if(!u)throw we({message:`Handoff function expected non empty input but got: ${u}`,data:{details:"input is empty"}}),new X("Handoff function expected non empty input");try{const l=await n(u);t.onHandoff&&await t.onHandoff(c,l)}catch(l){throw we({message:"Invalid JSON provided",data:{}}),k.dontLogToolData||k.error(`Invalid JSON when parsing: ${u}. Error: ${l}`),new X("Invalid JSON provided")}}else await t.onHandoff?.(c);return e}const a=new Us(e,i);if(typeof t.isEnabled=="function"){const c=t.isEnabled;a.isEnabled=async({runContext:u,agent:l})=>!!await c({runContext:u,agent:l})}else typeof t.isEnabled=="boolean"&&(a.isEnabled=async()=>t.isEnabled);if(t.inputType){const c=Cn(t.inputType,a.toolName);a.inputJsonSchema=c.schema,a.strictJsonSchema=!0,n=c.parser}return t.toolNameOverride&&(a.toolName=t.toolNameOverride),t.toolDescriptionOverride&&(a.toolDescription=t.toolDescriptionOverride),t.inputFilter&&(a.inputFilter=t.inputFilter),a}function Hd(e){return e instanceof Us?e:Js(e)}function qs(e){if(e.type!=="message"||e.role!=="assistant")return;const t=e.content[e.content.length-1];if(t.type==="output_text")return t.text}function Kd(e){return e.output.length===0?"":qs(e.output[e.output.length-1])||""}const _n=new WeakMap;function Yd(e,t){e&&_n.set(e,t)}function Xd(e){const t=_n.get(e);return t&&_n.delete(e),t}const Qd=h({input:p()});class ue extends Jd{static create(t){return new ue({...t,handoffs:t.handoffs,outputType:t.outputType,handoffOutputTypeWarningEnabled:!1})}static DEFAULT_MODEL_PLACEHOLDER="";name;instructions;prompt;handoffDescription;handoffs;model;modelSettings;tools;mcpServers;inputGuardrails;outputGuardrails;outputType="text";toolUseBehavior;resetToolChoice;_toolsExplicitlyConfigured;constructor(t){if(super(),typeof t.name!="string"||t.name.trim()==="")throw new M("Agent must have a name.");if(this.name=t.name,this.instructions=t.instructions??ue.DEFAULT_MODEL_PLACEHOLDER,this.prompt=t.prompt,this.handoffDescription=t.handoffDescription??"",this.handoffs=t.handoffs??[],this.model=t.model??"",this.modelSettings=t.modelSettings??Gd(),this.tools=t.tools??[],this._toolsExplicitlyConfigured=t.tools!==void 0,this.mcpServers=t.mcpServers??[],this.inputGuardrails=t.inputGuardrails??[],this.outputGuardrails=t.outputGuardrails??[],t.outputType&&(this.outputType=t.outputType),this.toolUseBehavior=t.toolUseBehavior??"run_llm_again",this.resetToolChoice=t.resetToolChoice??!0,t.model!==void 0&&js()&&(typeof t.model!="string"||!Ft(t.model))&&t.modelSettings===void 0&&(this.modelSettings={}),(t.handoffOutputTypeWarningEnabled===void 0||t.handoffOutputTypeWarningEnabled)&&this.handoffs&&this.outputType){const n=new Set([JSON.stringify(this.outputType)]);for(const r of this.handoffs)"outputType"in r&&r.outputType?n.add(JSON.stringify(r.outputType)):"agent"in r&&r.agent.outputType&&n.add(JSON.stringify(r.agent.outputType));n.size>1&&k.warn(`[Agent] Warning: Handoff agents have different output types: ${Array.from(n).join(", ")}. You can make it type-safe by using Agent.create({ ... }) method instead.`)}}get outputSchemaName(){if(this.outputType==="text")return"text";if($e(this.outputType))return"ZodOutput";if(typeof this.outputType=="object")return this.outputType.name;throw new Error(`Unknown output type: ${this.outputType}`)}clone(t){return new ue({...this,...t})}asTool(t){const{toolName:n,toolDescription:r,customOutputExtractor:o,needsApproval:s,runConfig:i,runOptions:a,isEnabled:c,onStream:u}=t,l=new Map,d=async w=>{const b=l.get(w.event.type),v=l.get("*"),A=[...u?[u]:[],...b?Array.from(b):[],...v?Array.from(v):[]];await Promise.allSettled(A.map(y=>Promise.resolve().then(()=>y(w))))},m={...gn({name:n??Et(this.name),description:r??"",parameters:Qd,strict:!0,needsApproval:s,isEnabled:c,execute:async(w,b,v)=>{if(!td(w))throw new X("Agent tool called with invalid input");const A=new Nm(i??{}),y=typeof u=="function"||l.size>0,x=y?await A.run(this,w.input,{context:b,...a??{},stream:!0}):await A.run(this,w.input,{context:b,...a??{}}),T={agent:this,toolCall:v?.toolCall};if(y){const D=x;for await(const q of D)await d({event:q,...T});await D.completed}const I=x,O=typeof this.toolUseBehavior=="object"&&this.toolUseBehavior!==null&&"stopAtToolNames"in this.toolUseBehavior;typeof o!="function"&&O&&k.debug(`You're passing the agent (name: ${this.name}) with toolUseBehavior.stopAtToolNames configured as a tool to a different agent; this may not work as you expect. You may want to have a wrapper function tool to consistently return the final output.`);const P=typeof o=="function"?await o(I):Kd(I.rawResponses[I.rawResponses.length-1]);return v?.toolCall&&Yd(v.toolCall,I),P}}),on:(w,b)=>{const v=l.get(w)??new Set;return v.add(b),l.set(w,v),m}};return m}async getSystemPrompt(t){return typeof this.instructions=="function"?await this.instructions(t,this):this.instructions}async getPrompt(t){return typeof this.prompt=="function"?await this.prompt(t,this):this.prompt}async getMcpTools(t){return this.mcpServers.length>0?Dd({mcpServers:this.mcpServers,runContext:t,agent:this,convertSchemasToStrict:!1}):[]}async getAllTools(t){const n=await this.getMcpTools(t),r=[];for(const o of this.tools){if(o.type==="function"){const s=o.isEnabled;if(!(typeof s=="function"?await s(t,this):typeof s=="boolean"?s:!0))continue}r.push(o)}return[...n,...r]}hasExplicitToolConfig(){return this._toolsExplicitlyConfigured}async getEnabledHandoffs(t){const n=this.handoffs?.map(o=>Hd(o))??[],r=[];for(const o of n)await o.isEnabled({runContext:t,agent:this})&&r.push(o);return r}processFinalOutput(t){if(this.outputType==="text")return t;if(typeof this.outputType=="object"){const n=JSON.parse(t);return $e(this.outputType)?this.outputType.parse(n):n}throw new Error(`Unknown output type: ${this.outputType}`)}toJSON(){return{name:this.name}}}function Mr({name:e,execute:t,runInParallel:n=!0}){return{type:"input",name:e,runInParallel:n,guardrailFunction:t,async run(r){return{guardrail:{type:"input",name:e},output:await t(r)}}}}function yn({name:e,execute:t}){return{type:"output",name:e,guardrailFunction:t,async run(n){return{guardrail:{type:"output",name:e},agent:n.agent,agentOutput:n.agentOutput,output:await t(n)}}}}function ef(){throw new Error("No default model provider set. Make sure to set a provider using setDefaultModelProvider before calling getDefaultModelProvider or pass an explicit provider.")}const W=h({providerData:j(p(),z()).optional()}),oe=W.extend({id:p().optional()}),tf=W.extend({type:g("refusal"),refusal:p()}),nf=W.extend({type:g("output_text"),text:p()}),zn=W.extend({type:g("input_text"),text:p()}),rf=W.extend({type:g("reasoning_text"),text:p()}),Bs=W.extend({type:g("input_image"),image:p().or(h({id:p().describe("OpenAI file ID")})).describe("Either base64 encoded image data, a data URL, or an object with a file ID.").optional(),detail:p().optional()}),Gs=W.extend({type:g("input_file"),file:p().describe("Either base64 encoded file data or a publicly accessible file URL").or(h({id:p().describe("OpenAI file ID")})).or(h({url:p().describe("Publicly accessible file URL")})).describe("Contents of the file or an object with a file ID.").optional(),filename:p().optional()}),Ws=W.extend({type:g("audio"),audio:p().or(h({id:p()})).describe("Base64 encoded audio data or file id"),format:p().nullable().optional(),transcript:p().nullable().optional()}),of=W.extend({type:g("image"),image:p().describe("Base64 encoded image data")}),sf=W.extend({type:g("text"),text:p()}),af=h({data:de([p(),ys(Uint8Array)]).describe("Base64 image data, or raw bytes that will be base64 encoded automatically."),mediaType:p().optional()}),uf=h({url:p().describe("Publicly accessible URL pointing to the image content")}),cf=h({fileId:p().describe("OpenAI file ID referencing uploaded image content")}),lf=de([af,uf,cf]).describe("Inline image data or references to uploaded content."),pf=h({data:de([p(),ys(Uint8Array)]).describe("Base64 encoded file data, or raw bytes that will be encoded automatically."),mediaType:p().describe("IANA media type describing the file contents"),filename:p().describe("Filename associated with the inline data")}),df=h({url:p().describe("Publicly accessible URL for the file content"),filename:p().optional()}),ff=h({id:p().describe("OpenAI file ID referencing uploaded content"),filename:p().optional()}),mf=de([p().describe("Existing data URL or base64 string"),pf,df,ff]).describe("Inline data (with metadata) or references pointing to file contents."),hf=(...e)=>p(),gf=W.extend({type:g("image"),image:p().or(lf).optional(),detail:hf("low","high","auto").optional()}),_f=W.extend({type:g("file"),file:mf}),yf=W.extend({type:g("computer_screenshot"),data:p().describe("Base64 encoded image data or URL")}),vf=H("type",[h({type:g("screenshot")}),h({type:g("click"),x:S(),y:S(),button:G(["left","right","wheel","back","forward"])}),h({type:g("double_click"),x:S(),y:S()}),h({type:g("scroll"),x:S(),y:S(),scroll_x:S(),scroll_y:S()}),h({type:g("type"),text:p()}),h({type:g("wait")}),h({type:g("move"),x:S(),y:S()}),h({type:g("keypress"),keys:C(p())}),h({type:g("drag"),path:C(h({x:S(),y:S()}))})]),wf=H("type",[nf,tf,Ws,of]),Dn=oe.extend({type:g("message").optional()}),Lt=Dn.extend({role:g("assistant"),status:G(["in_progress","completed","incomplete"]),content:C(wf)}),bf=H("type",[zn,Bs,Gs,Ws]),Vs=Dn.extend({role:g("user"),content:C(bf).or(p())}),Hs=Dn.extend({role:g("system"),content:p()});H("role",[Hs,Lt,Vs]);const ot=oe.extend({type:g("hosted_tool_call"),name:p().describe("The name of the hosted tool"),arguments:p().describe("The arguments of the hosted tool call").optional(),status:p().optional(),output:p().optional()}),st=oe.extend({type:g("function_call"),callId:p().describe("The ID of the tool call"),name:p().describe("The name of the function"),status:G(["in_progress","completed","incomplete"]).optional(),arguments:p()}),If=H("type",[sf,gf,_f]),Sf=H("type",[zn,Bs,Gs]),Ct=oe.extend({type:g("function_call_result"),name:p().describe("The name of the tool"),callId:p().describe("The ID of the tool call"),status:G(["in_progress","completed","incomplete"]),output:de([p(),If,C(Sf)]).describe("Output returned by the tool call. Supports plain strings, legacy ToolOutput items, or structured input_* items.")}),$n=oe.extend({type:g("computer_call"),callId:p().describe("The ID of the computer call"),status:G(["in_progress","completed","incomplete"]),action:vf}),Tf=oe.extend({type:g("computer_call_result"),callId:p().describe("The ID of the computer call"),output:yf}),Af=h({commands:C(p()),timeoutMs:S().int().min(0).optional(),maxOutputLength:S().int().min(0).optional()}),Ut=oe.extend({type:g("shell_call"),callId:p(),status:G(["in_progress","completed","incomplete"]).optional(),action:Af}),kf=H("type",[h({type:g("timeout")}),h({type:g("exit"),exitCode:S().int().nullable()})]),xf=h({stdout:p(),stderr:p(),outcome:kf}).passthrough(),Ks=oe.extend({type:g("shell_call_output"),callId:p(),maxOutputLength:S().optional(),output:C(xf)}),Ef=h({type:g("create_file"),path:p(),diff:p()}),Of=h({type:g("update_file"),path:p(),diff:p()}),Cf=h({type:g("delete_file"),path:p()}),Pf=H("type",[Ef,Of,Cf]),Jt=oe.extend({type:g("apply_patch_call"),callId:p(),status:G(["in_progress","completed"]),operation:Pf}),Ys=oe.extend({type:g("apply_patch_call_output"),callId:p(),status:G(["completed","failed"]),output:p().optional()}),Nf=H("type",[$n,Ut,Jt,st,ot]),Rn=W.extend({id:p().optional(),type:g("reasoning"),content:C(zn),rawContent:C(rf).optional()}),Xs=oe.extend({type:g("compaction"),encrypted_content:p(),id:p().optional(),created_by:p().optional()}),Qs=oe.extend({type:g("unknown")}),Zn=H("type",[Lt,ot,st,$n,Ut,Jt,Ct,Ks,Ys,Rn,Xs,Qs]),zf=de([Vs,Lt,Hs,ot,st,$n,Ut,Jt,Ct,Tf,Ks,Ys,Rn,Xs,Qs]),Df=h({inputTokens:S(),outputTokens:S(),totalTokens:S(),inputTokensDetails:j(p(),S()).optional(),outputTokensDetails:j(p(),S()).optional(),endpoint:p().optional()}),$f=h({requests:S().optional(),inputTokens:S(),outputTokens:S(),totalTokens:S(),inputTokensDetails:de([j(p(),S()),C(j(p(),S()))]).optional(),outputTokensDetails:de([j(p(),S()),C(j(p(),S()))]).optional(),requestUsageEntries:C(Df).optional()}),ei=W.extend({type:g("output_text_delta"),delta:p()}),Rf=W.extend({type:g("response_started")}),ti=W.extend({type:g("response_done"),response:W.extend({id:p(),usage:$f,output:C(Zn)})}),Zf=W.extend({type:g("model"),event:z().describe("The event from the model")});H("type",[ei,ti,Rf,Zf]);class Ye{inputTokens;outputTokens;totalTokens;inputTokensDetails;outputTokensDetails;endpoint;constructor(t){this.inputTokens=t?.inputTokens??t?.input_tokens??0,this.outputTokens=t?.outputTokens??t?.output_tokens??0,this.totalTokens=t?.totalTokens??t?.total_tokens??this.inputTokens+this.outputTokens;const n=t?.inputTokensDetails??t?.input_tokens_details;this.inputTokensDetails=n||{};const r=t?.outputTokensDetails??t?.output_tokens_details;this.outputTokensDetails=r||{},typeof t?.endpoint<"u"&&(this.endpoint=t.endpoint)}}class lt{requests;inputTokens;outputTokens;totalTokens;inputTokensDetails=[];outputTokensDetails=[];requestUsageEntries;constructor(t){if(typeof t>"u")this.requests=0,this.inputTokens=0,this.outputTokens=0,this.totalTokens=0,this.inputTokensDetails=[],this.outputTokensDetails=[],this.requestUsageEntries=void 0;else{this.requests=t?.requests??1,this.inputTokens=t?.inputTokens??t?.input_tokens??0,this.outputTokens=t?.outputTokens??t?.output_tokens??0,this.totalTokens=t?.totalTokens??t?.total_tokens??this.inputTokens+this.outputTokens;const n=t?.inputTokensDetails??t?.input_tokens_details;Array.isArray(n)?this.inputTokensDetails=n:this.inputTokensDetails=n?[n]:[];const r=t?.outputTokensDetails??t?.output_tokens_details;Array.isArray(r)?this.outputTokensDetails=r:this.outputTokensDetails=r?[r]:[];const o=t?.requestUsageEntries??t?.request_usage_entries,s=Array.isArray(o)?o.map(i=>i instanceof Ye?i:new Ye(i)):void 0;this.requestUsageEntries=s&&s.length>0?s:void 0}}add(t){this.requests+=t.requests??0,this.inputTokens+=t.inputTokens??0,this.outputTokens+=t.outputTokens??0,this.totalTokens+=t.totalTokens??0,t.inputTokensDetails&&this.inputTokensDetails.push(...t.inputTokensDetails),t.outputTokensDetails&&this.outputTokensDetails.push(...t.outputTokensDetails),Array.isArray(t.requestUsageEntries)&&t.requestUsageEntries.length>0?(this.requestUsageEntries??=[],this.requestUsageEntries.push(...t.requestUsageEntries.map(n=>n instanceof Ye?n:new Ye(n)))):t.requests===1&&t.totalTokens>0&&(this.requestUsageEntries??=[],this.requestUsageEntries.push(new Ye({inputTokens:t.inputTokens,outputTokens:t.outputTokens,totalTokens:t.totalTokens,inputTokensDetails:t.inputTokensDetails?.[0],outputTokensDetails:t.outputTokensDetails?.[0]})))}}class Le{context;usage;#e;constructor(t={}){this.context=t,this.usage=new lt,this.#e=new Map}_rebuildApprovals(t){this.#e=new Map(Object.entries(t))}isToolApproved(t){const{toolName:n,callId:r}=t,o=this.#e.get(n);if(o?.approved===!0&&o.rejected===!0)return k.warn("Tool is permanently approved and rejected at the same time. Approval takes precedence"),!0;if(o?.approved===!0)return!0;if(o?.rejected===!0)return!1;const s=Array.isArray(o?.approved)?o.approved.includes(r):!1,i=Array.isArray(o?.rejected)?o.rejected.includes(r):!1;if(s&&i)return k.warn(`Tool call ${r} is both approved and rejected at the same time. Approval takes precedence`),!0;if(s)return!0;if(i)return!1}approveTool(t,{alwaysApprove:n=!1}={}){const r=t.toolName??t.rawItem.name;if(n){this.#e.set(r,{approved:!0,rejected:[]});return}const o=this.#e.get(r)??{approved:[],rejected:[]};if(Array.isArray(o.approved)){const s="callId"in t.rawItem?t.rawItem.callId:t.rawItem.id;o.approved.push(s)}this.#e.set(r,o)}rejectTool(t,{alwaysReject:n=!1}={}){const r=t.toolName??t.rawItem.name;if(n){this.#e.set(r,{approved:!1,rejected:!0});return}const o=this.#e.get(r)??{approved:[],rejected:[]};if(Array.isArray(o.rejected)){const s="callId"in t.rawItem?t.rawItem.callId:t.rawItem.id;o.rejected.push(s)}this.#e.set(r,o)}toJSON(){return{context:this.context,usage:this.usage,approvals:Object.fromEntries(this.#e.entries())}}}function Mf(e){return!!e&&typeof e=="object"&&"environment"in e&&"dimensions"in e}function jf(e){if(e.type==="function")return{type:"function",name:e.name,description:e.description,parameters:e.parameters,strict:e.strict};if(e.type==="computer"){if(!Mf(e.computer))throw new M("Computer tool is not initialized for serialization. Call resolveComputer({ tool, runContext }) first (for example, when building a model payload outside Runner.run).");return{type:"computer",name:e.name,environment:e.computer.environment,dimensions:e.computer.dimensions}}return e.type==="shell"?{type:"shell",name:e.name}:e.type==="apply_patch"?{type:"apply_patch",name:e.name}:{type:"hosted_tool",name:e.name,providerData:e.providerData}}function Ff(e){return{toolName:e.toolName,toolDescription:e.toolDescription,inputJsonSchema:e.inputJsonSchema,strictJsonSchema:e.strictJsonSchema}}class Me{type="base_item";rawItem;toJSON(){return{type:this.type,rawItem:this.rawItem}}}class qt extends Me{rawItem;agent;type="message_output_item";constructor(t,n){super(),this.rawItem=t,this.agent=n}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}get content(){let t="";for(const n of this.rawItem.content)n.type==="output_text"&&(t+=n.text);return t}}class ve extends Me{rawItem;agent;type="tool_call_item";constructor(t,n){super(),this.rawItem=t,this.agent=n}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class me extends Me{rawItem;agent;output;type="tool_call_output_item";constructor(t,n,r){super(),this.rawItem=t,this.agent=n,this.output=r}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON(),output:Ae(this.output)}}}class Mn extends Me{rawItem;agent;type="reasoning_item";constructor(t,n){super(),this.rawItem=t,this.agent=n}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class jn extends Me{rawItem;agent;type="handoff_call_item";constructor(t,n){super(),this.rawItem=t,this.agent=n}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON()}}}class Fn extends Me{rawItem;sourceAgent;targetAgent;type="handoff_output_item";constructor(t,n,r){super(),this.rawItem=t,this.sourceAgent=n,this.targetAgent=r}toJSON(){return{...super.toJSON(),sourceAgent:this.sourceAgent.toJSON(),targetAgent:this.targetAgent.toJSON()}}}class Y extends Me{rawItem;agent;toolName;type="tool_approval_item";constructor(t,n,r){super(),this.rawItem=t,this.agent=n,this.toolName=r,this.toolName=r??t.name}get name(){return this.toolName??this.rawItem.name}get arguments(){return"arguments"in this.rawItem?this.rawItem.arguments:void 0}toJSON(){return{...super.toJSON(),agent:this.agent.toJSON(),toolName:this.toolName}}}function Bt(e){return async(t,...n)=>In(async()=>{const r=e(...n);Jn(r);try{return r.start(),await t(r)}catch(o){throw r.setError({message:o.message,data:o.data}),o}finally{r.end(),Qe()}})}function Lf(e,t){return ge().createSpan({...e,data:{type:"agent",name:e?.data?.name??"Agent",...e?.data}},t)}function Uf(e,t){return ge().createSpan({...e,data:{type:"function",input:e?.data?.input??"",output:e?.data?.output??"",...e?.data}},t)}const jr=Bt(Uf);function Jf(e,t){return ge().createSpan({...e,data:{type:"handoff",...e?.data}},t)}const qf=Bt(Jf);function Bf(e,t){return ge().createSpan({...e,data:{type:"guardrail",triggered:!1,...e?.data}},t)}const Fr=Bt(Bf);function Gf(e,t){return ge().createSpan({...e,data:{type:"mcp_tools",...e?.data}},t)}const Wf=Bt(Gf);function ne(e){if(e.length===0)return"";const t=typeof globalThis<"u"&&globalThis.Buffer?globalThis.Buffer:void 0;if(t)return t.from(e).toString("base64");let n="";for(let i=0;i<e.length;i+=1)n+=String.fromCharCode(e[i]);if(typeof globalThis.btoa=="function")return globalThis.btoa(n);const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let o="",s=0;for(;s<n.length;){const i=n.charCodeAt(s++),a=n.charCodeAt(s++),c=n.charCodeAt(s++),u=i>>2,l=(i&3)<<4|a>>4,d=isNaN(a)?64:(a&15)<<2|c>>6,f=isNaN(c)?64:c&63;o+=r.charAt(u)+r.charAt(l)+r.charAt(d)+r.charAt(f)}return o}class Vf{data;type="raw_model_stream_event";constructor(t){this.data=t}}class Hf{name;item;type="run_item_stream_event";constructor(t,n){this.name=t,this.item=n}}class Kf{agent;type="agent_updated_stream_event";constructor(t){this.agent=t}}function Yf(e){return!!e&&typeof e.runCompaction=="function"}var Xf={};function Qf(e){if(!e||typeof e!="object"||!("rawItem"in e))return!1;const t=e.rawItem;if(!t||typeof t!="object")return!1;const n=t.type;return n==="function_call"||n==="hosted_tool_call"}function Lr(e){const t=e.rawItem;if(!t)return;if(t.type==="function_call"&&t.callId)return`function_call:${t.callId}`;if("callId"in t&&t.callId)return`${t.type}:${t.callId}`;const n="id"in t?t.id:void 0;if(n)return`${t.type}:${n}`;const r=typeof t.providerData=="object"&&t.providerData?t.providerData:void 0;if(r?.id)return`${t.type}:provider:${r.id}`;const o="agent"in e&&e.agent?e.agent.name:"";try{return`${o}:${t.type}:${JSON.stringify(t)}`}catch{return`${o}:${t.type}`}}function em(e){try{if(e instanceof Qc){const t=e.issues[0];if(t){const n=Array.isArray(t.path)?t.path:[],r=n.length>0?n.map(s=>String(s)).join("."):"(root)",o=Ur(t.message??"");return`Invalid output type: final assistant output failed schema validation at "${r}" (${o}).`}return"Invalid output type: final assistant output failed schema validation."}if(e instanceof Error&&e.message)return`Invalid output type: ${Ur(e.message)}`}catch{}return"Invalid output type: final assistant output did not match the expected schema."}function Ur(e,t=160){const n=e.trim();return n?n.length<=t?n:`${n.slice(0,t-3)}...`:"Schema validation failed."}function Jr(e,t,n,r){const o=[],s=[],i=[],a=[],c=[],u=[],l=[],d=[],f=new Map(r.map(y=>[y.toolName,y])),m=new Map(n.filter(y=>y.type==="function").map(y=>[y.name,y])),w=n.find(y=>y.type==="computer"),b=n.find(y=>y.type==="shell"),v=n.find(y=>y.type==="apply_patch"),A=new Map(n.filter(y=>y.type==="hosted_tool"&&y.providerData?.type==="mcp").map(y=>y).map(y=>[y.providerData.server_label,y]));for(const y of e.output){if(y.type==="message")y.role==="assistant"&&o.push(new qt(y,t));else if(y.type==="hosted_tool_call"){o.push(new ve(y,t));const T=y.name;if(d.push(T),y.providerData?.type==="mcp_approval_request"||y.name==="mcp_approval_request"){const I=y.providerData,O=I.server_label,P=A.get(O);if(typeof P>"u"){const q=`MCP server (${O}) not found in Agent (${t.name})`;throw we({message:q,data:{mcp_server_label:O}}),new X(q)}const D=new Y({type:"hosted_tool_call",name:I.name,id:I.id,status:"in_progress",providerData:I},t);l.push({requestItem:D,mcpTool:P}),P.providerData.on_approval||o.push(D)}}else if(y.type==="reasoning")o.push(new Mn(y,t));else if(y.type==="computer_call"){if(o.push(new ve(y,t)),d.push("computer_use"),!w)throw we({message:"Model produced computer action without a computer tool.",data:{agent_name:t.name}}),new X("Model produced computer action without a computer tool.");a.push({toolCall:y,computer:w})}else if(y.type==="shell_call"){if(o.push(new ve(y,t)),d.push("shell"),!b)throw we({message:"Model produced shell action without a shell tool.",data:{agent_name:t.name}}),new X("Model produced shell action without a shell tool.");c.push({toolCall:y,shell:b})}else if(y.type==="apply_patch_call"){if(o.push(new ve(y,t)),d.push("apply_patch"),!v)throw we({message:"Model produced apply_patch action without an apply_patch tool.",data:{agent_name:t.name}}),new X("Model produced apply_patch action without an apply_patch tool.");u.push({toolCall:y,applyPatch:v})}if(y.type!=="function_call")continue;d.push(y.name);const x=f.get(y.name);if(x)o.push(new jn(y,t)),s.push({toolCall:y,handoff:x});else{const T=m.get(y.name);if(!T)throw we({message:`Tool ${y.name} not found in agent ${t.name}.`,data:{tool_name:y.name,agent_name:t.name}}),new X(`Tool ${y.name} not found in agent ${t.name}.`);o.push(new ve(y,t)),i.push({toolCall:y,tool:T})}}return{newItems:o,handoffs:s,functions:i,computerActions:a,shellActions:c,applyPatchActions:u,mcpApprovalRequests:l,toolsUsed:d,hasToolsOrApprovalsToRun(){return s.length>0||i.length>0||l.length>0||a.length>0||c.length>0||u.length>0}}}const tm=H("type",[h({type:g("next_step_handoff"),newAgent:z()}),h({type:g("next_step_final_output"),output:p()}),h({type:g("next_step_run_again")}),h({type:g("next_step_interruption"),data:j(p(),z())})]);class pe{originalInput;modelResponse;preStepItems;newStepItems;nextStep;constructor(t,n,r,o,s){this.originalInput=t,this.modelResponse=n,this.preStepItems=r,this.newStepItems=o,this.nextStep=s}get generatedItems(){return this.preStepItems.concat(this.newStepItems)}}function nm(e,t,n){return e.resetToolChoice&&t.hasUsedTools(e)?{...n,toolChoice:void 0}:n}async function qr(e,t,n,r,o,s,i){const a=n.filter(I=>I instanceof Y&&"callId"in I.rawItem&&I.rawItem.type==="function_call").map(I=>I.rawItem.callId),c=i.getInterruptions().filter(Qf);if(c.length>0){const I=new Set;for(const O of c){const P=Lr(O);P&&I.add(P)}if(I.size>0){let O=0;for(let P=n.length-1;P>=0;P--){const D=n[P];if(!(D instanceof Y))continue;const q=Lr(D);if(q&&I.has(q)&&(O++,I.delete(q),I.size===0))break}O>0&&(i._currentTurnPersistedItemCount=Math.max(0,i._currentTurnPersistedItemCount-O))}}const u=o.functions.filter(I=>a.includes(I.toolCall.callId)),l=await ri(e,u,s,i),d=o.computerActions.length>0?await si(e,o.computerActions,s,i._context):[],f=new Set(n),m=[],w=new Set,b=I=>{f.has(I)||w.has(I)||(m.push(I),w.add(I))};for(const I of l)b(I.runItem);for(const I of d)b(I);const v=o.mcpApprovalRequests.filter(I=>I.requestItem.type==="tool_approval_item"&&I.requestItem.rawItem.type==="hosted_tool_call"&&I.requestItem.rawItem.providerData?.type==="mcp_approval_request"),A=new Set,y=new Set;for(const I of v){const O=I.requestItem.rawItem;if(O.type!=="hosted_tool_call")continue;const P=O.id,D=i._context.isToolApproved({toolName:O.name,callId:P});if(typeof D<"u"){const q={approve:D,approval_request_id:P,reason:void 0},be=new ve({type:"hosted_tool_call",name:"mcp_approval_response",providerData:q},e);b(be)}else A.add(I.requestItem),y.add(P),l.push({type:"hosted_mcp_tool_approval",tool:I.mcpTool,runItem:I.requestItem}),b(I.requestItem)}const x=n.filter(I=>{if(!(I instanceof Y))return!0;if(I.rawItem.type==="hosted_tool_call"&&I.rawItem.providerData?.type==="mcp_approval_request"){if(A.has(I))return!0;const O=I.rawItem.id;return O?y.has(O):!1}return!1}),T=await ni({agent:e,runner:s,state:i,functionResults:l,originalInput:t,newResponse:r,preStepItems:x,newItems:m});return T||new pe(t,r,x,m,{type:"next_step_run_again"})}async function Br(e,t,n,r,o,s,i){const a=n,c=new Set(n),u=[],l=T=>{c.has(T)||(u.push(T),c.add(T))};for(const T of o.newItems)l(T);const[d,f,m,w]=await Promise.all([ri(e,o.functions,s,i),si(e,o.computerActions,s,i._context),am(e,o.shellActions,s,i._context),um(e,o.applyPatchActions,s,i._context)]);for(const T of d)l(T.runItem);for(const T of f)l(T);for(const T of m)l(T);for(const T of w)l(T);if(o.mcpApprovalRequests.length>0)for(const T of o.mcpApprovalRequests){const I=T.mcpTool.providerData,O=T.requestItem.rawItem.providerData;if(I.on_approval){const P=await I.on_approval(i._context,T.requestItem),D={approve:P.approve,approval_request_id:O.id,reason:P.reason};u.push(new ve({type:"hosted_tool_call",name:"mcp_approval_response",providerData:D},e))}else{u.push(T.requestItem);const P={type:"hosted_mcp_tool_approval",tool:T.mcpTool,runItem:new Y({type:"hosted_tool_call",name:O.name,id:O.id,arguments:O.arguments,status:"in_progress",providerData:O},e)};d.push(P)}}if(o.handoffs.length>0)return await cm(e,t,a,u,r,o.handoffs,s,i._context);const b=await ni({agent:e,runner:s,state:i,functionResults:d,originalInput:t,newResponse:r,preStepItems:a,newItems:u});if(b)return b;if((o.functions?.length??0)>0||(o.computerActions?.length??0)>0||(o.shellActions?.length??0)>0||(o.applyPatchActions?.length??0)>0||(o.mcpApprovalRequests?.length??0)>0||(o.handoffs?.length??0)>0)return new pe(t,r,a,u,{type:"next_step_run_again"});const A=u.filter(T=>T instanceof qt),y=A.length>0?qs(A[A.length-1].rawItem):void 0;if(typeof y>"u")return new pe(t,r,a,u,{type:"next_step_run_again"});if(!d.some(T=>T.runItem instanceof Y)){if(e.outputType==="text")return new pe(t,r,a,u,{type:"next_step_final_output",output:y});if(e.outputType!=="text"&&y){const{parser:T}=Cn(e.outputType,"final_output"),[I]=await Sn(()=>T(y));if(I){const O=em(I);throw we({message:O,data:{error:String(I)}}),new X(O)}return new pe(t,r,a,u,{type:"next_step_final_output",output:y})}}return new pe(t,r,a,u,{type:"next_step_run_again"})}async function ni({agent:e,runner:t,state:n,functionResults:r,originalInput:o,newResponse:s,preStepItems:i,newItems:a}){const c=await lm(e,r,n);return c.isFinalOutput?(t.emit("agent_end",n._context,e,c.finalOutput),e.emit("agent_end",n._context,c.finalOutput),new pe(o,s,i,a,{type:"next_step_final_output",output:c.finalOutput})):c.isInterrupted?new pe(o,s,i,a,{type:"next_step_interruption",data:{interruptions:c.interruptions}}):null}function Pt(e,t){const n=wm(t);if(n){const r=n.map(bm);return{type:"function_call_result",name:e.name,callId:e.callId,status:"completed",output:r}}return{type:"function_call_result",name:e.name,callId:e.callId,status:"completed",output:{type:"text",text:Ae(t)}}}function rm(e){const t=e.file;if(typeof t=="string"&&t.length>0)return t;const n=om(t);if(n)return n;const r=sm(e);return r||null}function om(e){if(!Ne(e))return null;if("data"in e&&e.data!==void 0){const n=e.data,r=typeof n=="string"&&n.length>0,o=n instanceof Uint8Array&&n.length>0;return!r&&!o||!V(e.mediaType)||!V(e.filename)?null:{data:typeof n=="string"?n:new Uint8Array(n),mediaType:e.mediaType,filename:e.filename}}if(V(e.url)){const n={url:e.url};return V(e.filename)&&(n.filename=e.filename),n}const t=V(e.id)&&e.id||V(e.fileId)&&e.fileId;if(t){const n={id:t};return V(e.filename)&&(n.filename=e.filename),n}return null}function sm(e){const t=typeof e.filename=="string"&&e.filename.length>0?e.filename:void 0,n=typeof e.mediaType=="string"&&e.mediaType.length>0?e.mediaType:void 0;if(typeof e.fileData=="string"&&e.fileData.length>0)return!n||!t?null:{data:e.fileData,mediaType:n,filename:t};if(e.fileData instanceof Uint8Array&&e.fileData.length>0)return!n||!t?null:{data:new Uint8Array(e.fileData),mediaType:n,filename:t};if(typeof e.fileUrl=="string"&&e.fileUrl.length>0){const r={url:e.fileUrl};return t&&(r.filename=t),r}if(typeof e.fileId=="string"&&e.fileId.length>0){const r={id:e.fileId};return t&&(r.filename=t),r}return null}function Ne(e){return typeof e=="object"&&e!==null}function V(e){return typeof e=="string"&&e.length>0}function gt(e,t){if(typeof e=="string")return t&&!e.startsWith("data:")?Ue(e,t):e;const n=ne(e);return Ue(n,t)}function Ue(e,t){return t?`data:${t};base64,${e}`:e}async function ri(e,t,n,r){async function o(s){let i=s.toolCall.arguments;if(s.tool.parameters&&($e(s.tool.parameters)?i=s.tool.parameters.parse(i):i=JSON.parse(i)),await s.tool.needsApproval(r._context,i,s.toolCall.callId)){const c=r._context.isToolApproved({toolName:s.tool.name,callId:s.toolCall.callId});if(c===!1)return jr(async u=>{const l="Tool execution was not approved.";return u.setError({message:l,data:{tool_name:s.tool.name,error:`Tool execution for ${s.toolCall.callId} was manually rejected by user.`}}),u.spanData.output=l,{type:"function_output",tool:s.tool,output:l,runItem:new me(Pt(s.toolCall,l),e,l)}},{data:{name:s.tool.name}});if(c!==!0)return{type:"function_approval",tool:s.tool,runItem:new Y(s.toolCall,e)}}return jr(async c=>{n.config.traceIncludeSensitiveData&&(c.spanData.input=s.toolCall.arguments);try{n.emit("agent_tool_start",r._context,e,s.tool,{toolCall:s.toolCall}),e.emit("agent_tool_start",r._context,s.tool,{toolCall:s.toolCall});const u=await s.tool.invoke(r._context,s.toolCall.arguments,{toolCall:s.toolCall}),l=Ae(u);n.emit("agent_tool_end",r._context,e,s.tool,l,{toolCall:s.toolCall}),e.emit("agent_tool_end",r._context,s.tool,l,{toolCall:s.toolCall}),n.config.traceIncludeSensitiveData&&(c.spanData.output=l);const d={type:"function_output",tool:s.tool,output:u,runItem:new me(Pt(s.toolCall,u),e,u)},f=Xd(s.toolCall);if(f){d.agentRunResult=f;const m=f.interruptions;m.length>0&&(d.interruptions=m)}return d}catch(u){c.setError({message:"Error running tool",data:{tool_name:s.tool.name,error:String(u)}});const l=String(u);throw n.emit("agent_tool_end",r._context,e,s.tool,l,{toolCall:s.toolCall}),e.emit("agent_tool_end",r._context,s.tool,l,{toolCall:s.toolCall}),u}},{data:{name:s.tool.name}})}try{return await Promise.all(t.map(o))}catch(s){throw new ed(`Failed to run function tools: ${s}`,s,r)}}async function im(e,t){const n=t.action;let r;switch(n.type){case"click":await e.click(n.x,n.y,n.button);break;case"double_click":await e.doubleClick(n.x,n.y);break;case"drag":await e.drag(n.path.map(o=>[o.x,o.y]));break;case"keypress":await e.keypress(n.keys);break;case"move":await e.move(n.x,n.y);break;case"screenshot":r=await e.screenshot();break;case"scroll":await e.scroll(n.x,n.y,n.scroll_x,n.scroll_y);break;case"type":await e.type(n.text);break;case"wait":await e.wait();break}if(typeof r<"u"||typeof e.screenshot=="function"&&(r=await e.screenshot(),typeof r<"u"))return r;throw new Error("Computer does not implement screenshot()")}function oi(e){if(e instanceof Error)return e.message||e.toString();try{return JSON.stringify(e)}catch{return String(e)}}async function am(e,t,n,r,o=void 0){const s=o??k,i=[];for(const a of t){const c=a.shell,u=a.toolCall,l=new Y(u,e,c.name);if(await c.needsApproval(r,u.action,u.callId)){if(c.onApproval){const A=await c.onApproval(r,l);A.approve===!0?r.approveTool(l):A.approve===!1&&r.rejectTool(l)}const v=r.isToolApproved({toolName:c.name,callId:u.callId});if(v===!1){const A="Tool execution was not approved.",y={stdout:"",stderr:A,outcome:{type:"exit",exitCode:null}};i.push(new me({type:"shell_call_output",callId:u.callId,output:[y]},e,A));continue}if(v!==!0){i.push(l);continue}}n.emit("agent_tool_start",r,e,c,{toolCall:u}),typeof e.emit=="function"&&e.emit("agent_tool_start",r,c,{toolCall:u});let f;const m={};let w;try{const v=await c.shell.run(u.action);f=v.output??[],v.providerData&&Object.assign(m,v.providerData),typeof v.maxOutputLength=="number"&&(w=v.maxOutputLength)}catch(v){f=[{stdout:"",stderr:oi(v),outcome:{type:"exit",exitCode:null}}],s.error("Failed to execute shell action:",v)}f=f??[],n.emit("agent_tool_end",r,e,c,JSON.stringify(f),{toolCall:u}),typeof e.emit=="function"&&e.emit("agent_tool_end",r,c,JSON.stringify(f),{toolCall:u});const b={type:"shell_call_output",callId:u.callId,output:f??[]};typeof w=="number"&&(b.maxOutputLength=w),Object.keys(m).length>0&&(b.providerData=m),i.push(new me(b,e,b.output))}return i}async function um(e,t,n,r,o=void 0){const s=o??k,i=[];for(const a of t){const c=a.applyPatch,u=a.toolCall,l=new Y(u,e,c.name);if(await c.needsApproval(r,u.operation,u.callId)){if(c.onApproval){const v=await c.onApproval(r,l);v.approve===!0?r.approveTool(l):v.approve===!1&&r.rejectTool(l)}const b=r.isToolApproved({toolName:c.name,callId:u.callId});if(b===!1){const v="Tool execution was not approved.";i.push(new me({type:"apply_patch_call_output",callId:u.callId,status:"failed",output:v},e,v));continue}if(b!==!0){i.push(l);continue}}n.emit("agent_tool_start",r,e,c,{toolCall:u}),typeof e.emit=="function"&&e.emit("agent_tool_start",r,c,{toolCall:u});let f="completed",m="";try{let b;switch(u.operation.type){case"create_file":b=await c.editor.createFile(u.operation);break;case"update_file":b=await c.editor.updateFile(u.operation);break;case"delete_file":b=await c.editor.deleteFile(u.operation);break;default:throw new Error("Unsupported apply_patch operation")}b&&typeof b.status=="string"&&(f=b.status),b&&typeof b.output=="string"&&(m=b.output)}catch(b){f="failed",m=oi(b),s.error("Failed to execute apply_patch operation:",b)}n.emit("agent_tool_end",r,e,c,m,{toolCall:u}),typeof e.emit=="function"&&e.emit("agent_tool_end",r,c,m,{toolCall:u});const w={type:"apply_patch_call_output",callId:u.callId,status:f};m&&(w.output=m),i.push(new me(w,e,m))}return i}async function si(e,t,n,r,o=void 0){const s=o??k,i=[];for(const a of t){const c=a.toolCall;n.emit("agent_tool_start",r,e,a.computer,{toolCall:c}),typeof e.emit=="function"&&e.emit("agent_tool_start",r,a.computer,{toolCall:c});let u;try{const f=await Zs({tool:a.computer,runContext:r});u=await im(f,c)}catch(f){s.error("Failed to execute computer action:",f),u=""}n.emit("agent_tool_end",r,e,a.computer,u,{toolCall:c}),typeof e.emit=="function"&&e.emit("agent_tool_end",r,a.computer,u,{toolCall:c});const l=u?`data:image/png;base64,${u}`:"",d={type:"computer_call_result",callId:c.callId,output:{type:"computer_screenshot",data:l}};i.push(new me(d,e,l))}return i}async function cm(e,t,n,r,o,s,i,a){if(r=[...r],s.length===0)return k.warn("Incorrectly called executeHandoffCalls with no handoffs. This should not happen. Moving on."),new pe(t,o,n,r,{type:"next_step_run_again"});if(s.length>1){const u="Multiple handoffs detected, ignoring this one.";for(let l=1;l<s.length;l++)r.push(new me(Pt(s[l].toolCall,u),e,u))}const c=s[0];return qf(async u=>{const l=c.handoff,d=await l.onInvokeHandoff(a,c.toolCall.arguments);if(u.spanData.to_agent=d.name,s.length>1){const m=s.map(w=>w.handoff.agentName);u.setError({message:"Multiple handoffs requested",data:{requested_agents:m}})}r.push(new Fn(Pt(c.toolCall,Ls(d)),e,d)),i.emit("agent_handoff",a,e,d),e.emit("agent_handoff",a,d);const f=l.inputFilter??i.config.handoffInputFilter;if(f){k.debug("Filtering inputs for handoff"),typeof f!="function"&&u.setError({message:"Invalid input filter",data:{details:"not callable"}});const m={inputHistory:Array.isArray(t)?[...t]:t,preHandoffItems:[...n],newItems:[...r],runContext:a},w=f(m);t=w.inputHistory,n=w.preHandoffItems,r=w.newItems}return new pe(t,o,n,r,{type:"next_step_handoff",newAgent:d})},{data:{from_agent:e.name}})}const _t={isFinalOutput:!1,isInterrupted:void 0};async function lm(e,t,n){if(t.length===0)return _t;const r=[];for(const i of t)if(i.runItem instanceof Y&&r.push(i.runItem),i.type==="function_output"){if(Array.isArray(i.interruptions))r.push(...i.interruptions);else if(i.agentRunResult){const a=i.agentRunResult.interruptions;a.length>0&&r.push(...a)}}if(r.length>0)return{isFinalOutput:!1,isInterrupted:!0,interruptions:r};if(e.toolUseBehavior==="run_llm_again")return _t;const o=t[0];if(e.toolUseBehavior==="stop_on_first_tool")return o?.type==="function_output"?{isFinalOutput:!0,isInterrupted:void 0,finalOutput:Ae(o.output)}:_t;const s=e.toolUseBehavior;if(typeof s=="object"){const i=t.find(a=>s.stopAtToolNames.includes(a.tool.name));return i?.type==="function_output"?{isFinalOutput:!0,isInterrupted:void 0,finalOutput:Ae(i.output)}:_t}if(typeof s=="function")return s(n._context,t);throw new M(`Invalid toolUseBehavior: ${s}`,n)}function pm(e){if(e instanceof qt)return"message_output_created";if(e instanceof jn)return"handoff_requested";if(e instanceof Fn)return"handoff_occurred";if(e instanceof ve)return"tool_called";if(e instanceof me)return"tool_output";if(e instanceof Mn)return"reasoning_item_created";if(e instanceof Y)return"tool_approval_requested"}function ii(e,t){const n=pm(t);if(!n){k.warn("Unknown item type: ",t);return}e._addItem(new Hf(n,t))}function dm(e,t){for(const n of t)ii(e,n)}function Gr(e,t,n){const r=n?.skipItems;for(const o of t.newStepItems)r?.has(o)||ii(e,o)}class Wr{#e=new Map;addToolUse(t,n){this.#e.set(t,n)}hasUsedTools(t){return this.#e.has(t)}toJSON(){return Object.fromEntries(Array.from(this.#e.entries()).map(([t,n])=>[t.name,n]))}}function fm(e){return typeof e=="string"?[{type:"message",role:"user",content:e}]:[...e]}function ai(e){return e.filter(t=>t.type!=="tool_approval_item").map(t=>t.rawItem)}function Ln(e){return e.map(t=>vn(wn(t)))}function vn(e,t={}){if(e==null)return e;const n=mm(e);if(n)return hm(n,t.mediaType);if(Array.isArray(e))return e.map(i=>vn(i,t));if(!ui(e))return e;const r=e,o={},s=typeof r.mediaType=="string"&&r.mediaType.length>0?r.mediaType:t.mediaType;for(const[i,a]of Object.entries(r)){const c=i==="data"||i==="fileData"?{mediaType:s}:t;o[i]=vn(a,c)}return o}function mm(e){if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ct(e)){const t=e;return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}if(Pn(e)){const t=e;return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}if(Mt(e))return Uint8Array.from(e.data)}function hm(e,t){const n=ne(e);return`data:${t&&!t.startsWith("data:")?t:"text/plain"};base64,${n}`}function ui(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}function wn(e){if(e==null)return e;if(Array.isArray(e))return e.map(s=>wn(s));if(!ui(e))return e;const t=e,n={},o=typeof t.type=="string"&&t.type.length>0&&gm(t.type);for(const[s,i]of Object.entries(t))o&&s==="id"||(n[s]=wn(i));return n}function gm(e){switch(e){case"function_call":case"function_call_result":return!0;default:return!1}}async function Nt(e,t,n){if(!Yf(e))return;const r=await e.runCompaction(typeof t>"u"?void 0:{responseId:t});if(!r)return;const o=r.usage;n._context.usage.add(new lt({requests:1,inputTokens:o.inputTokens,outputTokens:o.outputTokens,totalTokens:o.totalTokens,inputTokensDetails:o.inputTokensDetails,outputTokensDetails:o.outputTokensDetails,requestUsageEntries:[o]}))}async function _m(e,t,n){if(!e)return;const r=t??[],o=n.state,s=o._currentTurnPersistedItemCount??0,i=n.newItems.slice(s);Xf.OPENAI_AGENTS__DEBUG_SAVE_SESSION&&console.debug("saveToSession:newRunItems",i.map(l=>l.type));const a=ai(i),c=[...r,...a];if(c.length===0){o._currentTurnPersistedItemCount=s+i.length,await Nt(e,n.lastResponseId,o);return}const u=Ln(c);await e.addItems(u),await Nt(e,n.lastResponseId,o),o._currentTurnPersistedItemCount=s+i.length}async function ym(e,t){if(!e||!t||t.length===0)return;const n=Ln(t);await e.addItems(n)}async function Vr(e,t){if(!e)return;const n=t.state,r=n._currentTurnPersistedItemCount??0,o=t.newItems.slice(r),s=ai(o);if(s.length===0){n._currentTurnPersistedItemCount=r+o.length,await Nt(e,t.lastResponseId,n);return}const i=Ln(s);await e.addItems(i),await Nt(e,t.lastResponseId,n),n._currentTurnPersistedItemCount=r+o.length}async function vm(e,t,n,r){if(!t)return{preparedInput:e,sessionItems:void 0};const o=r?.includeHistoryInPreparedInput??!0,s=r?.preserveDroppedNewItems??!1,i=await t.getItems(),a=Array.isArray(e)?[...e]:fm(e);if(!n)return{preparedInput:o?[...i,...a]:a,sessionItems:a};const c=i.slice(),u=a.slice(),l=await n(i,a);if(!Array.isArray(l))throw new M("Session input callback must return an array of AgentInputItem objects.");const d=Kr(c),f=Kr(u),m=Yr(c),w=Yr(u),b=[];for(const A of l){const y=Un(A);if(Xr(w,y,A)){Qr(f,y),b.push(A);continue}if(Xr(m,y,A)){Qr(d,y);continue}const x=d.get(y)??0;if(x>0){d.set(y,x-1);continue}const T=f.get(y)??0;if(T>0){f.set(y,T-1),b.push(A);continue}b.push(A)}return{preparedInput:o?l:b.length>0?b:s?u:[],sessionItems:b}}function wm(e){if(Array.isArray(e)){const n=[];for(const r of e){const o=Hr(r);if(!o)return null;n.push(o)}return n}const t=Hr(e);return t?[t]:null}function Hr(e){if(!Ne(e))return null;const t=e.type;if(t==="text"&&typeof e.text=="string"){const n={type:"text",text:e.text};return Ne(e.providerData)&&(n.providerData=e.providerData),n}if(t==="image"){const n={type:"image"};let r,o;const s=V(e.mediaType)?e.mediaType:void 0,i=e.image;if(typeof i=="string"&&i.length>0)r=i;else if(Ne(i)){const a=i,c=V(a.mediaType)?a.mediaType:s;if(V(a.url)?r=a.url:(V(a.data)||a.data instanceof Uint8Array&&a.data.length>0)&&(r=gt(a.data,c)),!r){const u=V(a.fileId)&&a.fileId||V(a.id)&&a.id||void 0;u&&(o=u)}}if(!r&&typeof e.imageUrl=="string"&&e.imageUrl.length>0&&(r=e.imageUrl),!o&&typeof e.fileId=="string"&&e.fileId.length>0&&(o=e.fileId),!r&&typeof e.data=="string"&&e.data.length>0?r=s?gt(e.data,s):e.data:!r&&e.data instanceof Uint8Array&&e.data.length>0&&(r=gt(e.data,s)),typeof e.detail=="string"&&e.detail.length>0&&(n.detail=e.detail),r)n.image=r;else if(o)n.image={fileId:o};else return null;return Ne(e.providerData)&&(n.providerData=e.providerData),n}if(t==="file"){const n=rm(e);if(!n)return null;const r={type:"file",file:n};return Ne(e.providerData)&&(r.providerData=e.providerData),r}return null}function bm(e){if(e.type==="text"){const n={type:"input_text",text:e.text};return e.providerData&&(n.providerData=e.providerData),n}if(e.type==="image"){const n={type:"input_image"};if(typeof e.detail=="string"&&e.detail.length>0&&(n.detail=e.detail),typeof e.image=="string"&&e.image.length>0)n.image=e.image;else if(Ne(e.image)){const r=e.image,o=V(r.mediaType)?r.mediaType:void 0;if(V(r.url))n.image=r.url;else if(V(r.data))n.image=o&&!r.data.startsWith("data:")?Ue(r.data,o):r.data;else if(r.data instanceof Uint8Array&&r.data.length>0){const s=ne(r.data);n.image=Ue(s,o)}else{const s=V(r.fileId)&&r.fileId||V(r.id)&&r.id||void 0;s&&(n.image={id:s})}}return e.providerData&&(n.providerData=e.providerData),n}if(e.type==="file"){const n={type:"input_file"},r=e.file;if(typeof r=="string")n.file=r;else if(r&&typeof r=="object"){const o=r;if("data"in o&&o.data){const s=o.mediaType??"text/plain";if(typeof o.data=="string")n.file=Ue(o.data,s);else{const i=ne(o.data);n.file=Ue(i,s)}}else if(typeof o.url=="string"&&o.url.length>0)n.file={url:o.url};else{const s=typeof o.id=="string"&&o.id.length>0&&o.id||(typeof o.fileId=="string"&&o.fileId.length>0?o.fileId:void 0);s&&(n.file={id:s})}typeof o.filename=="string"&&o.filename.length>0&&(n.filename=o.filename)}return e.providerData&&(n.providerData=e.providerData),n}return e}function Kr(e){const t=new Map;for(const n of e){const r=Un(n);t.set(r,(t.get(r)??0)+1)}return t}function Yr(e){const t=new Map;for(const n of e){const r=Un(n),o=t.get(r);o?o.push(n):t.set(r,[n])}return t}function Xr(e,t,n){const r=e.get(t);if(!r||r.length===0)return!1;const o=r.findIndex(s=>s===n);return o===-1?!1:(r.splice(o,1),r.length===0&&e.delete(t),!0)}function Qr(e,t){const n=(e.get(t)??0)-1;n<=0?e.delete(t):e.set(t,n)}function Un(e){return JSON.stringify(e,Im)}function Im(e,t){if(t instanceof ArrayBuffer)return{__type:"ArrayBuffer",data:ne(new Uint8Array(t))};if(ct(t)){const n=t;return{__type:n.constructor.name,data:ne(new Uint8Array(n.buffer,n.byteOffset,n.byteLength))}}if(Pn(t)){const n=t;return{__type:"Buffer",data:ne(new Uint8Array(n.buffer,n.byteOffset,n.byteLength))}}return Mt(t)?{__type:"Buffer",data:ne(Uint8Array.from(t.data))}:t}const vt="1.0",Sm=g(vt),le=h({name:p()}),Tm=h({object:g("trace.span"),id:p(),trace_id:p(),parent_id:p().nullable(),started_at:p().nullable(),ended_at:p().nullable(),error:h({message:p(),data:j(p(),z()).optional()}).nullable(),span_data:j(p(),z())}),ci=Tm.extend({previous_span:rp(()=>ci).optional()}),Am=h({inputTokens:S(),outputTokens:S(),totalTokens:S(),inputTokensDetails:j(p(),S()).optional(),outputTokensDetails:j(p(),S()).optional(),endpoint:p().optional()}),li=h({requests:S(),inputTokens:S(),outputTokens:S(),totalTokens:S(),inputTokensDetails:C(j(p(),S())).optional(),outputTokensDetails:C(j(p(),S())).optional(),requestUsageEntries:C(Am).optional()}),eo=h({usage:li,output:C(Zn),responseId:p().optional(),providerData:j(p(),z()).optional()}),pi=H("type",[h({type:g("message_output_item"),rawItem:Lt,agent:le}),h({type:g("tool_call_item"),rawItem:Nf.or(ot),agent:le}),h({type:g("tool_call_output_item"),rawItem:Ct,agent:le,output:p()}),h({type:g("reasoning_item"),rawItem:Rn,agent:le}),h({type:g("handoff_call_item"),rawItem:st,agent:le}),h({type:g("handoff_output_item"),rawItem:Ct,sourceAgent:le,targetAgent:le}),h({type:g("tool_approval_item"),rawItem:st.or(ot).or(Ut).or(Jt),agent:le,toolName:p().optional()})]),km=h({object:g("trace"),id:p(),workflow_name:p(),group_id:p().nullable(),metadata:j(p(),z())}),xm=h({newItems:C(pi),toolsUsed:C(p()),handoffs:C(h({toolCall:z(),handoff:z()})),functions:C(h({toolCall:z(),tool:z()})),computerActions:C(h({toolCall:z(),computer:z()})),shellActions:C(h({toolCall:z(),shell:z()})).optional(),applyPatchActions:C(h({toolCall:z(),applyPatch:z()})).optional(),mcpApprovalRequests:C(h({requestItem:h({rawItem:h({type:g("hosted_tool_call"),name:p(),arguments:p().optional(),status:p().optional(),output:p().optional(),providerData:j(p(),z()).nullable().optional()})}),mcpTool:h({type:g("hosted_tool"),name:g("hosted_mcp"),providerData:j(p(),z())})})).optional()}),di=h({tripwireTriggered:De(),outputInfo:z()}),Em=h({guardrail:h({type:g("input"),name:p()}),output:di}),Om=h({guardrail:h({type:g("output"),name:p()}),agentOutput:z(),agent:le,output:di}),to=h({$schemaVersion:Sm,currentTurn:S(),currentAgent:le,originalInput:p().or(C(zf)),modelResponses:C(eo),context:h({usage:li,approvals:j(p(),h({approved:C(p()).or(De()),rejected:C(p()).or(De())})),context:j(p(),z())}),toolUseTracker:j(p(),C(p())),maxTurns:S(),currentAgentSpan:ci.nullable().optional(),noActiveAgentRun:De(),inputGuardrailResults:C(Em),outputGuardrailResults:C(Om),currentStep:tm.optional(),lastModelResponse:eo.optional(),generatedItems:C(pi),lastProcessedResponse:xm.optional(),currentTurnPersistedItemCount:S().int().min(0).optional(),trace:km.nullable()});class ye{_currentTurn=0;_currentAgent;_originalInput;_modelResponses;_currentAgentSpan;_context;get usage(){return this._context.usage}_toolUseTracker;_generatedItems;_currentTurnPersistedItemCount;_maxTurns;_noActiveAgentRun=!0;_lastTurnResponse;_inputGuardrailResults;_outputGuardrailResults;_currentStep=void 0;_lastProcessedResponse=void 0;_trace=null;constructor(t,n,r,o){this._context=t,this._originalInput=structuredClone(n),this._modelResponses=[],this._currentAgentSpan=void 0,this._currentAgent=r,this._toolUseTracker=new Wr,this._generatedItems=[],this._currentTurnPersistedItemCount=0,this._maxTurns=o,this._inputGuardrailResults=[],this._outputGuardrailResults=[],this._trace=We()}get history(){return qe(this._originalInput,this._generatedItems)}getInterruptions(){return this._currentStep?.type!=="next_step_interruption"?[]:this._currentStep.data.interruptions}approve(t,n={alwaysApprove:!1}){this._context.approveTool(t,n)}reject(t,n={alwaysReject:!1}){this._context.rejectTool(t,n)}toJSON(){const t={$schemaVersion:vt,currentTurn:this._currentTurn,currentAgent:{name:this._currentAgent.name},originalInput:this._originalInput,modelResponses:this._modelResponses.map(r=>({usage:{requests:r.usage.requests,inputTokens:r.usage.inputTokens,outputTokens:r.usage.outputTokens,totalTokens:r.usage.totalTokens,inputTokensDetails:r.usage.inputTokensDetails,outputTokensDetails:r.usage.outputTokensDetails,...r.usage.requestUsageEntries&&r.usage.requestUsageEntries.length>0?{requestUsageEntries:r.usage.requestUsageEntries.map(o=>({inputTokens:o.inputTokens,outputTokens:o.outputTokens,totalTokens:o.totalTokens,inputTokensDetails:o.inputTokensDetails,outputTokensDetails:o.outputTokensDetails,...o.endpoint?{endpoint:o.endpoint}:{}}))}:{}},output:r.output,responseId:r.responseId,providerData:r.providerData})),context:this._context.toJSON(),toolUseTracker:this._toolUseTracker.toJSON(),maxTurns:this._maxTurns,currentAgentSpan:this._currentAgentSpan?.toJSON(),noActiveAgentRun:this._noActiveAgentRun,inputGuardrailResults:this._inputGuardrailResults,outputGuardrailResults:this._outputGuardrailResults.map(r=>({...r,agent:r.agent.toJSON()})),currentStep:this._currentStep,lastModelResponse:this._lastTurnResponse,generatedItems:this._generatedItems.map(r=>r.toJSON()),currentTurnPersistedItemCount:this._currentTurnPersistedItemCount,lastProcessedResponse:this._lastProcessedResponse,trace:this._trace?this._trace.toJSON():null},n=to.safeParse(t);if(!n.success)throw new Qp(`Failed to serialize run state. ${n.error.message}`);return n.data}toString(){return JSON.stringify(this.toJSON())}static async fromString(t,n){const[r,o]=await Sn(()=>JSON.parse(n));if(r)throw new M(`Failed to parse run state. ${r instanceof Error?r.message:String(r)}`);const s=o.$schemaVersion;if(!s)throw new M("Run state is missing schema version");if(s!==vt)throw new M(`Run state schema version ${s} is not supported. Please use version ${vt}`);const i=to.parse(JSON.parse(n)),a=Cm(t),c=new Le(i.context.context);c._rebuildApprovals(i.context.approvals);const u=a.get(i.currentAgent.name);if(!u)throw new M(`Agent ${i.currentAgent.name} not found`);const l=new ye(c,"",u,i.maxTurns);l._currentTurn=i.currentTurn,l._toolUseTracker=new Wr;for(const[d,f]of Object.entries(i.toolUseTracker))l._toolUseTracker.addToolUse(a.get(d),f);if(i.currentAgentSpan){i.trace||k.warn("Trace is not set, skipping tracing setup");const d=ge().createTrace({traceId:i.trace?.id,name:i.trace?.workflow_name,groupId:i.trace?.group_id??void 0,metadata:i.trace?.metadata});l._currentAgentSpan=fi(d,i.currentAgentSpan),l._trace=d}return l._noActiveAgentRun=i.noActiveAgentRun,l._inputGuardrailResults=i.inputGuardrailResults,l._outputGuardrailResults=i.outputGuardrailResults.map(d=>({...d,agent:a.get(d.agent.name)})),l._currentStep=i.currentStep,l._originalInput=i.originalInput,l._modelResponses=i.modelResponses.map(no),l._lastTurnResponse=i.lastModelResponse?no(i.lastModelResponse):void 0,l._generatedItems=i.generatedItems.map(d=>mi(d,a)),l._currentTurnPersistedItemCount=i.currentTurnPersistedItemCount??0,l._lastProcessedResponse=i.lastProcessedResponse?await Pm(a,l._currentAgent,l._context,i.lastProcessedResponse):void 0,i.currentStep?.type==="next_step_handoff"&&(l._currentStep={type:"next_step_handoff",newAgent:a.get(i.currentStep.newAgent.name)}),l}}function Cm(e){const t=new Map,n=[e];for(;n.length>0;){const r=n.shift();if(!t.has(r.name)){t.set(r.name,r);for(const o of r.handoffs)o instanceof ue?t.has(o.name)||n.push(o):o.agent&&(t.has(o.agent.name)||n.push(o.agent))}}return t}function fi(e,t){const n=t.span_data,r=t.previous_span?fi(e,t.previous_span):void 0,o=ge().createSpan({spanId:t.id,traceId:t.trace_id,parentId:t.parent_id??void 0,startedAt:t.started_at??void 0,endedAt:t.ended_at??void 0,data:n},e);return o.previousSpan=r,o}function no(e){return{usage:new lt(e.usage),output:e.output.map(n=>Zn.parse(n)),responseId:e.responseId,providerData:e.providerData}}function mi(e,t){switch(e.type){case"message_output_item":return new qt(e.rawItem,t.get(e.agent.name));case"tool_call_item":return new ve(e.rawItem,t.get(e.agent.name));case"tool_call_output_item":return new me(e.rawItem,t.get(e.agent.name),e.output);case"reasoning_item":return new Mn(e.rawItem,t.get(e.agent.name));case"handoff_call_item":return new jn(e.rawItem,t.get(e.agent.name));case"handoff_output_item":return new Fn(e.rawItem,t.get(e.sourceAgent.name),t.get(e.targetAgent.name));case"tool_approval_item":return new Y(e.rawItem,t.get(e.agent.name),e.toolName)}}async function Pm(e,t,n,r){const o=await t.getAllTools(n),s=new Map(o.filter(d=>d.type==="function").map(d=>[d.name,d])),i=new Map(o.filter(d=>d.type==="computer").map(d=>[d.name,d])),a=new Map(o.filter(d=>d.type==="shell").map(d=>[d.name,d])),c=new Map(o.filter(d=>d.type==="apply_patch").map(d=>[d.name,d])),u=new Map(t.handoffs.map(d=>d instanceof ue?[d.name,Js(d)]:[d.toolName,d])),l={newItems:r.newItems.map(d=>mi(d,e)),toolsUsed:r.toolsUsed,handoffs:r.handoffs.map(d=>{if(!u.has(d.handoff.toolName))throw new M(`Handoff ${d.handoff.toolName} not found`);return{toolCall:d.toolCall,handoff:u.get(d.handoff.toolName)}}),functions:await Promise.all(r.functions.map(async d=>{if(!s.has(d.tool.name))throw new M(`Tool ${d.tool.name} not found`);return{toolCall:d.toolCall,tool:s.get(d.tool.name)}})),computerActions:r.computerActions.map(d=>{const f=d.computer.name;if(!i.has(f))throw new M(`Computer tool ${f} not found`);return{toolCall:d.toolCall,computer:i.get(f)}}),shellActions:(r.shellActions??[]).map(d=>{const f=d.shell.name;if(!a.has(f))throw new M(`Shell tool ${f} not found`);return{toolCall:d.toolCall,shell:a.get(f)}}),applyPatchActions:(r.applyPatchActions??[]).map(d=>{const f=d.applyPatch.name;if(!c.has(f))throw new M(`Apply patch tool ${f} not found`);return{toolCall:d.toolCall,applyPatch:c.get(f)}}),mcpApprovalRequests:(r.mcpApprovalRequests??[]).map(d=>({requestItem:new Y(d.requestItem.rawItem,t),mcpTool:d.mcpTool}))};return{...l,hasToolsOrApprovalsToRun(){return l.handoffs.length>0||l.functions.length>0||l.mcpApprovalRequests.length>0||l.computerActions.length>0||l.shellActions.length>0||l.applyPatchActions.length>0}}}class Nm extends qd{config;constructor(t={}){super(),this.config={modelProvider:t.modelProvider??ef(),model:t.model,modelSettings:t.modelSettings,handoffInputFilter:t.handoffInputFilter,inputGuardrails:t.inputGuardrails,outputGuardrails:t.outputGuardrails,tracingDisabled:t.tracingDisabled??!1,traceIncludeSensitiveData:t.traceIncludeSensitiveData??!0,workflowName:t.workflowName??"Agent workflow",traceId:t.traceId,groupId:t.groupId,traceMetadata:t.traceMetadata,sessionInputCallback:t.sessionInputCallback,callModelInputFilter:t.callModelInputFilter},this.inputGuardrailDefs=(t.inputGuardrails??[]).map(Mr),this.outputGuardrailDefs=(t.outputGuardrails??[]).map(yn)}async run(t,n,r={stream:!1,context:void 0}){const o=r??{stream:!1,context:void 0},s=o.sessionInputCallback??this.config.sessionInputCallback,i=o.callModelInputFilter??this.config.callModelInputFilter,a=!!i,c={...o,sessionInputCallback:s,callModelInputFilter:i},u=!!c.conversationId||!!c.previousResponseId,l=c.session,d=n instanceof ye;let f=l&&d?[]:void 0,m,w=l&&d?new Map:void 0;const b=(T,I)=>{const O=w;if(I!==void 0){if(!O){m=I.map(ee=>structuredClone(ee));return}const D=[],q=new WeakMap;for(const ee of T){if(!ee||typeof ee!="object")continue;const se=(q.get(ee)??0)+1;q.set(ee,se)}const be=()=>{for(const[ee,se]of O)if(se>0)return O.set(ee,se-1),!0;return!1};for(let ee=0;ee<I.length;ee++){const se=I[ee];if(!se)continue;let pt=!1;const Ee=T[ee];if(Ee&&typeof Ee=="object"){const Vn=(q.get(Ee)??0)-1;if(q.set(Ee,Vn),Vn>0)continue;const Hn=ze(Ee),Kn=O.get(Hn)??0;if(Kn>0){O.set(Hn,Kn-1),D.push(structuredClone(se)),pt=!0;continue}}const Gn=ze(se),Wn=O.get(Gn)??0;if(Wn>0){O.set(Gn,Wn-1),D.push(structuredClone(se)),pt=!0;continue}!Ee&&be()&&(D.push(structuredClone(se)),pt=!0),!pt&&!Ee&&m===void 0&&D.push(structuredClone(se))}(D.length>0||m===void 0)&&(m=D);return}const P=[];if(O)for(const D of T){if(!D)continue;const q=ze(D),be=O.get(q)??0;be<=0||(O.set(q,be-1),P.push(structuredClone(D)))}else for(const D of T)D&&P.push(structuredClone(D));P.length>0?m=P:m===void 0&&(m=[])},v=()=>{if(m!==void 0)return m;if(!a)return f};let A=n;if(!(A instanceof ye)){if(l&&Array.isArray(A)&&!s)throw new M("RunConfig.sessionInputCallback must be provided when using session history with list inputs.");const T=await vm(A,l,s,{includeHistoryInPreparedInput:!u,preserveDroppedNewItems:u});if(u&&l){const I=T.sessionItems;I&&I.length>0?A=I:A=T.preparedInput}else A=T.preparedInput;if(l){const I=T.sessionItems??[];f=I.map(O=>structuredClone(O)),w=new Map;for(const O of I){const P=ze(O);w.set(P,(w.get(P)??0)+1)}}}let y;if(l&&!u){let T=!1;y=async()=>{if(T)return;const I=v();!I||I.length===0||(T=!0,await ym(l,I))}}const x=async()=>{if(c.stream)return await this.#s(t,A,c,y,b);const T=await this.#n(t,A,c,b);return l&&!u&&await _m(l,v(),T),T};return A instanceof ye&&A._trace?jm(A._trace,async()=>(A._currentAgentSpan&&Jn(A._currentAgentSpan),x())):Fm(async()=>x(),{traceId:this.config.traceId,name:this.config.workflowName,groupId:this.config.groupId,metadata:this.config.traceMetadata})}inputGuardrailDefs;outputGuardrailDefs;#e(t){return this.inputGuardrailDefs.concat(t._currentAgent.inputGuardrails.map(Mr))}#t(t){const n=this.#e(t),r=[],o=[];for(const s of n)s.runInParallel===!1?r.push(s):o.push(s);return{blocking:r,parallel:o}}async#o(t){const n=t.model!==void 0&&t.model!==ue.DEFAULT_MODEL_PLACEHOLDER||this.config.model!==void 0&&this.config.model!==ue.DEFAULT_MODEL_PLACEHOLDER;let r=zm(t.model,this.config.model);return typeof r=="string"&&(r=await this.config.modelProvider.getModel(r)),{model:r,explictlyModelSet:n}}async#n(t,n,r,o){return In(async()=>{const s=n instanceof ye,i=s?n:new ye(r.context instanceof Le?r.context:new Le(r.context),n,t,r.maxTurns??ro),a=r.conversationId||r.previousResponseId?new so({conversationId:r.conversationId,previousResponseId:r.previousResponseId}):void 0;a&&s&&a.primeFromState({originalInput:i._originalInput,generatedItems:i._generatedItems,modelResponses:i._modelResponses});let c=!1;try{for(;;){if(i._currentStep=i._currentStep??{type:"next_step_run_again"},i._currentStep.type==="next_step_interruption"){if(k.debug("Continuing from interruption"),!i._lastTurnResponse||!i._lastProcessedResponse)throw new M("No model response found in previous state",i);const u=await qr(i._currentAgent,i._originalInput,i._generatedItems,i._lastTurnResponse,i._lastProcessedResponse,this,i);if(i._toolUseTracker.addToolUse(i._currentAgent,i._lastProcessedResponse.toolsUsed),i._originalInput=u.originalInput,i._generatedItems=u.generatedItems,u.nextStep.type==="next_step_interruption")return i._currentStep=u.nextStep,new en(i);if(u.nextStep.type==="next_step_run_again"){c=!0,i._currentStep=void 0;continue}c=!1,i._currentStep=u.nextStep}if(i._currentStep.type==="next_step_run_again"){const u=await io(i),l=s&&c;if(c=!1,l||(i._currentTurn++,i._currentTurnPersistedItemCount=0),i._currentTurn>i._maxTurns)throw i._currentAgentSpan?.setError({message:"Max turns exceeded",data:{max_turns:i._maxTurns}}),new Ar(`Max turns (${i._maxTurns}) exceeded`,i);k.debug(`Running agent ${i._currentAgent.name} (turn ${i._currentTurn})`);let d;if(i._currentTurn===1&&!l){const v=this.#t(i);v.blocking.length>0&&await this.#i(i,v.blocking),v.parallel.length>0&&(d=this.#i(i,v.parallel),d.catch(()=>{}))}const f=a?a.prepareInput(i._originalInput,i._generatedItems):qe(i._originalInput,i._generatedItems);i._noActiveAgentRun&&(i._currentAgent.emit("agent_start",i._context,i._currentAgent,f),this.emit("agent_start",i._context,i._currentAgent,f));const m=await this.#u(i,r,u,f,a,o);i._lastTurnResponse=await m.model.getResponse({systemInstructions:m.modelInput.instructions,prompt:m.prompt,...m.explictlyModelSet?{overridePromptModel:!0}:{},input:m.modelInput.input,previousResponseId:m.previousResponseId,conversationId:m.conversationId,modelSettings:m.modelSettings,tools:m.serializedTools,toolsExplicitlyProvided:m.toolsExplicitlyProvided,outputType:Or(i._currentAgent.outputType),handoffs:m.serializedHandoffs,tracing:oo(this.config.tracingDisabled,this.config.traceIncludeSensitiveData),signal:r.signal}),i._modelResponses.push(i._lastTurnResponse),i._context.usage.add(i._lastTurnResponse.usage),i._noActiveAgentRun=!1,a?.trackServerItems(i._lastTurnResponse);const w=Jr(i._lastTurnResponse,i._currentAgent,m.tools,m.handoffs);i._lastProcessedResponse=w;const b=await Br(i._currentAgent,i._originalInput,i._generatedItems,i._lastTurnResponse,i._lastProcessedResponse,this,i);i._toolUseTracker.addToolUse(i._currentAgent,i._lastProcessedResponse.toolsUsed),i._originalInput=b.originalInput,i._generatedItems=b.generatedItems,b.nextStep.type==="next_step_run_again"&&(i._currentTurnPersistedItemCount=0),i._currentStep=b.nextStep,d&&await d}if(i._currentStep&&i._currentStep.type==="next_step_final_output")return await this.#r(i,i._currentStep.output),this.emit("agent_end",i._context,i._currentAgent,i._currentStep.output),i._currentAgent.emit("agent_end",i._context,i._currentStep.output),new en(i);if(i._currentStep&&i._currentStep.type==="next_step_handoff")i._currentAgent=i._currentStep.newAgent,i._currentAgentSpan&&(i._currentAgentSpan.end(),Qe(),i._currentAgentSpan=void 0),i._noActiveAgentRun=!0,i._currentStep={type:"next_step_run_again"};else{if(i._currentStep&&i._currentStep.type==="next_step_interruption")return new en(i);k.debug("Running next loop")}}}catch(u){throw i._currentAgentSpan&&i._currentAgentSpan.setError({message:"Error in agent run",data:{error:String(u)}}),u}finally{if(i._currentStep?.type!=="next_step_interruption")try{await Rr({runContext:i._context})}catch(u){k.warn(`Failed to dispose computers after run: ${u}`)}i._currentAgentSpan&&(i._currentStep?.type!=="next_step_interruption"&&i._currentAgentSpan.end(),Qe())}})}async#a(t,n,r,o,s){const i=!!n.conversationId||!!n.previousResponseId,a=i?new so({conversationId:n.conversationId,previousResponseId:n.previousResponseId}):void 0;let c=!1,u=!1;const l=async()=>{u||!o||(await o(),u=!0)};a&&r&&a.primeFromState({originalInput:t.state._originalInput,generatedItems:t.state._generatedItems,modelResponses:t.state._modelResponses});let d=!1;try{for(;;){const f=t.state._currentAgent;if(t.state._currentStep=t.state._currentStep??{type:"next_step_run_again"},t.state._currentStep.type==="next_step_interruption"){if(k.debug("Continuing from interruption"),!t.state._lastTurnResponse||!t.state._lastProcessedResponse)throw new M("No model response found in previous state",t.state);const m=await qr(t.state._currentAgent,t.state._originalInput,t.state._generatedItems,t.state._lastTurnResponse,t.state._lastProcessedResponse,this,t.state);if(Gr(t,m),t.state._toolUseTracker.addToolUse(t.state._currentAgent,t.state._lastProcessedResponse.toolsUsed),t.state._originalInput=m.originalInput,t.state._generatedItems=m.generatedItems,m.nextStep.type==="next_step_interruption"){t.state._currentStep=m.nextStep;return}if(m.nextStep.type==="next_step_run_again"){d=!0,t.state._currentStep=void 0;continue}d=!1,t.state._currentStep=m.nextStep}if(t.state._currentStep.type==="next_step_run_again"){const m=await io(t.state),w=r&&d;if(d=!1,w||(t.state._currentTurn++,t.state._currentTurnPersistedItemCount=0),t.state._currentTurn>t.state._maxTurns)throw t.state._currentAgentSpan?.setError({message:"Max turns exceeded",data:{max_turns:t.state._maxTurns}}),new Ar(`Max turns (${t.state._maxTurns}) exceeded`,t.state);k.debug(`Running agent ${f.name} (turn ${t.state._currentTurn})`);let b,v;if(t.state._currentTurn===1&&!w){const P=this.#t(t.state);P.blocking.length>0&&await this.#i(t.state,P.blocking),P.parallel.length>0&&(v=this.#i(t.state,P.parallel).catch(q=>(b=q,[])))}const A=a?a.prepareInput(t.input,t.newItems):qe(t.input,t.newItems);t.state._noActiveAgentRun&&(f.emit("agent_start",t.state._context,f,A),this.emit("agent_start",t.state._context,f,A));let y;const x=await this.#u(t.state,n,m,A,a,s);if(b)throw b;c=!0,await l();for await(const P of x.model.getStreamedResponse({systemInstructions:x.modelInput.instructions,prompt:x.prompt,...x.explictlyModelSet?{overridePromptModel:!0}:{},input:x.modelInput.input,previousResponseId:x.previousResponseId,conversationId:x.conversationId,modelSettings:x.modelSettings,tools:x.serializedTools,toolsExplicitlyProvided:x.toolsExplicitlyProvided,handoffs:x.serializedHandoffs,outputType:Or(f.outputType),tracing:oo(this.config.tracingDisabled,this.config.traceIncludeSensitiveData),signal:n.signal})){if(b)throw b;if(P.type==="response_done"){const D=ti.parse(P);y={usage:new lt(D.response.usage),output:D.response.output,responseId:D.response.id},t.state._context.usage.add(y.usage)}if(t.cancelled)return;t._addItem(new Vf(P))}if(v&&(await v,b))throw b;if(t.state._noActiveAgentRun=!1,!y)throw new X("Model did not produce a final response!",t.state);t.state._lastTurnResponse=y,a?.trackServerItems(y),t.state._modelResponses.push(t.state._lastTurnResponse);const T=Jr(t.state._lastTurnResponse,f,x.tools,x.handoffs);t.state._lastProcessedResponse=T;const I=new Set(T.newItems);I.size>0&&dm(t,T.newItems);const O=await Br(f,t.state._originalInput,t.state._generatedItems,t.state._lastTurnResponse,t.state._lastProcessedResponse,this,t.state);Gr(t,O,{skipItems:I}),t.state._toolUseTracker.addToolUse(f,T.toolsUsed),t.state._originalInput=O.originalInput,t.state._generatedItems=O.generatedItems,O.nextStep.type==="next_step_run_again"&&(t.state._currentTurnPersistedItemCount=0),t.state._currentStep=O.nextStep}if(t.state._currentStep.type==="next_step_final_output"){await this.#r(t.state,t.state._currentStep.output),await l(),i||await Vr(n.session,t),this.emit("agent_end",t.state._context,f,t.state._currentStep.output),f.emit("agent_end",t.state._context,t.state._currentStep.output);return}else if(t.state._currentStep.type==="next_step_interruption"){await l(),i||await Vr(n.session,t);return}else t.state._currentStep.type==="next_step_handoff"?(t.state._currentAgent=t.state._currentStep?.newAgent,t.state._currentAgentSpan&&(t.state._currentAgentSpan.end(),Qe()),t.state._currentAgentSpan=void 0,t._addItem(new Kf(t.state._currentAgent)),t.state._noActiveAgentRun=!0,t.state._currentStep={type:"next_step_run_again"}):k.debug("Running next loop")}}catch(f){throw c&&!u&&await l(),t.state._currentAgentSpan&&t.state._currentAgentSpan.setError({message:"Error in agent run",data:{error:String(f)}}),f}finally{if(t.state._currentStep?.type!=="next_step_interruption")try{await Rr({runContext:t.state._context})}catch(f){k.warn(`Failed to dispose computers after run: ${f}`)}t.state._currentAgentSpan&&(t.state._currentStep?.type!=="next_step_interruption"&&t.state._currentAgentSpan.end(),Qe())}}async#s(t,n,r,o,s){return r=r??{},In(async()=>{const i=n instanceof ye,a=i?n:new ye(r.context instanceof Le?r.context:new Le(r.context),n,t,r.maxTurns??ro),c=new gi({signal:r.signal,state:a});c.maxTurns=r.maxTurns??a._maxTurns;const u=this.#a(c,r,i,o,s).then(()=>{c._done()},l=>{c._raiseError(l)});return c._setStreamLoopPromise(u),c})}async#i(t,n){const r=n??this.#e(t);if(r.length>0){const o={agent:t._currentAgent,input:t._originalInput,context:t._context};try{const s=await Promise.all(r.map(async i=>Fr(async a=>{const c=await i.run(o);return a.spanData.triggered=c.output.tripwireTriggered,c},{data:{name:i.name}},t._currentAgentSpan)));t._inputGuardrailResults.push(...s);for(const i of s)if(i.output.tripwireTriggered)throw t._currentAgentSpan&&t._currentAgentSpan.setError({message:"Guardrail tripwire triggered",data:{guardrail:i.guardrail.name}}),new xr(`Input guardrail triggered: ${JSON.stringify(i.output.outputInfo)}`,i,t);return s}catch(s){throw s instanceof xr?s:(t._currentTurn--,new kr(`Input guardrail failed to complete: ${s}`,s,t))}}return[]}async#r(t,n){const r=this.outputGuardrailDefs.concat(t._currentAgent.outputGuardrails.map(yn));if(r.length>0){const o=t._currentAgent.processFinalOutput(n),s=qe([],t._generatedItems),i={agent:t._currentAgent,agentOutput:o,context:t._context,details:{modelResponse:t._lastTurnResponse,output:s}};try{const a=await Promise.all(r.map(async c=>Fr(async u=>{const l=await c.run(i);return u.spanData.triggered=l.output.tripwireTriggered,l},{data:{name:c.name}},t._currentAgentSpan)));for(const c of a)if(c.output.tripwireTriggered)throw t._currentAgentSpan&&t._currentAgentSpan.setError({message:"Guardrail tripwire triggered",data:{guardrail:c.guardrail.name}}),new dn(`Output guardrail triggered: ${JSON.stringify(c.output.outputInfo)}`,c,t)}catch(a){throw a instanceof dn?a:new kr(`Output guardrail failed to complete: ${a}`,a,t)}}}async#u(t,n,r,o,s,i){const{model:a,explictlyModelSet:c}=await this.#o(t._currentAgent);let u={...this.config.modelSettings,...t._currentAgent.modelSettings};u=$m(c,t._currentAgent.modelSettings,a,u),u=nm(t._currentAgent,t._toolUseTracker,u);const l=await t._currentAgent.getSystemPrompt(t._context),d=await t._currentAgent.getPrompt(t._context),{modelInput:f,sourceItems:m,persistedItems:w,filterApplied:b}=await Dm(t._currentAgent,n.callModelInputFilter,t._context,o,l);s?.markInputAsSent(m),i?.(m,b?w:void 0);const v=s?.previousResponseId??n.previousResponseId,A=s?.conversationId??n.conversationId;return{...r,model:a,explictlyModelSet:c,modelSettings:u,modelInput:f,prompt:d,previousResponseId:v,conversationId:A}}}function qe(e,t){const n=t.filter(r=>r.type!=="tool_approval_item").map(r=>r.rawItem);return[...bn(e),...n]}const ro=10;function zm(e,t){return typeof e=="string"&&e!==ue.DEFAULT_MODEL_PLACEHOLDER||e?e:t??e??ue.DEFAULT_MODEL_PLACEHOLDER}function oo(e,t){return e?!1:t?!0:"enabled_without_data"}async function Dm(e,t,n,r,o){const s=(m,w)=>m.map(b=>{const v=structuredClone(b);return w&&v&&typeof v=="object"&&w.set(v,b),v}),i=new WeakMap,a=Rm(r),c=[];for(const m of r)m&&typeof m=="object"&&c.push(m);const u=m=>{if(!m||typeof m!="object")return;const w=c.findIndex(b=>b===m);w!==-1&&c.splice(w,1)},l=()=>{const m=c.shift();return m&&ao(a,m),m},f={input:s(r,i),instructions:o};if(!t)return{modelInput:f,sourceItems:[...r],persistedItems:[],filterApplied:!1};try{const m=await t({modelData:f,agent:e,context:n.context});if(!m||!Array.isArray(m.input))throw new M("callModelInputFilter must return a ModelInputData object with an input array.");const w=m.input.map(v=>{if(!v||typeof v!="object")return;const A=i.get(v);if(A)return u(A),ao(a,A),A;const y=ze(v),x=Zm(a,y);if(x)return u(x),x;const T=l();if(T)return T}),b=s(m.input);return{modelInput:{input:b,instructions:typeof m.instructions>"u"?o:m.instructions},sourceItems:w,persistedItems:b.map(v=>structuredClone(v)),filterApplied:!0}}catch(m){throw we({message:"Error in callModelInputFilter",data:{error:String(m)}}),m}}class so{conversationId;previousResponseId;sentInitialInput=!1;sentItems=new WeakSet;serverItems=new WeakSet;remainingInitialInput=null;constructor({conversationId:t,previousResponseId:n}){this.conversationId=t??void 0,this.previousResponseId=n??void 0}primeFromState({originalInput:t,generatedItems:n,modelResponses:r}){if(this.sentInitialInput)return;for(const s of bn(t))s&&typeof s=="object"&&this.sentItems.add(s);this.sentInitialInput=!0,this.remainingInitialInput=null;const o=r[r.length-1];for(const s of r)for(const i of s.output)i&&typeof i=="object"&&this.serverItems.add(i);!this.conversationId&&o?.responseId&&(this.previousResponseId=o.responseId);for(const s of n){const i=s.rawItem;!i||typeof i!="object"||this.serverItems.has(i)&&this.sentItems.add(i)}}trackServerItems(t){if(t){for(const n of t.output)n&&typeof n=="object"&&this.serverItems.add(n);!this.conversationId&&t.responseId&&(this.previousResponseId=t.responseId)}}prepareInput(t,n){const r=[];if(this.sentInitialInput)this.remainingInitialInput&&this.remainingInitialInput.length>0&&r.push(...this.remainingInitialInput);else{const o=bn(t);r.push(...o),this.remainingInitialInput=o.filter(s=>!!s&&typeof s=="object"),this.sentInitialInput=!0}for(const o of n){if(o.type==="tool_approval_item")continue;const s=o.rawItem;!s||typeof s!="object"||this.sentItems.has(s)||this.serverItems.has(s)||r.push(s)}return r}markInputAsSent(t){if(!t.length)return;const n=new Set;for(const r of t)!r||typeof r!="object"||n.has(r)||(n.add(r),this.sentItems.add(r));!this.remainingInitialInput||this.remainingInitialInput.length===0||(this.remainingInitialInput=this.remainingInitialInput.filter(r=>!n.has(r)),this.remainingInitialInput.length===0&&(this.remainingInitialInput=null))}}function $m(e,t,n,r){if(js()&&e&&(typeof n!="string"||!Ft(n))&&(t.providerData?.reasoning||t.providerData?.text?.verbosity||t.providerData?.reasoning_effort)){const o={...r};return delete o.providerData?.reasoning,delete o.providerData?.text?.verbosity,delete o.providerData?.reasoning_effort,o.reasoning&&(delete o.reasoning.effort,delete o.reasoning.summary),o.text&&delete o.text.verbosity,o}return r}async function io(e){const t=await e._currentAgent.getEnabledHandoffs(e._context),n=await e._currentAgent.getAllTools(e._context),r=n.filter(o=>o.type==="computer");if(r.length>0&&await Promise.all(r.map(async o=>{await Zs({tool:o,runContext:e._context})})),e._currentAgentSpan)e._currentAgentSpan.spanData.tools=n.map(o=>o.name);else{const o=t.map(s=>s.agentName);e._currentAgentSpan=Lf({data:{name:e._currentAgent.name,handoffs:o,tools:n.map(s=>s.name),output_type:e._currentAgent.outputSchemaName}}),e._currentAgentSpan.start(),Jn(e._currentAgentSpan)}return{handoffs:t,tools:n,serializedHandoffs:t.map(o=>Ff(o)),serializedTools:n.map(o=>jf(o)),toolsExplicitlyProvided:e._currentAgent.hasExplicitToolConfig()}}function ze(e){return JSON.stringify(e,Mm)}function Rm(e){const t=new Map;for(const n of e){const r=ze(n),o=t.get(r);o?o.push(n):t.set(r,[n])}return t}function Zm(e,t){const n=e.get(t);if(!n||n.length===0)return;const[r]=n;return n.shift(),n.length===0&&e.delete(t),r}function ao(e,t){const n=ze(t),r=e.get(n);if(!r||r.length===0)return;const o=r.findIndex(s=>s===t);o!==-1&&(r.splice(o,1),r.length===0&&e.delete(n))}function Mm(e,t){if(t instanceof ArrayBuffer)return{__type:"ArrayBuffer",data:ne(new Uint8Array(t))};if(ct(t)){const n=t;return{__type:n.constructor.name,data:ne(new Uint8Array(n.buffer,n.byteOffset,n.byteLength))}}if(Pn(t)){const n=t;return{__type:"Buffer",data:ne(new Uint8Array(n.buffer,n.byteOffset,n.byteLength))}}return Mt(t)?{__type:"Buffer",data:ne(Uint8Array.from(t.data))}:t}function bn(e){return typeof e=="string"?[{type:"message",role:"user",content:e}]:[...e]}class hi{state;constructor(t){this.state=t}get history(){return qe(this.input,this.newItems)}get output(){return qe([],this.newItems)}get input(){return this.state._originalInput}get newItems(){return this.state._generatedItems}get rawResponses(){return this.state._modelResponses}get lastResponseId(){const t=this.rawResponses;return t&&t.length>0?t[t.length-1].responseId:void 0}get lastAgent(){return this.state._currentAgent}get inputGuardrailResults(){return this.state._inputGuardrailResults}get outputGuardrailResults(){return this.state._outputGuardrailResults}get interruptions(){return this.state._currentStep?.type==="next_step_interruption"?this.state._currentStep.data.interruptions:[]}get finalOutput(){if(this.state._currentStep?.type==="next_step_final_output")return this.state._currentAgent.processFinalOutput(this.state._currentStep.output);k.warn("Accessed finalOutput before agent run is completed.")}}class en extends hi{constructor(t){super(t)}}class gi extends hi{get currentAgent(){return this.lastAgent}currentTurn=0;maxTurns;#e=null;#t;#o;#n;#a;#s;#i;#r=!1;#u;constructor(t={}){if(super(t.state),this.#t=t.signal,this.#n=new Md({start:n=>{this.#o=n},cancel:()=>{this.#r=!0}}),this.#a=new Promise((n,r)=>{this.#s=n,this.#i=r}),this.#t){const n=()=>{if(this.#r)return;this.#r=!0;const r=this.#o;if(this.#o=void 0,this.#n.locked){if(r)try{r.close()}catch(o){k.debug(`Failed to close readable stream on abort: ${o}`)}}else this.#n.cancel(this.#t?.reason).catch(o=>{k.debug(`Failed to cancel readable stream on abort: ${o}`)});this.#s?.()};this.#t.aborted?n():this.#t.addEventListener("abort",n,{once:!0})}}_addItem(t){this.cancelled||this.#o?.enqueue(t)}_done(){!this.cancelled&&this.#o&&(this.#o.close(),this.#o=void 0,this.#s?.())}_raiseError(t){!this.cancelled&&this.#o&&(this.#o.error(t),this.#o=void 0),this.#e=t,this.#i?.(t),this.#a.catch(n=>{k.debug(`Resulted in an error: ${n}`)})}get cancelled(){return this.#r}toStream(){return this.#n}get completed(){return this.#a}get error(){return this.#e}toTextStream(t={}){const n=this.#n.pipeThrough(new jd({transform(r,o){if(r.type==="raw_model_stream_event"&&r.data.type==="output_text_delta"){const s=ei.parse(r.data);o.enqueue(s.delta)}}}));return t.compatibleWithNodeStreams?Zd.fromWeb(n):n}[Symbol.asyncIterator](){return this.#n[Symbol.asyncIterator]()}_setStreamLoopPromise(t){this.#u=t}_getStreamLoopPromise(){return this.#u}}let uo;function he(){return uo??=new Fd,uo}function We(){const e=he().getStore();return e?.trace?e.trace:null}function it(){const e=he().getStore();return e?.span?e.span:null}function _i(e){return async()=>{const t=We();if(!t)throw new Error("No trace found");await t.start();const n=await e(t);if(n instanceof gi){const r=n._getStreamLoopPromise();if(r)return r.finally(()=>t.end()),n}return await t.end(),n}}async function jm(e,t,n={}){const r=typeof e=="string"?ge().createTrace({...n,name:e}):e;return he().run({trace:r},_i(t))}async function Fm(e,t={}){if(We())return await e();const r=ge().createTrace(t);return he().run({trace:r},_i(e))}function Jn(e){const t=he().getStore();if(!t)throw new Error("No existing trace found");t.span&&(t.span.previousSpan=t.previousSpan,t.previousSpan=t.span),e.previousSpan=t.span??t.previousSpan,t.span=e,he().enterWith(t)}function Qe(){const e=he().getStore();e&&(e.span=e.previousSpan,e.previousSpan=e.previousSpan?.previousSpan,he().enterWith(e))}function we(e){const t=it();t&&t.setError(e)}function Lm(e){return{trace:e.trace?.clone(),span:e.span?.clone(),previousSpan:e.previousSpan?.clone()}}function In(e){const t=he().getStore();if(!t)throw new Error("No existing trace found");const n=Lm(t);return he().run(n,e)}class Um{async export(t){if(Ns.disabled){k.debug("Tracing is disabled. Skipping export");return}for(const n of t)n.type==="trace"?console.log(`[Exporter] Export trace traceId=${n.traceId} name=${n.name}${n.groupId?` groupId=${n.groupId}`:""}`):console.log(`[Exporter] Export span: ${JSON.stringify(n)}`)}}class Jm{#e;#t;#o;#n;#a;#s=[];#i;#r=null;#u=!1;#l=null;constructor(t,{maxQueueSize:n=1e3,maxBatchSize:r=100,scheduleDelay:o=5e3,exportTriggerRatio:s=.8}={}){this.#e=n,this.#t=r,this.#o=o,this.#n=n*s,this.#a=t,this.#i=Ud,k.debug("Automatic trace export loop is not supported in this environment. You need to manually call `getGlobalTraceProvider().forceFlush()` to export traces.")}start(){this.#l=new AbortController,this.#d()}async#c(t){if(this.#s.length+1>this.#e){k.error("Dropping trace because buffer is full");return}this.#s.push(t),this.#s.length>this.#n&&await this.#p()}#d(){this.#r=this.#i.setTimeout(async()=>{await this.#p(),this.#d()},this.#o),typeof this.#r.unref=="function"&&this.#r.unref()}async#p(t=!1){if(this.#s.length!==0){if(k.debug(`Exporting batches. Force: ${t}. Buffer size: ${this.#s.length}`),t||this.#s.length<this.#t){const n=[...this.#s];this.#s=[],this.#u=!0,await this.#a.export(n),this.#u=!1}else if(this.#s.length>0){const n=this.#s.splice(0,this.#t);this.#u=!0,await this.#a.export(n),this.#u=!1}}}async onTraceStart(t){await this.#c(t)}async onTraceEnd(t){}async onSpanStart(t){}async onSpanEnd(t){await this.#c(t)}async shutdown(t){for(t&&this.#i.setTimeout(()=>{this.#l?.abort()},t),k.debug("Shutting down gracefully");this.#s.length>0;){if(k.debug(`Waiting for buffer to empty. Items left: ${this.#s.length}`),this.#u||await this.#p(!0),this.#l?.signal.aborted){k.debug("Timeout reached, force flushing"),await this.#p(!0);break}await new Promise(n=>this.#i.setTimeout(n,500))}k.debug("Buffer empty. Exiting"),this.#i&&this.#r&&this.#i.clearTimeout(this.#r)}async forceFlush(){this.#s.length>0&&await this.#p(!0)}}class qm{#e=[];start(){for(const t of this.#e)t.start&&t.start()}addTraceProcessor(t){this.#e.push(t)}setProcessors(t){k.debug("Shutting down old processors");for(const n of this.#e)n.shutdown();this.#e=t}async onTraceStart(t){for(const n of this.#e)await n.onTraceStart(t)}async onTraceEnd(t){for(const n of this.#e)await n.onTraceEnd(t)}async onSpanStart(t){for(const n of this.#e)await n.onSpanStart(t)}async onSpanEnd(t){for(const n of this.#e)await n.onSpanEnd(t)}async shutdown(t){for(const n of this.#e)await n.shutdown(t)}async forceFlush(){for(const t of this.#e)await t.forceFlush()}}let tn=null,nn=null;function Bm(){return tn||(tn=new Um),tn}function yi(){return nn||(nn=new Jm(Bm())),nn}function co(){return new Date().toISOString()}function vi(){return`trace_${Ms().replace(/-/g,"")}`}function Gm(){return`span_${Ms().replace(/-/g,"").slice(0,24)}`}function Wm(e){return Object.fromEntries(Object.entries(e).filter(([t])=>!t.startsWith("_")))}class at{type="trace.span";#e;#t;#o;#n;#a;#s;#i;#r;#u;constructor(t,n){this.#t=t.traceId,this.#o=t.spanId??Gm(),this.#e=t.data,this.#a=n,this.#n=t.parentId??null,this.#r=t.error??null,this.#s=t.startedAt??null,this.#i=t.endedAt??null}get traceId(){return this.#t}get spanData(){return this.#e}get spanId(){return this.#o}get parentId(){return this.#n}get previousSpan(){return this.#u}set previousSpan(t){this.#u=t}start(){if(this.#s){k.warn("Span already started");return}this.#s=co(),this.#a.onSpanStart(this)}end(){if(this.#i){k.debug("Span already finished",this.spanData);return}this.#i=co(),this.#a.onSpanEnd(this)}setError(t){this.#r=t}get error(){return this.#r}get startedAt(){return this.#s}get endedAt(){return this.#i}clone(){const t=new at({traceId:this.traceId,spanId:this.spanId,parentId:this.parentId??void 0,data:this.spanData,startedAt:this.#s??void 0,endedAt:this.#i??void 0,error:this.#r??void 0},this.#a);return t.previousSpan=this.previousSpan?.clone(),t}toJSON(){return{object:this.type,id:this.spanId,trace_id:this.traceId,parent_id:this.parentId,started_at:this.startedAt,ended_at:this.endedAt,span_data:Wm(this.spanData),error:this.error}}}class Ie extends at{constructor(t,n){super({traceId:"no-op",spanId:"no-op",data:t},n)}start(){}end(){}setError(){}toJSON(){return null}}class ut{type="trace";traceId;name;groupId=null;metadata;#e;#t;constructor(t,n){this.traceId=t.traceId??vi(),this.name=t.name??"Agent workflow",this.groupId=t.groupId??null,this.metadata=t.metadata??{},this.#e=n??yi(),this.#t=t.started??!1}async start(){this.#t||(this.#t=!0,await this.#e.onTraceStart(this))}async end(){this.#t&&(this.#t=!1,await this.#e.onTraceEnd(this))}clone(){return new ut({traceId:this.traceId,name:this.name,groupId:this.groupId??void 0,metadata:this.metadata,started:this.#t})}toJSON(){return{object:this.type,id:this.traceId,workflow_name:this.name,group_id:this.groupId,metadata:this.metadata}}}class rn extends ut{constructor(){super({})}async start(){}async end(){}toJSON(){return null}}class Vm{#e;#t;constructor(){this.#e=new qm,this.#t=Ns.disabled,this.#o()}registerProcessor(t){this.#e.addTraceProcessor(t)}setProcessors(t){this.#e.setProcessors(t)}getCurrentTrace(){return We()}getCurrentSpan(){return it()}setDisabled(t){this.#t=t}startExportLoop(){this.#e.start()}createTrace(t){if(this.#t)return k.debug("Tracing is disabled, Not creating trace %o",t),new rn;const n=t.traceId??vi(),r=t.name??"Agent workflow";return k.debug("Creating trace %s with name %s",n,r),new ut({...t,name:r,traceId:n},this.#e)}createSpan(t,n){if(this.#t||t.disabled)return k.debug("Tracing is disabled, Not creating span %o",t),new Ie(t.data,this.#e);let r,o;if(n){if(n instanceof ut){if(n instanceof rn)return k.debug("Parent trace is no-op, returning NoopSpan"),new Ie(t.data,this.#e);o=n.traceId}else if(n instanceof at){if(n instanceof Ie)return k.debug("Parent span is no-op, returning NoopSpan"),new Ie(t.data,this.#e);r=n.spanId,o=n.traceId}}else{const s=We(),i=it();if(!s)return k.error("No active trace. Make sure to start a trace with `withTrace()` first. Returning NoopSpan."),new Ie(t.data,this.#e);if(i instanceof Ie||s instanceof rn)return k.debug(`Parent ${i} or ${s} is no-op, returning NoopSpan`),new Ie(t.data,this.#e);o=s.traceId,i?(k.debug("Using parent span %s",i.spanId),r=i.spanId):k.debug("No parent span, using current trace %s",s.traceId)}return o?(k.debug(`Creating span ${JSON.stringify(t.data)} with id ${t.spanId??o}`),new at({...t,traceId:o,parentId:r},this.#e)):(k.error("No traceId found. Make sure to start a trace with `withTrace()` first. Returning NoopSpan."),new Ie(t.data,this.#e))}async shutdown(t){try{k.debug("Shutting down tracing provider"),await this.#e.shutdown(t)}catch(n){k.error("Error shutting down tracing provider %o",n)}}#o(){if(typeof process<"u"&&typeof process.on=="function"){const t=async()=>{const n=setTimeout(()=>{console.warn("Cleanup timeout, forcing exit"),process.exit(1)},5e3);try{await this.shutdown()}finally{clearTimeout(n)}};process.on("beforeExit",t),process.on("SIGINT",async()=>{await t(),lo("SIGINT")||process.exit(130)}),process.on("SIGTERM",async()=>{await t(),lo("SIGTERM")||process.exit(0)}),process.on("unhandledRejection",async(n,r)=>{k.error("Unhandled rejection",n,r),await t(),Hm("unhandledRejection")||process.exit(1)})}}async forceFlush(){await this.#e.forceFlush()}}function lo(e){return process.listeners(e).length>1}function Hm(e){return process.listeners(e).length>1}let on;function ge(){return on||(on=new Vm),on}function Km(e){ge().registerProcessor(e)}Km(yi());function Ym(e){const t=atob(e),n=t.length,r=new Uint8Array(n);for(let o=0;o<n;o++)r[o]=t.charCodeAt(o);return r.buffer}function Xm(e){const t=String.fromCharCode(...new Uint8Array(e));return btoa(t)}function Qm(e){if(typeof e>"u"||e===null||typeof e!="object"||!("type"in e)||typeof e.type!="string"||!e.type||e.type!=="message"||!("content"in e)||!Array.isArray(e.content)||e.content.length<1)return;const t=e.content[e.content.length-1];if(!(!("type"in t)||typeof t.type!="string")){if(t.type==="output_text")return typeof t.text=="string"?t.text:void 0;if(t.type==="output_audio")return typeof t.transcript=="string"?t.transcript:void 0}}function eh(e,t){const n=e.filter(s=>!t.some(i=>i.itemId===s.itemId)),r=t.filter(s=>!e.some(i=>i.itemId===s.itemId)),o=t.filter(s=>e.some(i=>i.itemId===s.itemId&&JSON.stringify(i)!==JSON.stringify(s)));return{removals:n,additions:r,updates:o}}function th(){return typeof window>"u"?!1:typeof window.RTCPeerConnection<"u"}function po(e){return e.role==="system"?e:e.role==="assistant"?{...e,content:e.content.map(t=>t.type==="output_audio"?{...t,audio:null}:t)}:e.role==="user"?{...e,content:e.content.map(t=>t.type==="input_audio"?{...t,audio:null}:t)}:e}function nh(e,t){if(e.role!=="assistant"||t.role!=="assistant")return t;const n=t.content.map((r,o)=>{if(r.type!=="output_audio"||!(typeof r.transcript!="string"||r.transcript.length===0))return r;const i=e.content[o];return i&&i.type==="output_audio"&&typeof i.transcript=="string"&&i.transcript.length>0?{...r,transcript:i.transcript}:r});return{...t,content:n}}function fo(e,t,n){if(t.type==="conversation.item.input_audio_transcription.completed")return e.map(s=>{if(s.itemId===t.item_id&&s.type==="message"&&"role"in s&&s.role==="user"){const i=s.content.map(a=>a.type==="input_audio"?{...a,transcript:t.transcript}:a);return{...s,content:i,status:"completed"}}return s});const r=!n&&t.type==="message"?po(t):t,o=e.findIndex(s=>s.itemId===t.itemId);if(o!==-1){const s=e[o],i=r.type==="message"&&s.type==="message"?nh(s,r):r;return e.map((a,c)=>c===o?i:!n&&a.type==="message"?po(a):a)}else if(t.previousItemId){const s=e.findIndex(i=>i.itemId===t.previousItemId);return s!==-1?[...e.slice(0,s+1),r,...e.slice(s+1)]:[...e,r]}else return[...e,r]}const wi={"User-Agent":`Agents/JavaScript ${sn.version}`,"X-OpenAI-Agents-SDK":`openai-agents-sdk.${sn.version}`},rh=`openai-agents-sdk.${sn.version}`;function oh(e,t){const{name:n,arguments:r,...o}=t;return new Y({type:"hosted_tool_call",name:n,arguments:JSON.stringify(r),status:"in_progress",providerData:{...o}},e)}function mo(e){if(e.rawItem.type!=="function_call"&&e.rawItem.type!=="hosted_tool_call")throw new Error("Invalid approval item type for Realtime MCP approval request");const{name:t,arguments:n,providerData:r}=e.rawItem,{itemId:o,serverLabel:s,...i}=r??{};if(!o||!s)throw new Error("Invalid approval item for Realtime MCP approval request");return{type:"mcp_approval_request",itemId:o,serverLabel:s,...i,name:t,arguments:n?JSON.parse(n):{},approved:null}}class sh extends ue{voice;constructor(t){super(t),this.voice=t.voice}}function ih(e){return{debounceTextLength:e.debounceTextLength??100}}function ah({policyHint:e,...t}){const n=yn(t),r=e??n.name;return{...n,policyHint:r,run:async o=>{const s=await n.run(o);return{...s,guardrail:{...s.guardrail,policyHint:r}}}}}function uh(e){return`
 Your last answer was blocked. 
Failed Guardrail Reason: ${e.guardrail.policyHint}. 
Failure Details: ${JSON.stringify(e.output.outputInfo??{})}. 
Please respond again following policy. Apologize for not being able to answer the question (while avoiding the specific reason) and divert discussion back to an approved topic immediately and not invite more discussion.
`.trim()}function Ce(e,t){return e in t&&typeof t[e]<"u"}function ch(e){return Ce("modalities",e)||Ce("inputAudioFormat",e)||Ce("outputAudioFormat",e)||Ce("inputAudioTranscription",e)||Ce("turnDetection",e)||Ce("inputAudioNoiseReduction",e)||Ce("speed",e)}function lh(e){if(!ch(e)){const t=e.audio?.input?{format:yt(e.audio.input.format),noiseReduction:e.audio.input.noiseReduction??null,transcription:e.audio.input.transcription,turnDetection:e.audio.input.turnDetection}:void 0,n=e.audio?.output?.voice??e.voice,r=e.audio?.output||typeof n<"u"?{format:yt(e.audio?.output?.format),voice:n,speed:e.audio?.output?.speed}:void 0;return{model:e.model,instructions:e.instructions,toolChoice:e.toolChoice,tools:e.tools,tracing:e.tracing,providerData:e.providerData,prompt:e.prompt,outputModalities:e.outputModalities,audio:t||r?{input:t,output:r}:void 0}}return{model:e.model,instructions:e.instructions,toolChoice:e.toolChoice,tools:e.tools,tracing:e.tracing,providerData:e.providerData,prompt:e.prompt,outputModalities:e.modalities,audio:{input:{format:yt(e.inputAudioFormat),noiseReduction:e.inputAudioNoiseReduction??null,transcription:e.inputAudioTranscription,turnDetection:e.turnDetection},output:{format:yt(e.outputAudioFormat),voice:e.voice,speed:e.speed}}}}function yt(e){if(!e)return;if(typeof e=="object")return e;const t=String(e);return t==="pcm16"?{type:"audio/pcm",rate:24e3}:t==="g711_ulaw"?{type:"audio/pcmu"}:t==="g711_alaw"?{type:"audio/pcma"}:{type:"audio/pcm",rate:24e3}}h({itemId:p()});const ho=H("role",[h({itemId:p(),previousItemId:p().nullable().optional(),type:g("message"),role:g("system"),content:C(h({type:g("input_text"),text:p()}))}),h({itemId:p(),previousItemId:p().nullable().optional(),type:g("message"),role:g("user"),status:G(["in_progress","completed"]),content:C(h({type:g("input_text"),text:p()}).or(h({type:g("input_audio"),audio:p().nullable().optional(),transcript:p().nullable()})))}),h({itemId:p(),previousItemId:p().nullable().optional(),type:g("message"),role:g("assistant"),status:G(["in_progress","completed","incomplete"]),content:C(h({type:g("output_text"),text:p()}).or(h({type:g("output_audio"),audio:p().nullable().optional(),transcript:p().nullable().optional()})))})]),go=h({itemId:p(),previousItemId:p().nullable().optional(),type:g("function_call"),status:G(["in_progress","completed","incomplete"]),arguments:p(),name:p(),output:p().nullable()}),_o=h({itemId:p(),previousItemId:p().nullable().optional(),type:G(["mcp_call","mcp_tool_call"]),status:G(["in_progress","completed","incomplete"]),arguments:p(),name:p(),output:p().nullable()}),ph=h({itemId:p(),type:g("mcp_approval_request"),serverLabel:p(),name:p(),arguments:j(p(),z()),approved:De().optional().nullable()}),te=Ds("openai-agents:realtime"),bi=h({id:p().optional().nullable(),conversation_id:p().optional().nullable(),max_output_tokens:S().or(g("inf")).optional().nullable(),metadata:j(p(),z()).optional().nullable(),output_modalities:C(p()).optional().nullable(),object:g("realtime.response").optional().nullable(),output:C(z()).optional().nullable(),audio:h({output:h({format:z().optional().nullable(),voice:p().optional().nullable()}).optional().nullable()}).optional().nullable(),status:G(["completed","incomplete","failed","cancelled","in_progress"]).optional().nullable(),status_details:j(p(),z()).optional().nullable(),usage:h({input_tokens:S().optional(),input_token_details:j(p(),z()).optional().nullable(),output_tokens:S().optional(),output_token_details:j(p(),z()).optional().nullable()}).optional().nullable()}),dh=h({id:p().optional(),audio:p().nullable().optional(),text:p().nullable().optional(),transcript:p().nullable().optional(),type:de([g("input_text"),g("input_audio"),g("item_reference"),g("output_text"),g("output_audio")])}),Ke=h({id:p().optional(),arguments:p().optional(),call_id:p().optional(),content:C(dh).optional(),name:p().optional(),output:p().nullable().optional(),role:G(["user","assistant","system"]).optional(),status:G(["completed","incomplete","in_progress"]).optional(),type:G(["message","function_call","function_call_output","mcp_list_tools","mcp_tool_call","mcp_call","mcp_approval_request","mcp_approval_response"]).optional(),approval_request_id:p().nullable().optional(),approve:De().nullable().optional(),reason:p().nullable().optional(),server_label:p().optional(),error:z().nullable().optional(),tools:C(h({name:p(),description:p(),input_schema:j(z()).optional()}).passthrough()).optional()}).passthrough(),fh=h({type:g("conversation.created"),event_id:p(),conversation:h({id:p().optional(),object:g("realtime.conversation").optional()})}),mh=h({type:g("conversation.item.added"),event_id:p(),item:Ke,previous_item_id:p().nullable().optional()}),hh=h({type:g("conversation.item.done"),event_id:p(),item:Ke,previous_item_id:p().nullable().optional()}),gh=h({type:g("conversation.item.deleted"),event_id:p(),item_id:p()}),_h=h({type:g("conversation.item.input_audio_transcription.completed"),event_id:p(),item_id:p(),content_index:S(),transcript:p(),logprobs:C(z()).nullable().optional(),usage:h({type:g("tokens"),total_tokens:S(),input_tokens:S(),input_token_details:h({text_tokens:S(),audio_tokens:S()}),output_tokens:S()}).optional()}),yh=h({type:g("conversation.item.input_audio_transcription.delta"),event_id:p(),item_id:p(),content_index:S().optional(),delta:p().optional(),logprobs:C(z()).nullable().optional()}),vh=h({type:g("conversation.item.input_audio_transcription.failed"),event_id:p(),item_id:p(),content_index:S(),error:h({code:p().optional(),message:p().optional(),param:p().optional(),type:p().optional()})}),wh=h({type:g("conversation.item.retrieved"),event_id:p(),item:Ke}),bh=h({type:g("conversation.item.truncated"),event_id:p(),item_id:p(),audio_end_ms:S(),content_index:S()}),Ih=h({type:g("conversation.item.create"),item:Ke,event_id:p().optional(),previous_item_id:p().nullable().optional()}),Sh=h({type:g("conversation.item.delete"),item_id:p(),event_id:p().optional()}),Th=h({type:g("conversation.item.retrieve"),item_id:p(),event_id:p().optional()}),Ah=h({type:g("conversation.item.truncate"),item_id:p(),audio_end_ms:S(),content_index:S(),event_id:p().optional()}),kh=h({type:g("error"),event_id:p().optional(),error:z().optional()}),xh=h({type:g("input_audio_buffer.cleared"),event_id:p()}),Eh=h({type:g("input_audio_buffer.append"),audio:p(),event_id:p().optional()}),Oh=h({type:g("input_audio_buffer.clear"),event_id:p().optional()}),Ch=h({type:g("input_audio_buffer.commit"),event_id:p().optional()}),Ph=h({type:g("input_audio_buffer.committed"),event_id:p(),item_id:p(),previous_item_id:p().nullable().optional()}),Nh=h({type:g("input_audio_buffer.speech_started"),event_id:p(),item_id:p(),audio_start_ms:S()}),zh=h({type:g("input_audio_buffer.speech_stopped"),event_id:p(),item_id:p(),audio_end_ms:S()}),Dh=h({type:g("output_audio_buffer.started"),event_id:p()}).passthrough(),$h=h({type:g("output_audio_buffer.stopped"),event_id:p()}).passthrough(),Rh=h({type:g("output_audio_buffer.cleared"),event_id:p()}),Zh=h({type:g("rate_limits.updated"),event_id:p(),rate_limits:C(h({limit:S().optional(),name:G(["requests","tokens"]).optional(),remaining:S().optional(),reset_seconds:S().optional()}))}),Mh=h({type:g("response.output_audio.delta"),event_id:p(),item_id:p(),content_index:S(),delta:p(),output_index:S(),response_id:p()}),jh=h({type:g("response.output_audio.done"),event_id:p(),item_id:p(),content_index:S(),output_index:S(),response_id:p()}),Fh=h({type:g("response.output_audio_transcript.delta"),event_id:p(),item_id:p(),content_index:S(),delta:p(),output_index:S(),response_id:p()}),Lh=h({type:g("response.output_audio_transcript.done"),event_id:p(),item_id:p(),content_index:S(),transcript:p(),output_index:S(),response_id:p()}),Uh=h({type:g("response.content_part.added"),event_id:p(),item_id:p(),content_index:S(),output_index:S(),response_id:p(),part:h({audio:p().optional(),text:p().optional(),transcript:p().optional(),type:G(["text","audio"]).optional()})}),Jh=h({type:g("response.content_part.done"),event_id:p(),item_id:p(),content_index:S(),output_index:S(),response_id:p(),part:h({audio:p().optional(),text:p().optional(),transcript:p().optional(),type:G(["text","audio"]).optional()})}),qh=h({type:g("response.created"),event_id:p(),response:bi}),Ii=h({type:g("response.done"),event_id:p(),response:bi}),Bh=h({type:g("response.function_call_arguments.delta"),event_id:p(),item_id:p(),call_id:p(),delta:p(),output_index:S(),response_id:p()}),Gh=h({type:g("response.function_call_arguments.done"),event_id:p(),item_id:p(),call_id:p(),arguments:p(),output_index:S(),response_id:p()}),Wh=h({type:g("response.output_item.added"),event_id:p(),item:Ke,output_index:S(),response_id:p()}),Vh=h({type:g("response.output_item.done"),event_id:p(),item:Ke,output_index:S(),response_id:p()}),Hh=h({type:g("response.output_text.delta"),event_id:p(),item_id:p(),content_index:S(),delta:p(),output_index:S(),response_id:p()}),Kh=h({type:g("response.output_text.done"),event_id:p(),item_id:p(),content_index:S(),text:p(),output_index:S(),response_id:p()}),Yh=h({type:g("session.created"),event_id:p(),session:z()}),Xh=h({type:g("session.updated"),event_id:p(),session:z()}),Qh=h({type:g("response.cancel"),event_id:p().optional(),response_id:p().optional()}),eg=h({type:g("response.create"),event_id:p().optional(),response:z().optional()}),tg=h({type:g("session.update"),event_id:p().optional(),session:z()}),ng=h({type:g("mcp_list_tools.in_progress"),event_id:p().optional(),item_id:p().optional()}),rg=h({type:g("mcp_list_tools.completed"),event_id:p().optional(),item_id:p().optional()}),og=h({type:g("response.mcp_call_arguments.delta"),event_id:p(),response_id:p(),item_id:p(),output_index:S(),delta:p(),obfuscation:p()}),sg=h({type:g("response.mcp_call_arguments.done"),event_id:p(),response_id:p(),item_id:p(),output_index:S(),arguments:p()}),ig=h({type:g("response.mcp_call.in_progress"),event_id:p(),output_index:S(),item_id:p()}),ag=h({type:g("response.mcp_call.completed"),event_id:p(),output_index:S(),item_id:p()}),ug=h({type:g("mcp_list_tools.failed"),event_id:p().optional(),item_id:p().optional()}),cg=h({type:p(),event_id:p().optional().nullable()}).passthrough(),lg=H("type",[fh,mh,hh,gh,_h,yh,vh,wh,bh,kh,xh,Ph,Nh,zh,Dh,$h,Rh,Zh,Mh,jh,Fh,Lh,Uh,Jh,qh,Ii,Bh,Gh,Wh,Vh,Hh,Kh,Yh,Xh,ng,rg,ug,og,sg,ig,ag]);H("type",[Ih,Sh,Th,Ah,Eh,Oh,Ch,Qh,eg,tg]);function qn(e){const t=JSON.parse(e.data.toString()),n=lg.safeParse(t);if(!n.success){const r=cg.safeParse(t);return r.success?{data:r.data,isGeneric:!0}:{data:null,isGeneric:!0}}return{data:n.data,isGeneric:!1}}const pg="gpt-realtime",ce={outputModalities:["audio"],audio:{input:{format:{type:"audio/pcm",rate:24e3},transcription:{model:"gpt-4o-mini-transcribe"},turnDetection:{type:"semantic_vad"},noiseReduction:null},output:{format:{type:"audio/pcm",rate:24e3},speed:1}}};class Gt extends Nn{#e;#t;#o=null;#n=null;eventEmitter=new jt;constructor(t={}){super(),this.#e=t.model??pg,this.#t=t.apiKey}get currentModel(){return this.#e}set currentModel(t){this.#e=t}_afterAudioDoneEvent(){}get _rawSessionConfig(){return this.#n??null}async _getApiKey(t){const n=t.apiKey??this.#t;return typeof n=="function"?await n():n}_onMessage(t){const{data:n,isGeneric:r}=qn(t);if(n!==null&&(this.emit("*",n),!r)){if(n.type==="error"?this.emit("error",{type:"error",error:n}):this.emit(n.type,n),n.type==="response.created"){this.emit("turn_started",{type:"response_started",providerData:{...n}});return}if(n.type==="session.updated"&&(this.#n=n.session),n.type==="response.done"){const o=Ii.safeParse(n);if(!o.success){te.error("Error parsing response done event",o.error);return}const s=o.data.response.usage?.input_tokens??0,i=o.data.response.usage?.output_tokens??0,a=s+i,c=new lt({inputTokens:s,inputTokensDetails:o.data.response.usage?.input_token_details??{},outputTokens:i,outputTokensDetails:o.data.response.usage?.output_token_details??{},totalTokens:a});this.emit("usage_update",c),this.emit("turn_done",{type:"response_done",response:{id:o.data.response.id??"",output:o.data.response.output??[],usage:{inputTokens:s,inputTokensDetails:o.data.response.usage?.input_token_details??{},outputTokens:i,outputTokensDetails:o.data.response.usage?.output_token_details??{},totalTokens:a}}});return}if(n.type==="response.output_audio.done"){this.emit("audio_done"),this._afterAudioDoneEvent();return}if(n.type==="conversation.item.deleted"){this.emit("item_deleted",{itemId:n.item_id});return}if(n.type==="conversation.item.input_audio_transcription.completed"||n.type==="conversation.item.truncated"){this.sendEvent({type:"conversation.item.retrieve",item_id:n.item_id});return}if(n.type==="conversation.item.input_audio_transcription.delta"||n.type==="response.output_text.delta"||n.type==="response.output_audio_transcript.delta"||n.type==="response.function_call_arguments.delta"){n.type==="response.output_audio_transcript.delta"&&this.emit("audio_transcript_delta",{type:"transcript_delta",delta:n.delta,itemId:n.item_id,responseId:n.response_id});return}if(n.type==="conversation.item.added"||n.type==="conversation.item.done"||n.type==="conversation.item.retrieved"){if(n.item.type==="mcp_list_tools"&&n.type==="conversation.item.done"){const o=n.item.server_label??"",s=n.item.tools??[];try{this.emit("mcp_tools_listed",{serverLabel:o,tools:s})}catch(i){te.error("Error emitting mcp_tools_listed",i,n.item)}return}if(n.item.type==="message"){const o=n.type==="conversation.item.added"||n.type==="conversation.item.done"?n.previous_item_id:null,s=ho.parse({itemId:n.item.id,previousItemId:o,type:n.item.type,role:n.item.role,content:n.item.content,status:n.item.status});this.emit("item_update",s);return}if(n.item.type==="mcp_approval_request"&&n.type==="conversation.item.done"){const o=n.item,s=ph.parse({itemId:o.id,type:o.type,serverLabel:o.server_label,name:o.name,arguments:JSON.parse(o.arguments||"{}"),approved:o.approved});this.emit("item_update",s),this.emit("mcp_approval_request",s);return}if(n.item.type==="mcp_tool_call"||n.item.type==="mcp_call"){const o=n.type==="conversation.item.done"?"completed":"in_progress",s=_o.parse({itemId:n.item.id,type:n.item.type,status:o,arguments:n.item.arguments,name:n.item.name,output:n.item.output});this.emit("item_update",s),n.type==="conversation.item.done"&&this.emit("mcp_tool_call_completed",s);return}}if(n.type==="response.mcp_call.in_progress"){const o=n;this.sendEvent({type:"conversation.item.retrieve",item_id:o.item_id});return}if(n.type==="mcp_list_tools.in_progress"){const o=n;o.item_id&&this.sendEvent({type:"conversation.item.retrieve",item_id:o.item_id});return}if(n.type==="response.output_item.done"||n.type==="response.output_item.added"){const o=n.item;if(o.type==="function_call"&&o.status==="completed"){const s=go.parse({itemId:o.id,type:o.type,status:"in_progress",arguments:o.arguments,name:o.name,output:null});this.emit("item_update",s),this.emit("function_call",{id:o.id,type:"function_call",callId:o.call_id??"",arguments:o.arguments??"",name:o.name??""});return}if(o.type==="mcp_tool_call"||o.type==="mcp_call"){const s=_o.parse({itemId:o.id,type:o.type,status:n.type==="response.output_item.done"?"completed":"in_progress",arguments:o.arguments,name:o.name,output:o.output});this.emit("item_update",s);return}if(o.type==="message"){const s=ho.parse({itemId:n.item.id,type:n.item.type,role:n.item.role,content:n.item.content,status:n.type==="response.output_item.done"?o.status??"completed":o.status??"in_progress"});this.emit("item_update",s);return}}}}_onError(t){this.emit("error",{type:"error",error:t})}_onOpen(){this.emit("connected")}_onClose(){this.emit("disconnected")}sendMessage(t,n,{triggerResponse:r=!0}={}){const o=typeof t=="string"?[{type:"input_text",text:t}]:t.content.map(s=>s.type==="input_image"?{type:"input_image",image_url:s.image,...s.providerData??{}}:s);this.sendEvent({type:"conversation.item.create",item:{type:"message",role:"user",content:o},...n}),r&&this.sendEvent({type:"response.create"})}addImage(t,{triggerResponse:n=!0}={}){this.sendMessage({type:"message",role:"user",content:[{type:"input_image",image:t}]},{},{triggerResponse:n})}_getMergedSessionConfig(t){const n=lh(t),r={type:"realtime",instructions:n.instructions,model:n.model??this.#e,output_modalities:n.outputModalities??ce.outputModalities,audio:{input:{format:n.audio?.input?.format??ce.audio?.input?.format,noise_reduction:n.audio?.input?.noiseReduction??ce.audio?.input?.noiseReduction,transcription:n.audio?.input?.transcription??ce.audio?.input?.transcription,turn_detection:Gt.buildTurnDetectionConfig(n.audio?.input?.turnDetection)??ce.audio?.input?.turnDetection},output:{format:n.audio?.output?.format??ce.audio?.output?.format,voice:n.audio?.output?.voice??ce.audio?.output?.voice,speed:n.audio?.output?.speed??ce.audio?.output?.speed}},tool_choice:n.toolChoice??ce.toolChoice,...n.providerData??{}};return n.prompt&&(r.prompt={id:n.prompt.promptId,version:n.prompt.version,variables:n.prompt.variables}),n.tools&&n.tools.length>0&&(r.tools=n.tools.map(o=>({...o,strict:void 0}))),r}buildSessionPayload(t){return this._getMergedSessionConfig(t)}static buildTurnDetectionConfig(t){if(typeof t>"u")return;const{type:n,createResponse:r,create_response:o,eagerness:s,interruptResponse:i,interrupt_response:a,prefixPaddingMs:c,prefix_padding_ms:u,silenceDurationMs:l,silence_duration_ms:d,threshold:f,idleTimeoutMs:m,idle_timeout_ms:w,...b}=t,v={type:n,create_response:r||o,eagerness:s,interrupt_response:i||a,prefix_padding_ms:c||u,silence_duration_ms:l||d,idle_timeout_ms:m||w,threshold:f,...b};return Object.keys(v).forEach(A=>{v[A]===void 0&&delete v[A]}),Object.keys(v).length>0?v:void 0}set _tracingConfig(t){this.#o=t}_updateTracingConfig(t){if(typeof this.#o>"u"&&(this.#o=null),t==="auto"){this.sendEvent({type:"session.update",session:{type:"realtime",tracing:"auto"}});return}if(this.#o!==null&&typeof this.#o!="string"&&typeof t!="string"){te.warn("Tracing config is already set, skipping setting it again. This likely happens when you already set a tracing config on session creation.");return}if(t===null){te.debug("Disabling tracing for this session. It cannot be turned on for this session from this point on."),this.sendEvent({type:"session.update",session:{type:"realtime",tracing:null}});return}if(this.#o===null||typeof this.#o=="string"){this.sendEvent({type:"session.update",session:{type:"realtime",tracing:t}});return}if(t?.group_id!==this.#o?.group_id||t?.metadata!==this.#o?.metadata||t?.workflow_name!==this.#o?.workflow_name){te.warn("Mismatch in tracing config. Ignoring the new tracing config. This likely happens when you already set a tracing config on session creation. Current tracing config: %s, new tracing config: %s",JSON.stringify(this.#o),JSON.stringify(t));return}this.sendEvent({type:"session.update",session:{type:"realtime",tracing:t}})}updateSessionConfig(t){const n=this.buildSessionPayload(t);this.sendEvent({type:"session.update",session:n})}sendFunctionCallOutput(t,n,r=!0){this.sendEvent({type:"conversation.item.create",item:{type:"function_call_output",output:n,call_id:t.callId}});try{const o=go.parse({itemId:t.id,previousItemId:t.previousItemId,type:"function_call",status:"completed",arguments:t.arguments,name:t.name,output:n});this.emit("item_update",o)}catch(o){te.error("Error parsing tool call item",o,t)}r&&this.sendEvent({type:"response.create"})}sendAudio(t,{commit:n=!1}={}){this.sendEvent({type:"input_audio_buffer.append",audio:Xm(t)}),n&&this.sendEvent({type:"input_audio_buffer.commit"})}resetHistory(t,n){const{removals:r,additions:o,updates:s}=eh(t,n),i=new Set(r.map(c=>c.itemId));for(const c of s)i.add(c.itemId);if(i.size>0)for(const c of i)this.sendEvent({type:"conversation.item.delete",item_id:c});const a=[...o,...s];for(const c of a)if(c.type==="message"){const u={type:"message",role:c.role,content:c.content,id:c.itemId};c.role!=="system"&&c.status&&(u.status=c.status),this.sendEvent({type:"conversation.item.create",item:u})}else c.type==="function_call"&&te.warn("Function calls cannot be manually added or updated at the moment. Ignoring.")}sendMcpResponse(t,n){this.sendEvent({type:"conversation.item.create",previous_item_id:t.itemId,item:{type:"mcp_approval_response",approval_request_id:t.itemId,approve:n}})}}class dg extends Gt{options;#e;#t={status:"disconnected",peerConnection:void 0,dataChannel:void 0,callId:void 0};#o;#n=!1;#a=!1;constructor(t={}){if(typeof RTCPeerConnection>"u")throw new Error("WebRTC is not supported in this environment");super(t),this.options=t,this.#e=t.baseUrl??"https://api.openai.com/v1/realtime/calls",this.#o=t.useInsecureApiKey??!1}get callId(){return this.#t.callId}get status(){return this.#t.status}get connectionState(){return this.#t}get muted(){return this.#a}async connect(t){if(this.#t.status==="connected")return;this.#t.status==="connecting"&&te.warn("Realtime connection already in progress. Please await original promise");const n=t.model??this.currentModel;this.currentModel=n;const r=t.url??this.#e,o=await this._getApiKey(t),s=typeof o=="string"&&o.startsWith("ek_");if(!this.#o&&!s)throw new M("Using the WebRTC connection in a browser environment requires an ephemeral client key. If you need to use a regular API key, use the WebSocket transport or set the `useInsecureApiKey` option to true.");return new Promise(async(i,a)=>{try{const c={...t.initialSessionConfig||{},model:this.currentModel},u=new URL(r);let l=new RTCPeerConnection;const d=l.createDataChannel("oai-events");let f;const m=x=>{x.onconnectionstatechange=()=>{switch(x.connectionState){case"disconnected":case"failed":case"closed":this.close();break}}};m(l),this.#t={status:"connecting",peerConnection:l,dataChannel:d,callId:f},this.emit("connection_change",this.#t.status),d.addEventListener("open",()=>{this.#t={status:"connected",peerConnection:l,dataChannel:d,callId:f},this.updateSessionConfig(c),this.emit("connection_change",this.#t.status),this._onOpen(),i()}),d.addEventListener("error",x=>{this.close(),this._onError(x),a(x)}),d.addEventListener("message",x=>{this._onMessage(x);const{data:T,isGeneric:I}=qn(x);if(!(!T||I)&&(T.type==="response.created"?this.#n=!0:T.type==="response.done"&&(this.#n=!1),T.type==="session.created")){this._tracingConfig=T.session.tracing;const O=typeof c.tracing>"u"?"auto":c.tracing;this._updateTracingConfig(O)}});const w=this.options.audioElement??document.createElement("audio");w.autoplay=!0,l.ontrack=x=>{w.srcObject=x.streams[0]};const b=this.options.mediaStream??await navigator.mediaDevices.getUserMedia({audio:!0});if(l.addTrack(b.getAudioTracks()[0]),this.options.changePeerConnection){const x=l;l=await this.options.changePeerConnection(l),x!==l&&(x.onconnectionstatechange=null),m(l),this.#t={...this.#t,peerConnection:l}}const v=await l.createOffer();if(await l.setLocalDescription(v),!v.sdp)throw new Error("Failed to create offer");const A=await fetch(u,{method:"POST",body:v.sdp,headers:{"Content-Type":"application/sdp",Authorization:`Bearer ${o}`,"X-OpenAI-Agents-SDK":wi["X-OpenAI-Agents-SDK"]}});f=A.headers?.get("Location")?.split("/").pop(),this.#t={...this.#t,callId:f};const y={type:"answer",sdp:await A.text()};await l.setRemoteDescription(y)}catch(c){this.close(),this._onError(c),a(c)}})}sendEvent(t){if(!this.#t.dataChannel||this.#t.dataChannel.readyState!=="open")throw new Error("WebRTC data channel is not connected. Make sure you call `connect()` before sending events.");this.#t.dataChannel.send(JSON.stringify(t))}mute(t){this.#a=t,this.#t.peerConnection&&this.#t.peerConnection.getSenders().forEach(r=>{r.track&&(r.track.enabled=!t)})}_afterAudioDoneEvent(){this.#n=!1}close(){if(this.#t.dataChannel&&this.#t.dataChannel.close(),this.#t.peerConnection){const t=this.#t.peerConnection;t.onconnectionstatechange=null,t.getSenders().forEach(n=>{n.track?.stop()}),t.close()}this.#t.status!=="disconnected"&&(this.#t={status:"disconnected",peerConnection:void 0,dataChannel:void 0,callId:void 0},this.emit("connection_change",this.#t.status),this._onClose())}interrupt(){this.#n&&(this.sendEvent({type:"response.cancel"}),this.#n=!1),this.sendEvent({type:"output_audio_buffer.clear"})}}const fg=globalThis.WebSocket;class mg extends Gt{#e;#t;#o;#n={status:"disconnected",websocket:void 0};#a;#s;#i;_firstAudioTimestamp;_audioLengthMs=0;#r=!1;#u;#l;#c(){this.#s=void 0,this._firstAudioTimestamp=void 0,this._audioLengthMs=0,this.#i=void 0}constructor(t={}){super(t),this.#t=t.url,this.#o=t.url,this.#a=t.useInsecureApiKey??!1,this.#u=t.createWebSocket,this.#l=t.skipOpenEventListeners??!1}getCommonRequestHeaders(){return wi}get status(){return this.#n.status}get connectionState(){return this.#n}get muted(){return null}get currentItemId(){return this.#s}_onAudio(t){this.emit("audio",t)}_afterAudioDoneEvent(){this.#c()}async#d(t,n,r){if(this.#n.websocket){t();return}if(!this.#e)throw new M("API key is not set. Please call `connect()` with an API key first.");if(!this.#e.startsWith("ek_")&&!this.#a)throw new M("Using the WebSocket connection in a browser environment requires an ephemeral client key. If you have to use a regular API key, set the `useInsecureApiKey` option to true.");let o=null;if(this.#u)o=await this.#u({url:this.#t,apiKey:this.#e});else{const i=["realtime","openai-insecure-api-key."+this.#e,rh];o=new fg(this.#t,i)}this.#n={status:"connecting",websocket:o},this.emit("connection_change",this.#n.status);const s=()=>{this.#n={status:"connected",websocket:o},this.emit("connection_change",this.#n.status),this._onOpen(),t()};this.#l===!0?s():o.addEventListener("open",s),o.addEventListener("error",i=>{this._onError(i),this.#n={status:"disconnected",websocket:void 0},this.emit("connection_change",this.#n.status),n(i)}),o.addEventListener("message",i=>{this._onMessage(i);const{data:a,isGeneric:c}=qn(i);if(!(!a||c)){if(a.type==="response.output_audio.delta"){this.#i=a.content_index,this.#s=a.item_id,this._firstAudioTimestamp===void 0&&(this._firstAudioTimestamp=Date.now(),this._audioLengthMs=0);const u=Ym(a.delta),l=this._rawSessionConfig?.audio?.output?.format;if(l&&typeof l=="object"){const f=l.type;if(f==="audio/pcmu"||f==="audio/pcma")this._audioLengthMs+=u.byteLength/8;else if(f==="audio/pcm"){const m=l.rate??24e3;this._audioLengthMs+=u.byteLength/2/m*1e3}else this._audioLengthMs+=u.byteLength/24/2}else typeof l=="string"?l.startsWith("g711_")?this._audioLengthMs+=u.byteLength/8:this._audioLengthMs+=u.byteLength/24/2:this._audioLengthMs+=u.byteLength/24/2;const d={type:"audio",data:u,responseId:a.response_id};this._onAudio(d)}else if(a.type==="input_audio_buffer.speech_started"){const u=this._rawSessionConfig?.audio?.input?.turn_detection?.interrupt_response??!1;this.interrupt(!u)}else if(a.type==="response.created")this.#r=!0;else if(a.type==="response.done")this.#r=!1;else if(a.type==="session.created"){this._tracingConfig=a.session.tracing;const u=typeof r.tracing>"u"?"auto":r.tracing;this._updateTracingConfig(u)}}}),o.addEventListener("close",()=>{this.#n={status:"disconnected",websocket:void 0},this.emit("connection_change",this.#n.status),this._onClose()})}async connect(t){const n=t.model??this.currentModel;this.currentModel=n,this.#e=await this._getApiKey(t);const r=t.callId;let o;t.url?(o=t.url,this.#o=t.url):r?o=`wss://api.openai.com/v1/realtime?call_id=${r}`:this.#o?o=this.#o:o=`wss://api.openai.com/v1/realtime?model=${this.currentModel}`,this.#t=o;const s={...t.initialSessionConfig||{},model:this.currentModel};await new Promise((i,a)=>{this.#d(i,a,s).catch(a)}),await this.updateSessionConfig(s)}sendEvent(t){if(!this.#n.websocket)throw new Error("WebSocket is not connected. Make sure you call `connect()` before sending events.");this.#n.websocket.send(JSON.stringify(t))}close(){this.#n.websocket?.close(),this.#s=void 0,this._firstAudioTimestamp=void 0,this._audioLengthMs=0,this.#i=void 0}mute(t){throw new Error("Mute is not supported for the WebSocket transport. You have to mute the audio input yourself.")}sendAudio(t,n={}){this.#n.status==="connected"&&super.sendAudio(t,n)}_cancelResponse(){this.#r&&(this.sendEvent({type:"response.cancel"}),this.#r=!1)}_interrupt(t,n=!0){if(t<0)return;n&&this._cancelResponse();const r=this._audioLengthMs??Number.POSITIVE_INFINITY,o=Math.max(0,Math.floor(Math.min(t,r)));this.emit("audio_interrupted"),this.sendEvent({type:"conversation.item.truncate",item_id:this.#s,content_index:this.#i,audio_end_ms:o})}interrupt(t=!0){if(!this.#s||typeof this._firstAudioTimestamp!="number")return;const n=Date.now()-this._firstAudioTimestamp;n>=0&&this._interrupt(n,t),this.#c()}}const hg=Symbol("backgroundResult");function gg(e){return typeof e=="object"&&e!==null&&hg in e}function _g(e){return e.type==="function"||e.type==="hosted_tool"&&e.name==="hosted_mcp"}function yg(e){if(e.type==="function")return e;if(e.type==="hosted_tool"&&e.name==="hosted_mcp"){const t=e.providerData.server_url&&e.providerData.server_url.length>0?e.providerData.server_url:void 0;return{type:"mcp",server_label:e.providerData.server_label,server_url:t,headers:e.providerData.headers,allowed_tools:e.providerData.allowed_tools,require_approval:e.providerData.require_approval}}throw new M(`Invalid tool type: ${e}`)}function vg(){return JSON.parse(JSON.stringify(ce))}class Bn extends jt{initialAgent;options;#e;#t;#o;#n;#a=[];#s;#i={};#r=[];#u;#l={};#c=!1;#d=new Map;#p=[];#g=vg();#_=!0;constructor(t,n={}){super(),this.initialAgent=t,this.options=n,typeof n.transport>"u"&&th()||n.transport==="webrtc"?this.#e=new dg:n.transport==="websocket"||typeof n.transport>"u"?this.#e=new mg:this.#e=n.transport,this.#t=t,this.#n=new Le({...n.context??{},history:this.#r}),this.#a=(n.outputGuardrails??[]).map(ah),this.#s=ih(n.outputGuardrailSettings??{}),this.#u=n.historyStoreAudio??!1,this.#_=n.automaticallyTriggerResponseForMcpToolCalls??!0}get transport(){return this.#e}get currentAgent(){return this.#t}get usage(){return this.#n.usage}get context(){return this.#n}get muted(){return this.#e.muted}get history(){return this.#r}get availableMcpTools(){return this.#p}async#f(t){this.#t=t;const n=await this.#t.getEnabledHandoffs(this.#n),r=n.map(a=>a.getHandoffAsFunctionTool()),o=(await this.#t.getAllTools(this.#n)).filter(_g).map(yg),s=typeof this.#t.tools<"u"||typeof this.#t.mcpServers<"u",i=n.length>0;this.#o=s||i?[...o,...r]:void 0,this.#v()}async#m(t={}){const n=t??{},r=this.options.config??{},o=await this.#t.getSystemPrompt(this.#n),s=f=>f.audio?.output?.voice,i=this.options.tracingDisabled?null:this.options.workflowName?{workflow_name:this.options.workflowName}:"auto";i!==null&&i!=="auto"?(this.options.groupId&&(i.group_id=this.options.groupId),this.options.traceMetadata&&(i.metadata=this.options.traceMetadata)):(this.options.groupId||this.options.traceMetadata)&&te.warn("In order to set traceMetadata or a groupId you need to specify a workflowName.");const a=s(n)??s(r),c=n.voice??r.voice,u=typeof a<"u"?a:typeof c<"u"?c:this.#t.voice,d={...{...this.#g??{},...r,...n},instructions:o,voice:u,model:this.options.model,tools:this.#o,tracing:i,prompt:typeof this.#t.prompt=="function"?await this.#t.prompt(this.#n,this.#t):this.#t.prompt};return this.#g=d,d}async getInitialSessionConfig(t={}){return await this.#f(this.initialAgent),this.#m({...this.options.config??{},...t??{}})}static async computeInitialSessionConfig(t,n={},r={}){const o=new Bn(t,n);try{return await o.getInitialSessionConfig(r)}finally{o.close()}}async updateAgent(t){return this.#t.emit("agent_handoff",this.#n,t),this.emit("agent_handoff",this.#n,this.#t,t),await this.#f(t),await this.#e.updateSessionConfig(await this.#m()),t}async#w(t,n){const r=await n.onInvokeHandoff(this.#n,t.arguments);this.#t.emit("agent_handoff",this.#n,r),this.emit("agent_handoff",this.#n,this.#t,r),await this.#f(r),await this.#e.updateSessionConfig(await this.#m());const o=Ls(r);return this.#e.sendFunctionCallOutput(t,o,!0),r}async#h(t,n){this.#n.context.history=JSON.parse(JSON.stringify(this.#r));let r=t.arguments;if(n.parameters&&($e(n.parameters)?r=n.parameters.parse(r):r=JSON.parse(r)),await n.needsApproval(this.#n,r,t.callId)){const a=this.context.isToolApproved({toolName:n.name,callId:t.callId});if(a===!1){this.emit("agent_tool_start",this.#n,this.#t,n,{toolCall:t}),this.#t.emit("agent_tool_start",this.#n,n,{toolCall:t});const c="Tool execution was not approved.";this.#e.sendFunctionCallOutput(t,c,!0),this.emit("agent_tool_end",this.#n,this.#t,n,c,{toolCall:t}),this.#t.emit("agent_tool_end",this.#n,n,c,{toolCall:t});return}else if(typeof a>"u"){this.emit("tool_approval_requested",this.#n,this.#t,{type:"function_approval",tool:n,approvalItem:new Y(t,this.#t)});return}}this.emit("agent_tool_start",this.#n,this.#t,n,{toolCall:t}),this.#t.emit("agent_tool_start",this.#n,n,{toolCall:t}),this.#n.context.history=JSON.parse(JSON.stringify(this.#r));const s=await n.invoke(this.#n,t.arguments,{toolCall:t});let i;gg(s)?(i=Ae(s.content),this.#e.sendFunctionCallOutput(t,i,!1)):(i=Ae(s),this.#e.sendFunctionCallOutput(t,i,!0)),this.emit("agent_tool_end",this.#n,this.#t,n,i,{toolCall:t}),this.#t.emit("agent_tool_end",this.#n,n,i,{toolCall:t})}async#b(t){const n=await this.#t.getEnabledHandoffs(this.#n),r=new Map(n.map(a=>[a.toolName,a])),o=await this.#t.getAllTools(this.#n),s=new Map(o.map(a=>[a.name,a])),i=r.get(t.name);if(i)await this.#w(t,i);else{const a=s.get(t.name);if(a&&a.type==="function")await this.#h(t,a);else throw new X(`Tool ${t.name} not found`)}}async#y(t,n,r){if(this.#a.length===0)return;const o={agent:this.#t,agentOutput:t,context:this.#n},i=(await Promise.all(this.#a.map(a=>a.run(o)))).find(a=>a.output.tripwireTriggered);if(i){if(this.#l[n])return;this.#l[n]=!0;const a=new dn(`Output guardrail triggered: ${JSON.stringify(i.output.outputInfo)}`,i);this.emit("guardrail_tripped",this.#n,this.#t,a,{itemId:r}),this.interrupt();const c=uh(i);this.sendMessage(c);return}}#I(){this.#e.on("*",r=>{if(this.emit("transport_event",r),r.type==="conversation.item.input_audio_transcription.completed")try{const o=r;this.#r=fo(this.#r,o,this.#u),this.#n.context.history=this.#r,this.emit("history_updated",this.#r)}catch(o){this.emit("error",{type:"error",error:o})}}),this.#e.on("mcp_tools_listed",({serverLabel:r,tools:o})=>{try{this.#d.set(r,o??[]),this.#v()}catch(s){this.emit("error",{type:"error",error:s})}}),this.#e.on("audio",r=>{this.#c||(this.#c=!0,this.emit("audio_start",this.#n,this.#t)),this.emit("audio",r)}),this.#e.on("turn_started",()=>{this.#c=!1,this.emit("agent_start",this.#n,this.#t),this.#t.emit("agent_start",this.#n,this.#t)}),this.#e.on("turn_done",r=>{const o=r.response.output[r.response.output.length-1],s=Qm(o)??"",i=o?.id??"";this.emit("agent_end",this.#n,this.#t,s),this.#t.emit("agent_end",this.#n,s),this.#y(s,r.response.id,i)}),this.#e.on("audio_done",()=>{this.#c&&(this.#c=!1),this.emit("audio_stopped",this.#n,this.#t)});let t=0,n;this.#e.on("audio_transcript_delta",r=>{try{const o=r.delta,s=r.itemId,i=r.responseId;n!==s&&(n=s,t=0);const c=(this.#i[s]??"")+o;if(this.#i[s]=c,this.#s.debounceTextLength<0)return;const u=Math.floor(c.length/this.#s.debounceTextLength);u>t&&(t=u,this.#y(c,i,s))}catch(o){this.emit("error",{type:"error",error:o})}}),this.#e.on("item_update",r=>{try{const o=!this.#r.some(s=>s.itemId===r.itemId);if(this.#r=fo(this.#r,r,this.#u),this.#n.context.history=this.#r,o){const s=this.#r.find(i=>i.itemId===r.itemId);s&&this.emit("history_added",s)}this.emit("history_updated",this.#r)}catch(o){this.emit("error",{type:"error",error:o})}}),this.#e.on("item_deleted",r=>{try{this.#r=this.#r.filter(o=>o.itemId!==r.itemId),this.#n.context.history=this.#r,this.emit("history_updated",this.#r)}catch(o){this.emit("error",{type:"error",error:o})}}),this.#e.on("function_call",async r=>{try{await this.#b(r)}catch(o){te.error("Error handling function call",o),this.emit("error",{type:"error",error:o})}}),this.#e.on("usage_update",r=>{this.#n.usage.add(r)}),this.#e.on("audio_interrupted",()=>{this.#c&&(this.#c=!1),this.emit("audio_interrupted",this.#n,this.#t)}),this.#e.on("error",r=>{this.emit("error",r)}),this.#e.on("mcp_tool_call_completed",r=>{this.emit("mcp_tool_call_completed",this.#n,this.#t,r),this.#_&&this.#e.sendEvent({type:"response.create"})}),this.#e.on("mcp_approval_request",r=>{this.emit("tool_approval_requested",this.#n,this.#t,{type:"mcp_approval_request",approvalItem:oh(this.#t,r)})})}#v(){const t=this.#o?.filter(a=>a.type==="mcp"),n=a=>{const c=a.allowed_tools;if(c){if(Array.isArray(c))return c;if(c&&Array.isArray(c.tool_names))return c.tool_names}},r=new Map;for(const a of t){const c=this.#d.get(a.server_label)??[],u=n(a);for(const l of c)u&&!u.includes(l.name)||r.has(l.name)||r.set(l.name,l)}const o=Array.from(r.values()),s=this.#p;(s.length!==o.length||JSON.stringify(s.map(a=>a.name).sort())!==JSON.stringify(o.map(a=>a.name).sort()))&&(this.#p=o,this.emit("mcp_tools_changed",this.#p))}async connect(t){await this.#f(this.initialAgent),this.#I(),await this.#e.connect({apiKey:t.apiKey??this.options.apiKey,model:this.options.model,url:t.url,callId:t.callId,initialSessionConfig:await this.#m(this.options.config)}),this.#r=[],this.emit("history_updated",this.#r)}updateHistory(t){let n;typeof t=="function"?n=t(this.#r):n=t,this.#e.resetHistory(this.#r,n)}sendMessage(t,n={}){this.#e.sendMessage(t,n)}addImage(t,{triggerResponse:n=!0}={}){this.#e.addImage(t,{triggerResponse:n})}mute(t){this.#e.mute(t)}close(){this.#l={},this.#e.close()}sendAudio(t,n={}){this.#e.sendAudio(t,n)}interrupt(){this.#e.interrupt()}async approve(t,n={alwaysApprove:!1}){this.#n.approveTool(t,n);const r=t.toolName??t.rawItem.name,o=this.#t.tools.find(s=>s.name===r);if(o&&o.type==="function"&&t.rawItem.type==="function_call")await this.#h(t.rawItem,o);else if(t.rawItem.type==="hosted_tool_call"){n.alwaysApprove&&te.warn("Always approving MCP tools is not supported. Use the allowed tools configuration instead.");const s=mo(t);this.#e.sendMcpResponse(s,!0)}else throw new X(`Tool ${r??"unknown"} not found`)}async reject(t,n={alwaysReject:!1}){this.#n.rejectTool(t,n);const r=t.toolName??t.rawItem.name,o=this.#t.tools.find(s=>s.name===r);if(o&&o.type==="function"&&t.rawItem.type==="function_call")await this.#h(t.rawItem,o);else if(t.rawItem.type==="hosted_tool_call"){n.alwaysReject&&te.warn("Always rejecting MCP tools is not supported. Use the allowed tools configuration instead.");const s=mo(t);this.#e.sendMcpResponse(s,!1)}else throw new X(`Tool ${r??"unknown"} not found`)}}async function wg(e,t,n){const r=new sh({name:"Greeter",instructions:"Greet the user with cheer and answer questions."}),o=new Bn(r,{model:"gpt-realtime",config:{inputAudioFormat:"pcm16",outputAudioFormat:"pcm16",inputAudioTranscription:{model:"gpt-4o-mini-transcribe"}}}),s=new AudioContext({sampleRate:24e3});o.on("audio",i=>{const a=new Int16Array(i.data),c=new Float32Array(a.length);for(let d=0;d<a.length;d++)c[d]=a[d]/32768;const u=s.createBuffer(1,c.length,24e3);u.copyToChannel(c,0);const l=s.createBufferSource();l.buffer=u,l.connect(s.destination),l.start()});try{await o.connect({apiKey:n}),e.innerHTML="You are Connected",o.on("history_updated",i=>{const a=i.at(-1);a?.content?.[0]?.transcript&&(t.innerHTML=a.content[0].transcript)}),await s.resume()}catch(i){i instanceof Error?t.innerHTML=i.message:t.innerHTML=String(i)}}document.querySelector("#app").innerHTML=`
    <div class="card">
      <h1>WebRTC OpenAI Realtime API</h1>

      <div class="input-group">
        <input
          id="security-input"
          placeholder='Password'
        />

        <input
          id="ephemeral-key-input"
          placeholder="Paste ephemeral key"
        />

        <!-- Stylish textbox -->
        <textarea
          id="textbox"
          placeholder="Write something here..."
        ></textarea>
      </div>

      <button id="connectedButton" disabled>You are not connected</button>
    </div>
`;const Si=document.querySelector("#security-input"),Ti=document.querySelector("#ephemeral-key-input"),yo=document.querySelector("#connectedButton"),bg=document.querySelector("#textbox");let vo=!1;function Ai(){const e=Si.value.trim().toLowerCase()==="security",t=Ti.value.trim();!vo&&e&&t.length>0&&(wg(yo,bg,t),yo.disabled=!1,vo=!0)}Si.addEventListener("input",Ai);Ti.addEventListener("input",Ai);
